{
  "comments": [
    {
      "key": {
        "uuid": "867b6dfd_0190067a",
        "filename": "third_party/WebKit/Source/core/frame/LocalFrameView.cpp",
        "patchSetId": 27
      },
      "lineNbr": 2134,
      "author": {
        "id": 1001168
      },
      "writtenOn": "2017-06-07T05:18:25Z",
      "side": 1,
      "message": "Is it possible to end up here without a Document? It doesn\u0027t seem like we should be calling into layout code without a document anyway.\n\n(But maybe I\u0027m missing something, since apparently we have to check for a null layout view)",
      "range": {
        "startLine": 2134,
        "startChar": 6,
        "endLine": 2134,
        "endChar": 27
      },
      "revId": "1b159bc3f0fc51f3dca0d8c8f37604f15f943897",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c313f205_d3ab743a",
        "filename": "third_party/WebKit/Source/core/frame/LocalFrameView.cpp",
        "patchSetId": 27
      },
      "lineNbr": 2134,
      "author": {
        "id": 1186968
      },
      "writtenOn": "2017-06-07T06:13:45Z",
      "side": 1,
      "message": "I found unit tests that end up here without a Document.  This code is the best that I can think of to handle that case.  If I make the check to be |frame_-\u003eDocument() \u0026\u0026 !frame_-\u003eDocument()-\u003eIsDetached()| or |frame_-\u003eDocument() \u0026\u0026 frame_-\u003eDocument()-\u003eIsActive()| then I suspect that checking for Layout is redundant.",
      "parentUuid": "867b6dfd_0190067a",
      "range": {
        "startLine": 2134,
        "startChar": 6,
        "endLine": 2134,
        "endChar": 27
      },
      "revId": "1b159bc3f0fc51f3dca0d8c8f37604f15f943897",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "40f2fdaf_c23103c1",
        "filename": "third_party/WebKit/Source/core/frame/LocalFrameView.cpp",
        "patchSetId": 27
      },
      "lineNbr": 2134,
      "author": {
        "id": 1186968
      },
      "writtenOn": "2017-06-07T06:31:13Z",
      "side": 1,
      "message": "Checking for Layout is still required.  I think the best check is:\n\nif (!GetLayoutViewItem().IsNull() \u0026\u0026 frame_-\u003eGetDocument()-\u003eIsActive())\n\nif LayoutViewItem is non-null, then Document must also be non-null, so no need to explicitly check if document exists.",
      "parentUuid": "c313f205_d3ab743a",
      "range": {
        "startLine": 2134,
        "startChar": 6,
        "endLine": 2134,
        "endChar": 27
      },
      "revId": "1b159bc3f0fc51f3dca0d8c8f37604f15f943897",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "cf542d2e_cd9dcdc3",
        "filename": "third_party/WebKit/Source/core/frame/LocalFrameView.cpp",
        "patchSetId": 27
      },
      "lineNbr": 2134,
      "author": {
        "id": 1001168
      },
      "writtenOn": "2017-06-07T06:38:02Z",
      "side": 1,
      "message": "Unfortunately, I think there are cases where we can get here with an active document but no layout item: there\u0027s some frame blocking code that tells Blink to not even create a layout item for an \u003ciframe\u003e: https://cs.chromium.org/chromium/src/third_party/WebKit/Source/core/html/HTMLIFrameElement.cpp?rcl\u003d613581c6d2fac5deb21685714964ee1f2f71f36f\u0026l\u003d202\n\nThere\u0027s possibly other situations that could trigger this as well.\n\nOut of curiosity, what unit tests were failing?",
      "parentUuid": "c313f205_d3ab743a",
      "range": {
        "startLine": 2134,
        "startChar": 6,
        "endLine": 2134,
        "endChar": 27
      },
      "revId": "1b159bc3f0fc51f3dca0d8c8f37604f15f943897",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1150a32c_39079b2e",
        "filename": "third_party/WebKit/Source/core/frame/LocalFrameView.cpp",
        "patchSetId": 27
      },
      "lineNbr": 2134,
      "author": {
        "id": 1001168
      },
      "writtenOn": "2017-06-07T06:38:02Z",
      "side": 1,
      "message": "(Yep, see my other comment)\n\nSorry for all the questions, but one last question...\nIs it possible to just call Dispose() before we advance the DocumentLifecycle to stopping, or is that fundamentally incorrect as well?",
      "parentUuid": "40f2fdaf_c23103c1",
      "range": {
        "startLine": 2134,
        "startChar": 6,
        "endLine": 2134,
        "endChar": 27
      },
      "revId": "1b159bc3f0fc51f3dca0d8c8f37604f15f943897",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "11f03d45_250fba01",
        "filename": "third_party/WebKit/Source/core/frame/LocalFrameView.cpp",
        "patchSetId": 27
      },
      "lineNbr": 2134,
      "author": {
        "id": 1186968
      },
      "writtenOn": "2017-06-07T06:53:40Z",
      "side": 1,
      "message": "\u003e Is it possible to just call Dispose() before we advance the DocumentLifecycle to stopping\n\nYes, I did try that.  As long as we move both of:\n  View()-\u003eDispose()\nand\n  Owner()-\u003eSetWidget(nullptr)\n\nbefore setting lifecycle to stopping, the code seems to work OK.\n\nBut I think that logically, it is correct that the very first thing that Shutdown should do is to set lifecycle to stopping.\n\nI think that adding the check for either Document()-\u003eIsActive() or !Document()-\u003eIsDetached() into SetNeedsCompositingUpdate is a better solution.  There is no need to be calling the compositor when the document is shutting down, or for whatever other reason is not active.\n\n\n\u003e Which tests fail?\nHundreds of tests fail in that they do not have a document at this point of the code.  Some typical traces:\n\n66027:66027:0606/234704.403061:4261740562304:FATAL:LocalFrameView.cpp(2133)] Check failed: frame_-\u003eGetDocument(). \n#0 0x7f89ca011b67 base::debug::StackTrace::StackTrace()\n#1 0x7f89ca03764d logging::LogMessage::~LogMessage()\n#2 0x7f89c7a6bf1f blink::LocalFrameView::SetNeedsCompositingUpdate()\n#3 0x7f89c7a5e911 blink::LocalFrameView::Show()\n#4 0x7f89c7a5eac9 blink::LocalFrameView::Create()\n#5 0x7f89c7a536ea blink::LocalFrame::CreateView()\n\n\n[65523:65523:0606/234703.715687:4261739874950:FATAL:LocalFrameView.cpp(2133)] Check failed: frame_-\u003eGetDocument(). \n#0 0x7f83eb483b67 base::debug::StackTrace::StackTrace()\n#1 0x7f83eb4a964d logging::LogMessage::~LogMessage()\n#2 0x7f83e8eddf1f blink::LocalFrameView::SetNeedsCompositingUpdate()\n#3 0x7f83e8ed0911 blink::LocalFrameView::Show()\n#4 0x7f83e8ed0ac9 blink::LocalFrameView::Create()\n#5 0x0000014a11db blink::DummyPageHolder::DummyPageHolder()\n#6 0x0000014a0eda blink::DummyPageHolder::Create()",
      "parentUuid": "cf542d2e_cd9dcdc3",
      "range": {
        "startLine": 2134,
        "startChar": 6,
        "endLine": 2134,
        "endChar": 27
      },
      "revId": "1b159bc3f0fc51f3dca0d8c8f37604f15f943897",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9296c951_2fcdf08c",
        "filename": "third_party/WebKit/Source/core/frame/LocalFrameView.cpp",
        "patchSetId": 27
      },
      "lineNbr": 2134,
      "author": {
        "id": 1001168
      },
      "writtenOn": "2017-06-07T06:59:27Z",
      "side": 1,
      "message": "Ah, makes sense that it\u0027s failing while creating a new frame--this happens before we install a new document.",
      "parentUuid": "11f03d45_250fba01",
      "range": {
        "startLine": 2134,
        "startChar": 6,
        "endLine": 2134,
        "endChar": 27
      },
      "revId": "1b159bc3f0fc51f3dca0d8c8f37604f15f943897",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
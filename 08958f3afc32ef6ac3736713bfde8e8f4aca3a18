{
  "comments": [
    {
      "key": {
        "uuid": "a59a7537_4d58181e",
        "filename": "content/renderer/loader/web_url_request_util.h",
        "patchSetId": 2
      },
      "lineNbr": 44,
      "author": {
        "id": 1001472
      },
      "writtenOn": "2017-11-20T03:17:20Z",
      "side": 1,
      "message": "Thanks for reminding us of the serialization code. I\u0027ve been looking into this further, and I realized that the data pipe approach doesn\u0027t just work with it. Also I suspect it might not have been actually working well even in the legacy code but I\u0027m not entirely sure... currently we store Blob uuid (without securing blob\u0027s lifetime) into the serialization code and just tries to use it, but when it\u0027s deserialized there doesn\u0027t seem no guarantee that it can be read.\n\nI think we might need to split ResourceRequestBody into two, one that\u0027s used by renderer, navigation and browser process and the other one that is used for communication with Network Service?",
      "revId": "08958f3afc32ef6ac3736713bfde8e8f4aca3a18",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6261ccbf_e0140ab8",
        "filename": "content/renderer/loader/web_url_request_util.h",
        "patchSetId": 2
      },
      "lineNbr": 44,
      "author": {
        "id": 1000128
      },
      "writtenOn": "2017-11-21T02:29:55Z",
      "side": 1,
      "message": "The history serialization callsite is worrying and I want to understand it better. I haven\u0027t been able to create a test showing that history serialization is broken with data pipes.\n\nIn my test site which uploads a file \u003chttps://aware-flame.glitch.me/test-main-resource\u003e, NetworkService Chrome still seems to work since the body contains a FILE not BLOB element, so the data pipe conversion doesn\u0027t occur.\n\nIs there a way for a navigation to have a ResourceRequestBody with a BLOB type?",
      "parentUuid": "a59a7537_4d58181e",
      "revId": "08958f3afc32ef6ac3736713bfde8e8f4aca3a18",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b06c096b_f2fe7ab6",
        "filename": "content/renderer/loader/web_url_request_util.h",
        "patchSetId": 2
      },
      "lineNbr": 44,
      "author": {
        "id": 1001472
      },
      "writtenOn": "2017-11-21T06:22:06Z",
      "side": 1,
      "message": "Thanks for digging this.  If you get the form element, create a FormData from it, append a blob using it and send it with XHR-- would it work?\n\nE.g.\nvar formData \u003d new FormData(formElem);\nformData.append(\u0027blob field\u0027, blob, \u0027filename.txt\u0027);\nvar req \u003d new XMLHttpRequest();\nreq.open(\"POST\", \"...\", false /* bad! */);\nreq.send(formData);\n\n(Haven\u0027t tested with navigation yet though)",
      "parentUuid": "6261ccbf_e0140ab8",
      "revId": "08958f3afc32ef6ac3736713bfde8e8f4aca3a18",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7f96b327_e9bbbf74",
        "filename": "content/renderer/loader/web_url_request_util.h",
        "patchSetId": 2
      },
      "lineNbr": 44,
      "author": {
        "id": 1000128
      },
      "writtenOn": "2017-11-21T06:29:53Z",
      "side": 1,
      "message": "I thought history serialization is only for navigations, so XHR is ignored ( I will go ahead and add that test though.)\n\n(Even so it seems it\u0027d bad for code health to depend on the assumption that history serialization callsite works because it never hits the data pipe case.)",
      "parentUuid": "b06c096b_f2fe7ab6",
      "revId": "08958f3afc32ef6ac3736713bfde8e8f4aca3a18",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d1c008d2_8786f483",
        "filename": "content/renderer/loader/web_url_request_util.h",
        "patchSetId": 2
      },
      "lineNbr": 44,
      "author": {
        "id": 1001472
      },
      "writtenOn": "2017-11-21T14:25:20Z",
      "side": 1,
      "message": "How about something like this? If we won\u0027t hit blob code we should probably just delete it.\n\nvar formData \u003d new FormData(formElem);\nformData.append(\u0027blob field\u0027, blob);\nformElem.submit();",
      "parentUuid": "7f96b327_e9bbbf74",
      "revId": "08958f3afc32ef6ac3736713bfde8e8f4aca3a18",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c792f75d_e6d2e94c",
        "filename": "content/renderer/loader/web_url_request_util.h",
        "patchSetId": 2
      },
      "lineNbr": 44,
      "author": {
        "id": 1000128
      },
      "writtenOn": "2017-11-22T03:20:39Z",
      "side": 1,
      "message": "As I suspected, in the first XHR case history serialization doesn\u0027t trigger because it\u0027s not a navigation.\n\nWith the formElem.submit(), the form is submitted but it ignores formData and takes whatever is in the input elements.\n\nI guess we can remove the BLOB case but from GetWebHTTPBodyForRequestBody but it wouldn\u0027t really give us much. I was worried about the DATA_PIPE case (currently unimplemented) when we might try to get a data pipe that was already taken.\n\nI\u0027ve been experimenting with some things (keep changing my mind) and now starting to think DataPipeGetter is the best. It seems we need that in the non-service worker case to handle 307 redirects anyway. Right now the UpdateDataStream created by URLLoader gets consumed on the first request and the only way to get the data pipe back is by finding the WebHTTPBody which I believe is gone: URLLoader is in the browser process/network service and WebHTTPBody is back at the renderer.",
      "parentUuid": "d1c008d2_8786f483",
      "revId": "08958f3afc32ef6ac3736713bfde8e8f4aca3a18",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
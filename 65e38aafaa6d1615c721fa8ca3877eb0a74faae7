{
  "comments": [
    {
      "key": {
        "uuid": "32ba2a80_134cb97a",
        "filename": "chrome/browser/io_thread.cc",
        "patchSetId": 11
      },
      "lineNbr": 763,
      "author": {
        "id": 1115968
      },
      "writtenOn": "2017-11-02T20:15:37Z",
      "side": 1,
      "message": "THe issue is that you need to create a content::mojom::NetworkServicePtr, and have that live on the UI thread.  globals_-\u003enetwork_service lives on the IO thread, which is the issue you\u0027re running into.\n\nIn IOThread\u0027s cosntructor, you\u0027re need to do something like:\n\ncontent::mojom::NetworkServicePtr ui_thread_network_service_;\ncontent::mojom::NetworkServiceRequest network_service_request_ \u003d\n    mojo::MakeRequest(\u0026ui_thread_network_service_);\n\nAnd then in IOThread::ConstructSystemRequestContext, replace the line that initializes the NetworkService with:\nglobals_-\u003enetwork_service \u003d content::NetworkService::Create(std::move(network_service_request_), net_log_);\n\nAnd update NetworkService itself so that when created with that constructor, it binds the request to a mojo::Binding\u003ccontent::mojom::NetworkService\u003e.\n\nThen use the ui_thread_network_service_ here and everything should work out.\n\nIt may be better to make a method that looks like:\n\nmojom::NetworkService* GetNetworkServiceOnUIThread() {\n  if (/* network service feature enabled */) {\n    return content::GetNetworkService();\n  } else {\n    return ui_thread_network_service_.get();\n  }\n}\n\nThat encourages more use of a method we eventually want to get rid of, but it allows other things that rely on the same behavior to also access the network service directly (Like if we exposed a DNS lookup interface, NetLog interfaces, etc).",
      "range": {
        "startLine": 763,
        "startChar": 11,
        "endLine": 763,
        "endChar": 12
      },
      "revId": "65e38aafaa6d1615c721fa8ca3877eb0a74faae7",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "df94f0a3_49e8e3c4",
        "filename": "chrome/browser/io_thread.cc",
        "patchSetId": 11
      },
      "lineNbr": 763,
      "author": {
        "id": 1120845
      },
      "writtenOn": "2017-11-03T14:10:52Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "32ba2a80_134cb97a",
      "range": {
        "startLine": 763,
        "startChar": 11,
        "endLine": 763,
        "endChar": 12
      },
      "revId": "65e38aafaa6d1615c721fa8ca3877eb0a74faae7",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "dca7bb9c_8f3414b3",
        "filename": "chrome/browser/net/network_connection_tracker_browsertest.cc",
        "patchSetId": 11
      },
      "lineNbr": 116,
      "author": {
        "id": 1120845
      },
      "writtenOn": "2017-11-02T20:02:50Z",
      "side": 1,
      "message": "Hi Matt, sorry that i have so many questions. I think I am doing something wrong in the setup. When this test is run without kNetworkService, I get a thread checker failure. I thought Mojo would take care of posting tasks to client\u0027s thread. Do you have any suggestion? Thanks!\n\n[ RUN      ] NetworkConnectionTrackerBrowserTest.NetworkConnectionTracker/0\n[16297:16297:1102/151515.882923:WARNING:password_store_factory.cc(241)] Using basic (unencrypted) store for password storage. See https://chromium.googlesource.com/chromium/src/+/master/docs/linux_password_storage.md for more information about password storage options.\n[16297:16297:1102/151517.107299:INFO:network_connection_tracker_browsertest.cc(89)] SimulateNetworkChange*****************************\n[16297:16297:1102/151517.108675:INFO:network_connection_tracker.cc(124)] NetworkConnectionTracker::OnInitialConnectionType*********************\n[16297:16329:1102/151517.111629:INFO:network_change_manager.cc(61)] NetworkChangeManager::OnNetworkChanged******************4\n[16297:16329:1102/151517.111961:FATAL:interface_endpoint_client.cc(224)] Check failed: (sequence_checker_).CalledOnValidSequence().\n#0 0x7fdc7e569f2d base::debug::StackTrace::StackTrace()\n#1 0x7fdc7e56835c base::debug::StackTrace::StackTrace()\n#2 0x7fdc7e5ef2aa logging::LogMessage::~LogMessage()\n#3 0x7fdc79fc2b07 mojo::InterfaceEndpointClient::Accept()\n#4 0x7fdc764241f5 content::mojom::NetworkChangeManagerClientProxy::OnNetworkChanged()\n#5 0x7fdc75dd1a64 content::NetworkChangeManager::OnNetworkChanged()\n#6 0x7fdc7d5c616b base::internal::ObserverListThreadSafeBase::Dispatcher\u003c\u003e::Run()\n#7 0x7fdc7d5c6447 _ZN4base8internal13FunctorTraitsIPFvMN3net21NetworkChangeNotifier21NetworkChangeObserverEFvNS3_14ConnectionTypeEES5_PS4_EvE6InvokeIJRKS7_RKS5_S8_EEEvSA_DpOT_\n#8 0x7fdc7d5c63c0 _ZN4base8internal12InvokeHelperILb0EvE8MakeItSoIRKPFvMN3net21NetworkChangeNotifier21NetworkChangeObserverEFvNS5_14ConnectionTypeEES7_PS6_EJRKS9_RKS7_SA_EEEvOT_DpOT0_\n#9 0x7fdc7d5c635d _ZN4base8internal7InvokerINS0_9BindStateIPFvMN3net21NetworkChangeNotifier21NetworkChangeObserverEFvNS4_14ConnectionTypeEES6_PS5_EJS8_S6_EEEFvS9_EE7RunImplIRKSB_RKNSt3__15tupleIJS8_S6_EEEJLm0ELm1EEEEvOT_OT0_NSI_16integer_sequenceImJXspT1_EEEEOS9_\n#10 0x7fdc7d5c6264 _ZN4base8internal7InvokerINS0_9BindStateIPFvMN3net21NetworkChangeNotifier21NetworkChangeObserverEFvNS4_14ConnectionTypeEES6_PS5_EJS8_S6_EEEFvS9_EE3RunEPNS0_13BindStateBaseEOS9_\n#11 0x7fdc7d401aad _ZNKR4base17RepeatingCallbackIFvPN3net12CertDatabase8ObserverEEE3RunES4_\n#12 0x7fdc7d3fe32e base::ObserverListThreadSafe\u003c\u003e::NotifyWrapper()\n#13 0x7fdc7d4013c2 _ZN4base8internal13FunctorTraitsIMNS_22ObserverListThreadSafeIN3net12CertDatabase8ObserverEEEFvPS5_RKNS6_16NotificationDataEEvE6InvokeI13scoped_refptrIS6_EJS7_S8_EEEvSC_OT_DpOT0_\n#14 0x7fdc7d40131a _ZN4base8internal12InvokeHelperILb0EvE8MakeItSoIMNS_22ObserverListThreadSafeIN3net12CertDatabase8ObserverEEEFvPS7_RKNS8_16NotificationDataEEJ13scoped_refptrIS8_ES9_SA_EEEvOT_DpOT0_\n#15 0x7fdc7d40128d _ZN4base8internal7InvokerINS0_9BindStateIMNS_22ObserverListThreadSafeIN3net12CertDatabase8ObserverEEEFvPS6_RKNS7_16NotificationDataEEJ13scoped_refptrIS7_ES8_S9_EEEFvvEE7RunImplISD_NSt3__15tupleIJSF_S8_S9_EEEJLm0ELm1ELm2EEEEvOT_OT0_NSK_16integer_sequenceImJXspT1_EEEE\n#16 0x7fdc7d401169 _ZN4base8internal7InvokerINS0_9BindStateIMNS_22ObserverListThreadSafeIN3net12CertDatabase8ObserverEEEFvPS6_RKNS7_16NotificationDataEEJ13scoped_refptrIS7_ES8_S9_EEEFvvEE7RunOnceEPNS0_13BindStateBaseE\n#17 0x7fdc7e516051 _ZNO4base12OnceCallbackIFvvEE3RunEv\n#18 0x7fdc7e56e25a base::debug::TaskAnnotator::RunTask()\n#19 0x7fdc7e60e0f5 base::internal::IncomingTaskQueue::RunTask()\n#20 0x7fdc7e617050 base::MessageLoop::RunTask()\n#21 0x7fdc7e617306 base::MessageLoop::DeferOrRunPendingTask()\n#22 0x7fdc7e617650 base::MessageLoop::DoWork()\n#23 0x7fdc7e61d439 base::MessagePumpLibevent::Run()\n#24 0x7fdc7e6167cc base::MessageLoop::Run()\n#25 0x7fdc7e6c2acb base::RunLoop::Run()\n#26 0x7fdc7e784fc4 base::Thread::Run()\n#27 0x7fdc76e82a16 content::BrowserThreadImpl::IOThreadRun()\n#28 0x7fdc76e82d1b content::BrowserThreadImpl::Run()\n#29 0x7fdc7e785beb base::Thread::ThreadMain()\n#30 0x7fdc7e76b511 base::(anonymous namespace)::ThreadFunc()\n#31 0x7fdc7e911184 start_thread\n#32 0x7fdc6445bffd clone",
      "revId": "65e38aafaa6d1615c721fa8ca3877eb0a74faae7",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ff4cb768_9c79b185",
        "filename": "chrome/browser/net/network_connection_tracker_browsertest.cc",
        "patchSetId": 11
      },
      "lineNbr": 116,
      "author": {
        "id": 1120845
      },
      "writtenOn": "2017-11-03T14:10:52Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "dca7bb9c_8f3414b3",
      "revId": "65e38aafaa6d1615c721fa8ca3877eb0a74faae7",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "313c170f_2901e9c7",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 7,
      "author": {
        "id": 1143639
      },
      "writtenOn": "2017-11-24T14:40:13Z",
      "side": 1,
      "message": "track -\u003e MediaStreamTrack\n\ntrack has many meanings in the code base",
      "range": {
        "startLine": 7,
        "startChar": 44,
        "endLine": 7,
        "endChar": 49
      },
      "revId": "7ce3853d131adc2d2f35073e742099423bfeaa0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a69ecd02_58018f60",
        "filename": "third_party/WebKit/Source/modules/mediastream/MediaStreamTrack.cpp",
        "patchSetId": 1
      },
      "lineNbr": 168,
      "author": {
        "id": 1115916
      },
      "writtenOn": "2017-11-22T17:11:24Z",
      "side": 1,
      "message": "I\u0027m a bit concerned that this approximation is too random. If it overestimates the amount, it has a risk of triggering GCs too aggressively.\n\nWhy is it hard to report the exact size?",
      "revId": "7ce3853d131adc2d2f35073e742099423bfeaa0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "652beb5b_80f0a299",
        "filename": "third_party/WebKit/Source/modules/mediastream/MediaStreamTrack.cpp",
        "patchSetId": 1
      },
      "lineNbr": 168,
      "author": {
        "id": 1247458
      },
      "writtenOn": "2017-11-22T17:44:33Z",
      "side": 1,
      "message": "First, I believe it\u0027s an uncommon scenario where users will frequently create and stop tracks, and only do that. So I wouldn\u0027t be concerned by the GC triggers caused by this code. Other parts of the application will usually manipulate data and I believe those will eventually trigger some GC.\n\nThis is an approximation that came from various manual experiments and is in the same order of magnitude. It is a bit pessimistic for audio tracks and optimistic for video ones. For the later, opening a video device is so slow that it\u0027s unlikely to be a concern though.\n\nAs for getting an exact value, tracks can be local (using a hardware device) or remote (over RTCPeerConnection) and be backed by an audio or video source. Video sources are quite varied: capture from a hardware device, screen, tab, video element or canvas. Each can have various buffers involved for various features, for example an audio one can do echo cancellation.\nAll that makes it quite impractical to query a size, let alone be precise.",
      "parentUuid": "a69ecd02_58018f60",
      "revId": "7ce3853d131adc2d2f35073e742099423bfeaa0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "299705fc_a9b1e25f",
        "filename": "third_party/WebKit/Source/modules/mediastream/MediaStreamTrack.cpp",
        "patchSetId": 1
      },
      "lineNbr": 168,
      "author": {
        "id": 1115916
      },
      "writtenOn": "2017-11-23T01:36:39Z",
      "side": 1,
      "message": "+hpayer\n\nIf Hannes is okay with this, I\u0027m okay with it :)",
      "parentUuid": "652beb5b_80f0a299",
      "revId": "7ce3853d131adc2d2f35073e742099423bfeaa0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c0d7dc51_5da92a52",
        "filename": "third_party/WebKit/Source/modules/mediastream/MediaStreamTrack.cpp",
        "patchSetId": 1
      },
      "lineNbr": 168,
      "author": {
        "id": 1119605
      },
      "writtenOn": "2017-11-23T08:18:21Z",
      "side": 1,
      "message": "Ideally, we would report the exact amount of memory back to V8. Where are all the resources hanging of the MediaStreamTrack allocated? All on the same malloc\u0027ed heap?",
      "parentUuid": "299705fc_a9b1e25f",
      "revId": "7ce3853d131adc2d2f35073e742099423bfeaa0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "91250608_c8fe77ad",
        "filename": "third_party/WebKit/Source/modules/mediastream/MediaStreamTrack.cpp",
        "patchSetId": 1
      },
      "lineNbr": 168,
      "author": {
        "id": 1247458
      },
      "writtenOn": "2017-11-23T15:28:19Z",
      "side": 1,
      "message": "I agree we should ideally do that.\n\nI\u0027m not exactly sure where all the memory is allocated as I\u0027m new to the codebase and don\u0027t know it quite well yet. But following the recommendation from the team and the complexity of all the code paths for this media pipeline, we think it\u0027s impossible to reasonably compute any good value.\n\nThat\u0027s why we decided to pick a simple value in the right order of magnitude instead.",
      "parentUuid": "c0d7dc51_5da92a52",
      "revId": "7ce3853d131adc2d2f35073e742099423bfeaa0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b5ebd8ac_249abebd",
        "filename": "third_party/WebKit/Source/modules/mediastream/MediaStreamTrack.cpp",
        "patchSetId": 1
      },
      "lineNbr": 168,
      "author": {
        "id": 1115916
      },
      "writtenOn": "2017-11-24T03:44:29Z",
      "side": 1,
      "message": "FWIW Blink, CPU, cc and all other places are reporting exact values, so it should be worth exploring how media\u0027s memory is allocated.\n\nIf you don\u0027t know how media\u0027s memory is allocated, how can you know that kApproximateTrackSizeInBytes is a reasonable estimation?",
      "parentUuid": "91250608_c8fe77ad",
      "revId": "7ce3853d131adc2d2f35073e742099423bfeaa0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1cd8f68f_54f9ee10",
        "filename": "third_party/WebKit/Source/modules/mediastream/MediaStreamTrack.cpp",
        "patchSetId": 1
      },
      "lineNbr": 168,
      "author": {
        "id": 1247458
      },
      "writtenOn": "2017-11-24T10:19:49Z",
      "side": 1,
      "message": "I measured the process increased memory usage after allocating and stopping many tracks in a test program before the GC got executed.",
      "parentUuid": "b5ebd8ac_249abebd",
      "revId": "7ce3853d131adc2d2f35073e742099423bfeaa0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fc6de91b_81d81838",
        "filename": "third_party/WebKit/Source/modules/mediastream/MediaStreamTrack.cpp",
        "patchSetId": 1
      },
      "lineNbr": 168,
      "author": {
        "id": 1143639
      },
      "writtenOn": "2017-11-24T14:40:13Z",
      "side": 1,
      "message": "There are lots of ways to create MediaStreamTracks: device capture, screen capture, peer connections, capture from media elements, capture from canvas, capture from webaudio source. Consumption for each of these is highly variable, depending constrainable properties, which affect how  queues and buffers are used internally.\nIt is not practical to introduce an API in the MediaStreams framework in content so that each variant reports their exact consumption of memory.\n\nThe number reported in this CL is based on experimental observation of how memory is \"leaked\" after thousands of audio MediaStreamTracks are created, stopped and discarded without the GC kicking in. Our measurements indicate that memory consumption in the renderer process grows between 600K and 1MB for each audio track created with getUserMedia using default settings.\nIt is possible to produce audio tracks that consume less memory, but they are not the most common case.\nVideo tracks may consume more, depending on settings, but it takes longer to create them using getUserMedia().\n\nWhile just a rough ballpark estimate, reporting 1MB per track is closer to reality than the current number, which is zero and makes it easy to give the impression of memory leaks. For example, in http://crbug.com/788405, a user is reporting \"leaks\" of between 2MB/sec to 50MB/sec with screen capture.\n\nAlso, I would like to point out that not all uses of AdjustAmountOfExternalAllocatedMemory report exact values. For example, the comments for HTMLCanvasElement say they use a \"pessimistic but relevant estimate\". See https://cs.chromium.org/chromium/src/third_party/WebKit/Source/core/html/HTMLCanvasElement.cpp?type\u003dcs\u0026sq\u003dpackage:chromium\u0026l\u003d1535\n\nPerhaps we can lower the value from 1MB to something like 250K to make GC less aggressive?",
      "parentUuid": "1cd8f68f_54f9ee10",
      "revId": "7ce3853d131adc2d2f35073e742099423bfeaa0f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
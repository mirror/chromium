{
  "comments": [
    {
      "key": {
        "uuid": "632aae53_304847b5",
        "filename": "third_party/WebKit/Source/platform/scheduler/renderer/renderer_scheduler_impl.cc",
        "patchSetId": 6
      },
      "lineNbr": 1226,
      "author": {
        "id": 1150969
      },
      "writtenOn": "2017-10-02T15:52:51Z",
      "side": 1,
      "message": "Should it be if (new_policy.loading_queue_policy().is_stopped \u0026\u0026 !main_thread_only().current_policy.loading_queue_policy.is_stopped) to avoid reissuing signals each time the policy is updated?\n\nTaking into account my comment below,\n\nif (new_policy.is_stopped !\u003d old_policy.is_stopped) {\n  web_view_scheduler-\u003eSetStoppedInBackground(new_policy.is_stopped);\n}",
      "range": {
        "startLine": 1226,
        "startChar": 6,
        "endLine": 1226,
        "endChar": 50
      },
      "revId": "8063fe75a538b37f1c957871b7172c9e7fe5e1c9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5aa5c3cb_3f27a62a",
        "filename": "third_party/WebKit/Source/platform/scheduler/renderer/renderer_scheduler_impl.cc",
        "patchSetId": 6
      },
      "lineNbr": 1226,
      "author": {
        "id": 1175814
      },
      "writtenOn": "2017-10-04T00:28:19Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "632aae53_304847b5",
      "range": {
        "startLine": 1226,
        "startChar": 6,
        "endLine": 1226,
        "endChar": 50
      },
      "revId": "8063fe75a538b37f1c957871b7172c9e7fe5e1c9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ba53412f_aa1c0b38",
        "filename": "third_party/WebKit/Source/platform/scheduler/renderer/web_frame_scheduler_impl.cc",
        "patchSetId": 6
      },
      "lineNbr": 392,
      "author": {
        "id": 1150969
      },
      "writtenOn": "2017-10-02T15:52:51Z",
      "side": 1,
      "message": "I believe that there is a problem with this approach:\n1. This signal will conflict with other OnThrottlingStateChanged signal issued in other places in WebFrameScheduler.\n2. We do not issue a signal for when we resume a tab.\n\nTherefore I suggest the following:\n1. Instead of OnStoppedInBackground have SetStoppedInBackground (see my comment in renderer_scheduler_impl.cc)\n2. Have CalculateThrottlingState() helper function in WebFrameSchedulerImpl, which will look like this:\n\nThrottlingState CalculateThrottlingState() const {\n  if (page_stopped_)\n    return kStopped;\n  if (!page_visible)\n    return kThrottled;\n  return kNotThrottled;\n}\n\n3. Use CalculateThrottlingState for every OnThrottlingStateChanged call.",
      "range": {
        "startLine": 392,
        "startChar": 28,
        "endLine": 392,
        "endChar": 49
      },
      "revId": "8063fe75a538b37f1c957871b7172c9e7fe5e1c9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6b3ec14a_75f0e6cb",
        "filename": "third_party/WebKit/Source/platform/scheduler/renderer/web_frame_scheduler_impl.cc",
        "patchSetId": 6
      },
      "lineNbr": 392,
      "author": {
        "id": 1175814
      },
      "writtenOn": "2017-10-02T20:57:37Z",
      "side": 1,
      "message": "\u003c\u003c1. This signal will conflict with other OnThrottlingStateChanged signal issued in other places in WebFrameScheduler.\nCan you elaborate on this? Not sure I see the conflict yet.\n\n\u003c\u003c 2. We do not issue a signal for when we resume a tab.\nBy \"resume a tab\" do you mean when it comes back in foreground? Or some other definition?\nIf former - then there is a signal and I just re-tested it fires on foreground.\nWe always trigger WebViewSchedulerImpl::SetPageVisible when backgrounding / foregrounding the tab, which in turn calls WebFrameSchedulerImpl::SetPageVisible which invokes OnThrottlingStateChanged on observers.\n\nBTW I\u0027m happy to make the suggested change if it makes the code nicer, but I want to understand the reasoning :)",
      "parentUuid": "ba53412f_aa1c0b38",
      "range": {
        "startLine": 392,
        "startChar": 28,
        "endLine": 392,
        "endChar": 49
      },
      "revId": "8063fe75a538b37f1c957871b7172c9e7fe5e1c9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b5a2757d_3c6cb142",
        "filename": "third_party/WebKit/Source/platform/scheduler/renderer/web_frame_scheduler_impl.cc",
        "patchSetId": 6
      },
      "lineNbr": 392,
      "author": {
        "id": 1150969
      },
      "writtenOn": "2017-10-02T21:13:12Z",
      "side": 1,
      "message": "\u003e\u003e Or some other definition?\nThat\u0027s a very good question indeed. There are two different concepts of backgrounding/foregrounding here: renderer-level (RendererSchedulerImpl::SetRendererBackgrounded) and page-level (WebViewScheduler::SetPageVisible).\n\nIn this patch kStopped throttling signal is driven by RSI::SetRendererBackground and kThrottled/kNotThrottled is driven by SetPageVisible. I\u0027m worried about these signals interacting strangely in the miriad of the corner-cases (for example, when renderer starts to play audio in the background, renderer will be brought into foreground by SetRendererBackgrounded(false), but SetPageVisible won\u0027t be called. That\u0027s one example, but there are more, because these signals are fundamentally different).\n\nSo, unfortunately, the \"we always trigger WebViewSchedulerImpl::SetPageVisible when backgrounding / foregrounding the tab\" assumption isn\u0027t always true due to different notions of backgrounding (and bonus points for figuring out what this patch will do when there are multiple WebViewSchedulers inside one RendererScheduler). \n\nSo tldr is that we need to build the system with the assumption that renderer-level and page-level backgrounding are completely independent.",
      "parentUuid": "6b3ec14a_75f0e6cb",
      "range": {
        "startLine": 392,
        "startChar": 28,
        "endLine": 392,
        "endChar": 49
      },
      "revId": "8063fe75a538b37f1c957871b7172c9e7fe5e1c9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "61c1eb40_522c6ef7",
        "filename": "third_party/WebKit/Source/platform/scheduler/renderer/web_frame_scheduler_impl.cc",
        "patchSetId": 6
      },
      "lineNbr": 392,
      "author": {
        "id": 1175814
      },
      "writtenOn": "2017-10-04T00:28:19Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b5a2757d_3c6cb142",
      "range": {
        "startLine": 392,
        "startChar": 28,
        "endLine": 392,
        "endChar": 49
      },
      "revId": "8063fe75a538b37f1c957871b7172c9e7fe5e1c9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b38b6e45_ae611791",
        "filename": "third_party/WebKit/Source/platform/scheduler/renderer/web_view_scheduler_impl.cc",
        "patchSetId": 6
      },
      "lineNbr": 143,
      "author": {
        "id": 1001472
      },
      "writtenOn": "2017-10-02T08:17:24Z",
      "side": 1,
      "message": "nit: no braces for single-line body for consistency",
      "revId": "8063fe75a538b37f1c957871b7172c9e7fe5e1c9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ffdc6bfc_d9a4f658",
        "filename": "third_party/WebKit/Source/platform/scheduler/renderer/web_view_scheduler_impl.cc",
        "patchSetId": 6
      },
      "lineNbr": 143,
      "author": {
        "id": 1175814
      },
      "writtenOn": "2017-10-02T20:57:37Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b38b6e45_ae611791",
      "revId": "8063fe75a538b37f1c957871b7172c9e7fe5e1c9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
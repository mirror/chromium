# Copyright (c) 2006-2008 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

import os
import string
import subprocess
import sys
import tarfile
import zipfile


default_url = 'svn://chrome-svn.corp.google.com/chrome/trunk/depot_tools'

if ARGUMENTS.get('RELEASE') == '1':
  depot_tools_dir = ''
  depot_tools_dir_ = ''
else:
  depot_tools_dir = ARGUMENTS.get('DEPOT_TOOLS_DIR', 'development')
  depot_tools_dir_ = depot_tools_dir + '/'

download_url = ARGUMENTS.get('DOWNLOAD_URL')
if download_url is None:
  download_url = default_url
  if depot_tools_dir:
    download_url += '/' + depot_tools_dir

release_arches = [
    'linux',
    'mac',
    'win',
]


base_env = Environment(tools = [],
                       WRAPPER_DIR = '#$DEPOT_TOOLS_DIR/$RELEASE_ARCH',
                       RELEASE_DIR = '#$DEPOT_TOOLS_DIR/release/$RELEASE_ARCH',
                       DOWNLOAD_URL = download_url)


def Substitute(target, source, env):
  tfp = open(str(target[0]), 'w')
  sfp = open(str(source[0]), 'r')
  c = string.Template(sfp.read())
  tfp.write(c.safe_substitute(env.Dictionary()))

SubstituteAction = Action(Substitute,
                          'Substitute file: "$SOURCE" as "$TARGET"',
                          varlist=['DOWNLOAD_URL'])

base_env['BUILDERS']['Substitute'] = Builder(action=SubstituteAction,
                                        source_factory=File,
                                        target_factory=File)

def InstallSubstitutions(env, target, source):
  result = []
  dir = str(target)
  for s in source:
    t = env.Substitute(dir + '/' + os.path.split(s)[1], s)
    result.extend(t)
  return result

base_env.AddMethod(InstallSubstitutions)


def CopySubversionTree(env, target, source):
  target = str(env.Dir(target))
  source = str(env.Dir(source))
  for root, dirs, files in os.walk(source):
    subdir = root.replace(source, '')
    if subdir.startswith('/'):
      subdir = subdir[1:]
    if '.svn' in dirs:
      dirs.remove('.svn')
    for f in files:
      env.InstallAs(os.path.join(target, subdir, f),
                    os.path.join(source, subdir, f))

base_env.AddMethod(CopySubversionTree)


def FailForModifiedSubversionWorkingDirectory(source):
  svn = subprocess.Popen(['svn', 'status', source],
                         stdout=subprocess.PIPE,
                         stderr=subprocess.PIPE,
                         shell=(sys.platform=='win32'))
  stdout, stderr = svn.communicate()
  if stderr:
    sys.stdout.write("STDOUT ==========\n" + stdout)
    sys.stderr.write("STDERR ==========\n" + stderr)
    return True
  elif stdout:
    msg = 'WARNING: modified source tree %s:\n%s'
    sys.stdout.write(msg % (repr(source), stdout))
  return False

def TarWrappers(target, source, env):
  source = str(source[0])
  if FailForModifiedSubversionWorkingDirectory(source):
    return 1
  tfp = tarfile.open(str(target[0]), 'w:gz')
  tfp.add(source, 'depot_tools')
  return None

TarWrappersAction = Action(TarWrappers,
                          'TarWrappers file: "$SOURCE" as "$TARGET"')

base_env['BUILDERS']['TarWrappers'] = Builder(action=TarWrappersAction,
                                              source_factory=Dir,
                                              target_factory=File)

def ZipWrappers(target, source, env):
  source = str(source[0])
  if FailForModifiedSubversionWorkingDirectory(source):
    return 1
  tfp = zipfile.ZipFile(str(target[0]), 'w', zipfile.ZIP_DEFLATED)
  for root, dirs, files in os.walk(source):
    subdir = root.replace(source, '')
    if subdir.startswith('/'):
      subdir = subdir[1:]
    for d in dirs:
      dname = os.path.join('depot_tools', subdir, d, '')
      zinfo = zipfile.ZipInfo(dname)
      zinfo.external_attr = 48 # directory
      tfp.writestr(zinfo, '')
    for f in files:
      tfp.write(os.path.join(root, f),
                os.path.join('depot_tools', subdir, f))
    if env['RELEASE_ARCH'] in ('linux', 'mac'):
      for zinfo in tfp.filelist:
        zinfo.create_system = 3 # UNIX
  return None

ZipWrappersAction = Action(ZipWrappers,
                          'ZipWrappers file: "$SOURCE" as "$TARGET"')

base_env['BUILDERS']['ZipWrappers'] = Builder(action=ZipWrappersAction,
                                              source_factory=Dir,
                                              target_factory=File)


env = base_env.Clone(DEPOT_TOOLS_DIR = depot_tools_dir,
                     DEPOT_TOOLS_DIR_ = depot_tools_dir_)

for release_arch in release_arches:
  env = env.Clone(RELEASE_ARCH = release_arch)
  Export('env')
  SConscript('src/wrappers/SConscript')
  SConscript('src/release/SConscript')
  if release_arch in ('linux', 'mac'):
    env.TarWrappers('${DEPOT_TOOLS_DIR_}depot_tools_${RELEASE_ARCH}.tar.gz',
                    '$WRAPPER_DIR')
  if release_arch in ('win',):
    env.ZipWrappers('${DEPOT_TOOLS_DIR_}depot_tools_${RELEASE_ARCH}.zip',
                    '$WRAPPER_DIR')


Help("""
usage: scons [OPTION [TARGET] ...

SCons configuration for packaging depot_tools.

  DOWNLOAD_URL=         Specify the URL that will get inserted in the
	                appropriate update scripts for depot_tools to
                        sync from.
  DEPOT_TOOLS_DIR=      Specify the directory into which to build/release
                        the scripts.  Default is 'development'.
  RELEASE=1             Specifies that you want to release a copy of
                        what's in src/ publicly.  Causes the linux/,
                        mac/, release/ and win/ directories to be
                        upated.  You can then "svn diff" to make sure
                        things look okay before committing.
""")

{
  "comments": [
    {
      "key": {
        "uuid": "514073f1_0250d929",
        "filename": "content/browser/service_worker/service_worker_version.cc",
        "patchSetId": 1
      },
      "lineNbr": 1319,
      "author": {
        "id": 1125915
      },
      "writtenOn": "2017-08-04T10:06:24Z",
      "side": 1,
      "message": "IIUC, We no longer have another call site of DidSkipWaiting, so I think we can remove DidSkipWaiting and expand its content here.",
      "revId": "0c6e05a7a2b11e8bf32b9ad6218cdaf7c8b0d5d5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "35d1c12a_4c7fef30",
        "filename": "content/browser/service_worker/service_worker_version.cc",
        "patchSetId": 1
      },
      "lineNbr": 1320,
      "author": {
        "id": 1125915
      },
      "writtenOn": "2017-08-04T10:06:24Z",
      "side": 1,
      "message": "I think we need to return here unless it\u0027s INSTALLED.\nAnyway, do you know when it\u0027s INSTALLED here? I guess if skipWaiting is called in e.waitUntil() for the install event handler, |status_| should be INSTALLING. If it\u0027s INSTALLED, that probably means skipWaiting was called in the install event handler directly without using waitUntil().\nIs that case still valid?",
      "revId": "0c6e05a7a2b11e8bf32b9ad6218cdaf7c8b0d5d5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "532be34c_7a38a22b",
        "filename": "content/browser/service_worker/service_worker_version.cc",
        "patchSetId": 1
      },
      "lineNbr": 1320,
      "author": {
        "id": 1223459
      },
      "writtenOn": "2017-08-09T02:13:49Z",
      "side": 1,
      "message": "I re-considered several times, The below change maybe right, WDYT?\n---\n  if (status_ !\u003d INSTALLED)                                                                                                                                                             \n    return DidSkipWaiting(request_id);                                                                                                                                                  \n  else                                                                                                                                                                                  \n    DidSkipWaiting(request_id); \n---\nYou are right, if skipWaiting is called in e.waitUntil() for the install event handler, |status_| is INSTALLING.\nIn some cases, |status_| is INSTALLED. such as the skip-waiting-installed.https.html, wait for INSTALLED status, and then post message to SW, run event.waitUntil(self.skipWaiting()...).\n\nAccording to the discussion in https://github.com/w3c/ServiceWorker/issues/1015, the promise should be resolved right away after setting the skip waiting flag. This is the reason that we need deal with the INSTALLED case here.\n\nHowever, for the sample in this issue #725616：\n----\noninstall \u003d function() {\n    console.log(\u0027install\u0027);\n    setTimeout(function() {\n        self.skipWaiting()\n          .then(function() {\n              console.log(\u0027skipWaiting resolved\u0027);\n            });\n      }, 0);\n  };\n----\n\nＩ am thinking the result can NOT be: \"install\"-\u003e\"skipWaiting resolved\"-\u003e\"activate\", because what setTimeout does is add a new event to the browser event queue and the rendering engine is already in that queue, so it gets executed before the setTimeout event, so even with the fix patch, the result is \"install\" -\u003e \"activate\" -\u003e \"skipWaiting resolved\", am I right?",
      "parentUuid": "35d1c12a_4c7fef30",
      "revId": "0c6e05a7a2b11e8bf32b9ad6218cdaf7c8b0d5d5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5f3984fb_3eeb5ca6",
        "filename": "content/browser/service_worker/service_worker_version.cc",
        "patchSetId": 1
      },
      "lineNbr": 1320,
      "author": {
        "id": 1223459
      },
      "writtenOn": "2017-08-09T06:15:45Z",
      "side": 1,
      "message": "And base on above analysis, if we PostDelayedTask with 1ms in ServiceWorkerRegistration::ActivateWaitingVersion instead of ContinueActivation directly, the output will be \"install\"-\u003e\"skipWaiting resolved\"-\u003e\"activate\". But I don\u0027t think this is a right change, WDYT?",
      "parentUuid": "532be34c_7a38a22b",
      "revId": "0c6e05a7a2b11e8bf32b9ad6218cdaf7c8b0d5d5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "84b17bee_ab4998e4",
        "filename": "content/browser/service_worker/service_worker_version.cc",
        "patchSetId": 1
      },
      "lineNbr": 1320,
      "author": {
        "id": 1125915
      },
      "writtenOn": "2017-08-10T02:36:29Z",
      "side": 1,
      "message": "Sorry, I\u0027m missing something.\n\n--\n  if (status_ !\u003d INSTALLED)                                                                                                                                                             \n    return DidSkipWaiting(request_id);                                                                                                                                                  \n  else                                                                                                                                                                                  \n    DidSkipWaiting(request_id); \n-- \nWhat do you mean for this? Should just calling DidSkipWaiting() in OnSkipWaiting() be okay?\nI think we might need to keep the following activation algorithm here for the case where skipWaiting() is called after installing event (|status_| is INSTALLED in that case).\n// I quickly scanned the spec and couldn\u0027t find description like \"skipWaiting should work only in the install event\".\n\n\u003d\u003d\n\nFor the setTimeout example, I guess the order of events will be \"install\"-\u003e\"skipWaiting resolved\"-\u003e\"activate\" after your fix is merged. \n1: install event is fired via mojom::ServiceWorkerEventDispatcher\n2: setTimeout adds an event handler and it immediately queues the timeout event to the event queue\n3: install event is finished and the end of the event is sent back to the browser process\n4-a: on the browser process, activate event is not fired since skipWaiting is not called yet\n4-b: on the renderer process, the timeout event is fired. It calls skipWaiting and sends an IPC to the browser (OnSkipWaiting() is called).\n5: Activate procedure is triggered (it\u0027s L.1321-1329 in this patch)\n6: Activate event is triggered and it\u0027s sent to the renderer.\n\nIf it\u0027s correct, I think the test works well once your patch lands.\nWDYT?",
      "parentUuid": "5f3984fb_3eeb5ca6",
      "revId": "0c6e05a7a2b11e8bf32b9ad6218cdaf7c8b0d5d5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
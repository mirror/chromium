{
  "comments": [
    {
      "key": {
        "uuid": "bce6b6ab_b3262554",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/notifications/NotificationPlatformBridge.java",
        "patchSetId": 3
      },
      "lineNbr": 667,
      "author": {
        "id": 1176654
      },
      "writtenOn": "2017-11-17T22:03:36Z",
      "side": 1,
      "message": "For each WebAPK we will have both a corresponding notification channel in Chrome settings and a notification channel in the WebAPK\u0027s settings. I am unsure if we care about this.\n\nA notification channel is created for the website in NotificationSettingsBridge#createChannel() as a result of the permission prompt being shown.",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8ec2ba4c_cf2a3dc7",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/notifications/NotificationPlatformBridge.java",
        "patchSetId": 3
      },
      "lineNbr": 667,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-17T22:32:56Z",
      "side": 1,
      "message": "It seems to me that it doesn\u0027t matter which channel it is set in Chrome, since the notification eventually go to the WebAPK channel. We just don\u0027t create an extra Chrome\u0027s channel here. I have tested to set to \"Browser\" channel for WebAPKs, disabling that channel in Chrome\u0027s app setting won\u0027t block WebAPKs notifications. Thought?",
      "parentUuid": "bce6b6ab_b3262554",
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7510e083_695642c5",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/notifications/NotificationPlatformBridge.java",
        "patchSetId": 3
      },
      "lineNbr": 667,
      "author": {
        "id": 1176654
      },
      "writtenOn": "2017-11-20T13:59:06Z",
      "side": 1,
      "message": "I think that doing what you are doing is ok. The alternative is to prevent creating the channel in Chrome if the notification is destined for the WebAPK. This seems non-trivial (which is why I think what you are doing is ok).\n\nI do think that whether a notification channel is created in Chrome for notifications destined to the WebAPK is worth a conscious decision.",
      "parentUuid": "8ec2ba4c_cf2a3dc7",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "23faca84_98e06a14",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/notifications/NotificationPlatformBridge.java",
        "patchSetId": 3
      },
      "lineNbr": 667,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-20T15:42:21Z",
      "side": 1,
      "message": "Definitely. Defer this to notification owners.",
      "parentUuid": "7510e083_695642c5",
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "31ab92d0_ef633f36",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/notifications/NotificationPlatformBridge.java",
        "patchSetId": 3
      },
      "lineNbr": 667,
      "author": {
        "id": 1187649
      },
      "writtenOn": "2017-11-20T18:03:44Z",
      "side": 1,
      "message": "Hi Xi\n\nYou are correct that if you set the channel id to the \u0027browser\u0027 channel in chrome and then block the browser channel, the notifications will still be delivered. However, this is misleading because we specifically check the channel status of the site channel matching the notification\u0027s origin when delivering notifications, regardless of which channel it\u0027s posted to in the end.\n\nThis means that if the site channel is blocked then notifications won\u0027t be delivered to the web apk. (See notification_channels_provider_android.cc for the implementation). You can see for yourself by blocking a site channel in Canary, and note that notifications are no longer passed through to the web apk due to Chrome\u0027s permission checks. \n\nI expect the same thing happens pre-O if you block the site\u0027s notification permission in Chrome\u0027s site settings, but haven\u0027t checked.\n\nPeter Beverloo suggested to me this behaviour may be non-ideal. Maybe we should instead ignore the channel status / permission in chrome, and delete the site channel in chrome (if it exists) when the site is added to home screen. \n\nThen we would need to delegate to the web apk\u0027s channel status to determine permission, and either remove the site from chrome site settings or link through to the *webapk\u0027s* channel settings for users on O to toggle the permission.\n\nThis would be a rather large change. I suggest you file a bug for figuring out the right behaviour here, and cc the permissions team to see what they think too.",
      "parentUuid": "23faca84_98e06a14",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ea1150b1_278482cc",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 58,
      "author": {
        "id": 1176654
      },
      "writtenOn": "2017-11-17T22:03:36Z",
      "side": 1,
      "message": "HostBrowserClassLoader#getClassLoaderInstance() does not always return the same value.\n\nPerhaps we should have a\nboolean WebApkServiceImplWrapper#onBind()\nmethod which instantiates mIBinderDelegate. WebApkServiceImplWrapper#onBind() would be called each time that WebApkServiceFactory#onBind() is called.\nWebApkServiceFactory#onBind() will return null if WebApkServiceImplWrapper#onBind() returns false\n\nI think that WebApkServiceFactory#onBind() always creates a new WebApkServiceImplWrapper because only a single app binds to the service.",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "153f2b57_c5878e17",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 58,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-20T15:42:21Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ea1150b1_278482cc",
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4679e96a_ef591150",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 85,
      "author": {
        "id": 1176654
      },
      "writtenOn": "2017-11-17T22:03:36Z",
      "side": 1,
      "message": "This block on 82-91 should be in its own function. This early return is scary if we want to add more things to the constructor.",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9dae8e51_acea94fc",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 85,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-17T22:32:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "4679e96a_ef591150",
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "61f25713_fcf8f2c2",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 96,
      "author": {
        "id": 1001618
      },
      "writtenOn": "2017-11-17T19:18:10Z",
      "side": 1,
      "message": "i think you\u0027d want to default this -1 to avoid clashing with something real",
      "range": {
        "startLine": 96,
        "startChar": 19,
        "endLine": 96,
        "endChar": 20
      },
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d7a0d764_97029191",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 96,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-17T22:32:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "61f25713_fcf8f2c2",
      "range": {
        "startLine": 96,
        "startChar": 19,
        "endLine": 96,
        "endChar": 20
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "939230eb_d6a8dbed",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 97,
      "author": {
        "id": 1001618
      },
      "writtenOn": "2017-11-17T19:18:10Z",
      "side": 1,
      "message": "Please extract this to a helper function so the purpose is more clear within this function. Ditto for the other reflection call before (I think it\u0027s a particularly helpful pattern for reflection :)",
      "range": {
        "startLine": 97,
        "startChar": 0,
        "endLine": 97,
        "endChar": 13
      },
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b0ff88f7_a4aefdc3",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 97,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-17T22:32:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "939230eb_d6a8dbed",
      "range": {
        "startLine": 97,
        "startChar": 0,
        "endLine": 97,
        "endChar": 13
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "466680e0_29de84aa",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 98,
      "author": {
        "id": 1001618
      },
      "writtenOn": "2017-11-17T19:18:10Z",
      "side": 1,
      "message": "if reflecting the runtime dex failed above, this will NPE",
      "range": {
        "startLine": 98,
        "startChar": 22,
        "endLine": 98,
        "endChar": 38
      },
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3608d0d0_e8d29c26",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 98,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-17T22:32:56Z",
      "side": 1,
      "message": "Good catch! Add a null check.",
      "parentUuid": "466680e0_29de84aa",
      "range": {
        "startLine": 98,
        "startChar": 22,
        "endLine": 98,
        "endChar": 38
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d411904b_b1181dfd",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 109,
      "author": {
        "id": 1001618
      },
      "writtenOn": "2017-11-17T19:18:10Z",
      "side": 1,
      "message": "// This is a notifyNotification call, so defer to our parent\u0027s onTransact which will eventually dispatch it to our notifyNotification",
      "range": {
        "startLine": 109,
        "startChar": 25,
        "endLine": 109,
        "endChar": 35
      },
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0a2e933a_a1f33f00",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 109,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-17T22:32:56Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "d411904b_b1181dfd",
      "range": {
        "startLine": 109,
        "startChar": 25,
        "endLine": 109,
        "endChar": 35
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bef369b4_ae9038b5",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 142,
      "author": {
        "id": 1001618
      },
      "writtenOn": "2017-11-17T19:18:10Z",
      "side": 1,
      "message": "Can we only do this if the notification isn\u0027t already set? It\u0027s not immediately clear to me that we want to override the channel if chrome is setting it - or was that intentional?",
      "range": {
        "startLine": 142,
        "startChar": 27,
        "endLine": 142,
        "endChar": 28
      },
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "531ff2b4_e1ceaeb6",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 142,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-17T22:32:56Z",
      "side": 1,
      "message": "I did this intentionally. This is because we need to create the corresponding channel in WebAPKs before the notification is sent, and we only want to keep one \"General\" channel in WebAPKs.",
      "parentUuid": "bef369b4_ae9038b5",
      "range": {
        "startLine": 142,
        "startChar": 27,
        "endLine": 142,
        "endChar": 28
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a02a590b_e682cca7",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 142,
      "author": {
        "id": 1176654
      },
      "writtenOn": "2017-11-20T13:59:06Z",
      "side": 1,
      "message": "Hopefully, one day we won\u0027t need to override the notification code. I agree with Yaron",
      "parentUuid": "531ff2b4_e1ceaeb6",
      "range": {
        "startLine": 142,
        "startChar": 27,
        "endLine": 142,
        "endChar": 28
      },
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9e8833cc_386c7974",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 142,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-20T15:42:21Z",
      "side": 1,
      "message": "Agree, as long as all notifications of a WebAPK is sent to the same Channel, we can create that channel in webapks.",
      "parentUuid": "a02a590b_e682cca7",
      "range": {
        "startLine": 142,
        "startChar": 27,
        "endLine": 142,
        "endChar": 28
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8d657fc7_00112db5",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 142,
      "author": {
        "id": 1001618
      },
      "writtenOn": "2017-11-20T20:32:38Z",
      "side": 1,
      "message": "Per discussoin offline, the current into isn\u0027t enough to create a channel on-the-fly (there\u0027s no user-visible channel name) so we\u0027d need a new aidl API anyway to include channel. So therefore I think it\u0027s fine to just override it",
      "parentUuid": "9e8833cc_386c7974",
      "range": {
        "startLine": 142,
        "startChar": 27,
        "endLine": 142,
        "endChar": 28
      },
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e924a682_3b254ad6",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 156,
      "author": {
        "id": 1001618
      },
      "writtenOn": "2017-11-17T19:18:10Z",
      "side": 1,
      "message": "can you still pass through the notification to IBinderDelegate? Not doing that effectively breaks the runtime library cause you can never override this behaviour.\n\nYou also currently aren\u0027t enforcing the security guarantee and any app can call this function to show a notification",
      "range": {
        "startLine": 156,
        "startChar": 16,
        "endLine": 156,
        "endChar": 22
      },
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f4d03cfc_3367aa7a",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 156,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-17T22:32:56Z",
      "side": 1,
      "message": "Yes, we could call IBinderDelegate via reflection.\nI think the check should be done in Chrome before it sends the notification to WebAPKs. Once it is in WebAPKs, we can\u0027t send the notification back to Chrome. Even if we always call notify,  whether user will see the notification depends on the app settings.",
      "parentUuid": "e924a682_3b254ad6",
      "range": {
        "startLine": 156,
        "startChar": 16,
        "endLine": 156,
        "endChar": 22
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7b361549_44a6a236",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 156,
      "author": {
        "id": 1176654
      },
      "writtenOn": "2017-11-20T13:59:06Z",
      "side": 1,
      "message": "I think that the security check that Yaron is talking about is WebApkServiceImpl#onTransact(). As it stands, your code will allow any app to display notifications as if they are coming from Maps Lite",
      "parentUuid": "f4d03cfc_3367aa7a",
      "range": {
        "startLine": 156,
        "startChar": 16,
        "endLine": 156,
        "endChar": 22
      },
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "85154275_397ec288",
        "filename": "chrome/android/webapk/shell_apk/src/org/chromium/webapk/shell_apk/WebApkServiceImplWrapper.java",
        "patchSetId": 3
      },
      "lineNbr": 156,
      "author": {
        "id": 1117405
      },
      "writtenOn": "2017-11-20T15:42:21Z",
      "side": 1,
      "message": "I see. Add the same check to WebApkServiceImplWrapper#onTransact().",
      "parentUuid": "7b361549_44a6a236",
      "range": {
        "startLine": 156,
        "startChar": 16,
        "endLine": 156,
        "endChar": 22
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "ec432c01dd5698396e720d0e794078eed23fb8bf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "52902ccb_eed9d815",
        "filename": "third_party/zlib/contrib/optimizations/arm/armv8_crc32.c",
        "patchSetId": 5
      },
      "lineNbr": 59,
      "author": {
        "id": 1109754
      },
      "writtenOn": "2017-12-15T11:12:53Z",
      "side": 1,
      "message": "This can\u0027t be right, it\u0027s off-by-one.  Since no bot complained, a unit test is needed to prevent this error.",
      "revId": "3fa03e0f3d9ce5de8198764b6714048d2ccd9c04",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4ef0b37b_eeb8db24",
        "filename": "third_party/zlib/contrib/optimizations/arm/armv8_crc32.c",
        "patchSetId": 5
      },
      "lineNbr": 59,
      "author": {
        "id": 1109754
      },
      "writtenOn": "2017-12-15T15:25:22Z",
      "side": 1,
      "message": "Thinking some more, I\u0027d expect this to crash.  Leave it as is, but add an exit(0) somewhere in the routine to make it crash if called.  Send that change up to the bots and let\u0027s see what happens. I\u0027d expect it to be called on our bots, unless I\u0027m missing something ...",
      "parentUuid": "52902ccb_eed9d815",
      "revId": "3fa03e0f3d9ce5de8198764b6714048d2ccd9c04",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7e435b13_05ca4ce1",
        "filename": "third_party/zlib/contrib/optimizations/arm/armv8_crc32.c",
        "patchSetId": 5
      },
      "lineNbr": 59,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-15T20:25:50Z",
      "side": 1,
      "message": "Good idea on unit tests.\nZlib provides some unit tests but they aren\u0027t in a position to fit into gtest naturally. I would love to write some tests once I finish the fuzzers.\n\nAnyway, at this point in code, len has to be less than 8.\nSuppose len is 1. Because we -- first, we never enter this loop and are indeed off by one.\n\nAlso, I believe it is only likely to crash when len is 0.\nBecause we -- first, we wrap around to the maximum value size_t can hold on this platform. That would mean a LOT of looping to get back to 0 and exit the while loop. During those loops, we keep asking for the next byte in the buffer. Sooner or later, it should request an invalid memory address.\n\nHowever, if len is anything other than 0 we won\u0027t wrap around. We\u0027ll only access valid memory and will only have the off-by-one error.",
      "parentUuid": "4ef0b37b_eeb8db24",
      "revId": "3fa03e0f3d9ce5de8198764b6714048d2ccd9c04",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fc37aebc_79c20fc4",
        "filename": "third_party/zlib/contrib/optimizations/arm/armv8_crc32.c",
        "patchSetId": 5
      },
      "lineNbr": 59,
      "author": {
        "id": 1145695
      },
      "writtenOn": "2017-12-15T20:49:45Z",
      "side": 1,
      "message": "To quote a friend: There are 2 hard problems in computer science: cache invalidation, naming things, and off-by-1 errors.\n\nGood catch, I will fix it.\n\nConcerning unit tests: I had quite a few fro Adler-32, so it may make sense to add utests in an upcoming patch.",
      "parentUuid": "7e435b13_05ca4ce1",
      "revId": "3fa03e0f3d9ce5de8198764b6714048d2ccd9c04",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "692e93d3_a4af15a9",
        "filename": "third_party/zlib/contrib/optimizations/arm/armv8_crc32.c",
        "patchSetId": 5
      },
      "lineNbr": 59,
      "author": {
        "id": 1145695
      },
      "writtenOn": "2017-12-15T23:39:51Z",
      "side": 1,
      "message": "I noticed that in pngs is quite common to have compressed data segments that are multiples of 2 (e.g. 512, 1024, 8K, etc).\n\nIn such scenario, would the tail handling be executed at all?\n\nIt may be the case that the current tests the bots perform don\u0027t have content that stresses the tail code?",
      "parentUuid": "fc37aebc_79c20fc4",
      "revId": "3fa03e0f3d9ce5de8198764b6714048d2ccd9c04",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f5035955_18cd3db3",
        "filename": "third_party/zlib/contrib/optimizations/arm/armv8_crc32.c",
        "patchSetId": 5
      },
      "lineNbr": 59,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-15T23:50:37Z",
      "side": 1,
      "message": "I think it is still possible. This isn\u0027t the tail of 512, 1024, etc. It is the unaligned tail.\n\nThe first while (len \u0026\u0026 ((uintptr_t)buf \u0026 7)) loop on line 33 handles the unaligned head of the data. Suppose we have 1024 bytes, but the first single byte isn\u0027t aligned. That loop will iterate 1 time, leaving 1023 bytes.\n\nThe next while loop is an unrolled, 8-byte aligned loop. It will loop 15 times (working on 64 bytes at a time), leaving 63 bytes when it is done.\n\nThen when it runs out of unrolled space, it tightens into another 8-byte aligned while loop. This will run 7 times, leaving 7 bytes when finished.\n\nBecause the head wasn\u0027t aligned, the tail won\u0027t be aligned either. The head was out of alignment by 1 byte. So the tail is out of alignment by 7 bytes (8 byte alignment - 1 byte offset in the head).\n\nSo this final loop runs 7 times, even though our data size if 1024.",
      "parentUuid": "692e93d3_a4af15a9",
      "revId": "3fa03e0f3d9ce5de8198764b6714048d2ccd9c04",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1424d85a_ad990be9",
        "filename": "third_party/zlib/contrib/optimizations/arm/armv8_crc32.c",
        "patchSetId": 5
      },
      "lineNbr": 59,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-15T23:52:45Z",
      "side": 1,
      "message": "Although, you might be onto something.\nIt is entirely possible that this tail was never executed (nor the head) because all of the allocations on the bots were at least 8-byte aligned.",
      "parentUuid": "f5035955_18cd3db3",
      "revId": "3fa03e0f3d9ce5de8198764b6714048d2ccd9c04",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ff6d9d74_3e70b7ca",
        "filename": "third_party/zlib/crc32.c",
        "patchSetId": 5
      },
      "lineNbr": 251,
      "author": {
        "id": 1145695
      },
      "writtenOn": "2017-12-13T23:48:59Z",
      "side": 1,
      "message": "I wonder if it would make sense to fallback to the pure C version for len \u003c 8?",
      "revId": "3fa03e0f3d9ce5de8198764b6714048d2ccd9c04",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f605752b_959e973e",
        "filename": "third_party/zlib/crc32.c",
        "patchSetId": 5
      },
      "lineNbr": 251,
      "author": {
        "id": 1109754
      },
      "writtenOn": "2017-12-15T11:12:53Z",
      "side": 1,
      "message": "Well probably, the crc32 bench mark on small buffers could help to see if does make sense.",
      "parentUuid": "ff6d9d74_3e70b7ca",
      "revId": "3fa03e0f3d9ce5de8198764b6714048d2ccd9c04",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
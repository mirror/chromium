{
  "comments": [
    {
      "key": {
        "uuid": "ee377906_a9adcda5",
        "filename": "content/browser/renderer_host/render_widget_host_input_event_router.cc",
        "patchSetId": 4
      },
      "lineNbr": 374,
      "author": {
        "id": 1000111
      },
      "writtenOn": "2018-01-08T20:09:30Z",
      "side": 1,
      "message": "This is something you should do during dispatch, right? Not before targeting is done?",
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f4551089_e014032e",
        "filename": "content/browser/renderer_host/render_widget_host_input_event_router.cc",
        "patchSetId": 4
      },
      "lineNbr": 374,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-08T22:34:36Z",
      "side": 1,
      "message": "+1 to Sadrul comments. Any side-effect events (e.g. SendGestureScrollEnd()) should be in the dispatch event, otherwise they could in theory use incorrect targetting information.",
      "parentUuid": "ee377906_a9adcda5",
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "97971b81_52b53b4e",
        "filename": "content/browser/renderer_host/render_widget_host_input_event_router.cc",
        "patchSetId": 4
      },
      "lineNbr": 374,
      "author": {
        "id": 1211635
      },
      "writtenOn": "2018-01-08T23:13:31Z",
      "side": 1,
      "message": "Yea, I had this updating in dispatching, but thought that this caused a site-per-process browser test failure so tried moving this up (because on TOT, we are sending a GSE even when we cannot find a target to dispatch events to, which is not the case when we put it in dispatch). However, that didn\u0027t solve the browser test failure so I reverted this and have another patch up for review now.",
      "parentUuid": "f4551089_e014032e",
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fc06e856_4a68b736",
        "filename": "content/browser/renderer_host/render_widget_host_input_event_router.cc",
        "patchSetId": 4
      },
      "lineNbr": 374,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-09T13:00:13Z",
      "side": 1,
      "message": "Then let\u0027s mark this comment as resolved.",
      "parentUuid": "97971b81_52b53b4e",
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6f7bee04_b7150667",
        "filename": "content/browser/renderer_host/render_widget_host_input_event_router.h",
        "patchSetId": 4
      },
      "lineNbr": 193,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-08T22:34:36Z",
      "side": 1,
      "message": "See comment below.",
      "range": {
        "startLine": 193,
        "startChar": 17,
        "endLine": 193,
        "endChar": 26
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "10cd5ac0_8c775810",
        "filename": "content/browser/renderer_host/render_widget_host_input_event_router.h",
        "patchSetId": 4
      },
      "lineNbr": 204,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-08T22:34:36Z",
      "side": 1,
      "message": "Do we really need to propagate this? Why not just delay the coordinate conversion until inside the DispatchMouseWheelEvent function, using root_view-\u003eTransformPointToCoordSpaceForView(..., target, ...)?",
      "range": {
        "startLine": 204,
        "startChar": 37,
        "endLine": 204,
        "endChar": 42
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "87ec0b8c_69693d99",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 80,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-08T22:34:36Z",
      "side": 1,
      "message": "Would it be simpler to send the WheelEventAck from inside the dispatch function inside RWHIER?",
      "range": {
        "startLine": 80,
        "startChar": 4,
        "endLine": 80,
        "endChar": 6
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b19f5f76_ce02f19f",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 80,
      "author": {
        "id": 1211635
      },
      "writtenOn": "2018-01-08T23:13:31Z",
      "side": 1,
      "message": "We do an early return here tho, so it won\u0027t reach dispatching. And there seems to be no easy way to do that in RouteMouseWheelEvent because we also early return if events are put in the queue. WDYT?",
      "parentUuid": "87ec0b8c_69693d99",
      "range": {
        "startLine": 80,
        "startChar": 4,
        "endLine": 80,
        "endChar": 6
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7049ad7d_22825ad4",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 80,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-09T13:00:13Z",
      "side": 1,
      "message": "I suppose, though you don\u0027t have to do an early return ... you could dispatch the event, and have the dispatcher do the Ack when it sees the null target.",
      "parentUuid": "b19f5f76_ce02f19f",
      "range": {
        "startLine": 80,
        "startChar": 4,
        "endLine": 80,
        "endChar": 6
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "319990fd_4312e2d6",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 80,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-09T14:10:28Z",
      "side": 1,
      "message": "Perhaps a better way of explaining what I\u0027m thinking is this: when there\u0027s no target, it should be up to the delegate (and not this class) to decide what should happen to the event. So if you just dispatch the event back to the delegate with a null target, it can decide what to do.\n\nFor example, for touch events, the target is set by the *first* touch start in a sequence. All subsequent touch events until the final TouchEnd/Cancel will not even be hit-tested by the delegate ... rather it will send back a null target, *and* indicate false for |should_query_view|. When the events are dispatched to it with null targets, it will know to handle them using the target found for the initial TouchStart.\n\nIn the touch case it\u0027s essential that the delegate has this control; it seems that we should do this consistently for all event types.",
      "parentUuid": "7049ad7d_22825ad4",
      "range": {
        "startLine": 80,
        "startChar": 4,
        "endLine": 80,
        "endChar": 6
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "036a0248_f01cb51b",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 80,
      "author": {
        "id": 1001433
      },
      "writtenOn": "2018-01-09T16:48:24Z",
      "side": 1,
      "message": "I agree with James, it seems like simpler model if we guarantee a callback to the RWHIER after it requests dispatch, so it can handle the errors. Calling FoundTarget with a null view feels a bit weird but it better encapsulates the event handling logic.",
      "parentUuid": "319990fd_4312e2d6",
      "range": {
        "startLine": 80,
        "startChar": 4,
        "endLine": 80,
        "endChar": 6
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "83103369_2287583e",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 80,
      "author": {
        "id": 1211635
      },
      "writtenOn": "2018-01-09T21:45:36Z",
      "side": 1,
      "message": "Thanks for the detailed explanation! I added EventAckNoTarget to RenderWidgetTargeter::Delegate and moved the ack code to RWHIER.",
      "parentUuid": "036a0248_f01cb51b",
      "range": {
        "startLine": 80,
        "startChar": 4,
        "endLine": 80,
        "endChar": 6
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bfed2cb6_9c4d9514",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 190,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-08T22:34:36Z",
      "side": 1,
      "message": "Instead of propagating this delta all the way back, why not send the point back in root_view coords, and do a single call to root_view-\u003eTransformPointToCoordSpaceForView() inside RWHIER? This has the advantage of being a more general transform than a simple offset.",
      "range": {
        "startLine": 190,
        "startChar": 24,
        "endLine": 190,
        "endChar": 29
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d00c7ab4_c07bf382",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 190,
      "author": {
        "id": 1211635
      },
      "writtenOn": "2018-01-08T23:13:31Z",
      "side": 1,
      "message": "The point can be transformed by other function as well (e.g. FindViewAtLocation in RWHIER) other than TransformPointToCoordSpaceForView(), so I think we still need to pass back the result |target_location| in DispatchEventToTarget if we want to do the conversion in RWHIER. Did I misunderstand your proposal?",
      "parentUuid": "bfed2cb6_9c4d9514",
      "range": {
        "startLine": 190,
        "startChar": 24,
        "endLine": 190,
        "endChar": 29
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "12a300f3_dc5c299c",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 190,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-09T13:00:13Z",
      "side": 1,
      "message": "I\u0027m only interested in the value passed to DispatchEventToTarget(). If it has the root view, the target view, and the *original* event location, then it can do the transformation itself without needing the delta parameter at all. Up until this point the original event has had its PositionInWidget() left unchanged, and if you continue to leave it unchanged then you don\u0027t need the delta parameter, you can just do the final transformation in DispatchMouseWheelEvent().",
      "parentUuid": "d00c7ab4_c07bf382",
      "range": {
        "startLine": 190,
        "startChar": 24,
        "endLine": 190,
        "endChar": 29
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "56867044_c474adc6",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 190,
      "author": {
        "id": 1211635
      },
      "writtenOn": "2018-01-09T21:45:36Z",
      "side": 1,
      "message": "I talked with Sadrul offline and he found that we can compute the delta in DispatchMouseWheelEvent instead of in here. WDYT computing the delta in DispatchMouseWheelEvent (it\u0027s not a common case), keeping the position conversion code here unchanged and looking into a cleanup later?",
      "parentUuid": "12a300f3_dc5c299c",
      "range": {
        "startLine": 190,
        "startChar": 24,
        "endLine": 190,
        "endChar": 29
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0c9fa122_3389407e",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 190,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-09T21:56:32Z",
      "side": 1,
      "message": "I\u0027m not quite sure I follow ... the delta is what allows the point conversion, but DispatchMouseWheelEvent comes *after* this point. How would that work? I\u0027m happy to meet in person if that helps.",
      "parentUuid": "56867044_c474adc6",
      "range": {
        "startLine": 190,
        "startChar": 24,
        "endLine": 190,
        "endChar": 29
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "92b6185d_5f9265c2",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 190,
      "author": {
        "id": 1211635
      },
      "writtenOn": "2018-01-09T22:51:28Z",
      "side": 1,
      "message": "This delta is kept track in wheel_target_.delta in RWHIER and was updated in DispatchMouseWheelEvent. By \"position conversion\", I meant keeping \"mouse_wheel_event.SetPositionInWidget\" in line 191 in this function (the newest patchset includes these changes). Could you explain what \"the delta is what allows the point conversion\" means?",
      "parentUuid": "0c9fa122_3389407e",
      "range": {
        "startLine": 190,
        "startChar": 24,
        "endLine": 190,
        "endChar": 29
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ead3e7d8_658e9221",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 190,
      "author": {
        "id": 1212389
      },
      "writtenOn": "2018-01-10T13:47:11Z",
      "side": 1,
      "message": "In the wheel-latching context, \u0027delta\u0027 is the offset between the coordinate of the phaseBegin wheel event in root-view coordinates, and its coordinates in the view that the event ultimately gets targeted to. Computing delta has been used in the past as an inexpensive way to update the root-view coordinates of the remaining wheels in the sequence to match.\n\nAnd that worked fine with synchronous hit testing. But imagine the following, asynchronous scenario: the phaseBegin wheel arrives, and is given a target. But we have to wait until the the final target assignment is made before computing delta (which could be a while if we have to make a round-trip to the renderer). In the meantime more wheels come in, and there is no value of delta to give them ...\n\nIn this CL as it stands, you are using delta in FindWheelEventTarget to transform the incoming event, even though it may not have been properly initialized for the phaseBegin final target. And when wheel_target_.target is set to null, there is no corresponding reset of wheel_target_.delta, meaning we\u0027ll be using a stale value.\n\nThis means we can\u0027t safely adjust the remaining wheel event\u0027s coordinates until they are Dispatched.\n\nHowever, there\u0027s an easy fix for this. Don\u0027t alter the coordinates of the wheelevents until they are dispatched, i.e. DispatchMouseWheelEvent() receives the event with root_view coordinates still intact. Then, since we know the event\u0027s root_view coordinates and the *final* target, it\u0027s possible to use root_view-\u003eTransformPointToCoordinateSpaceForView(root_coord_point, target_view, \u0026target_coord_point).\n\nThis approach has the added benefit that, if the transform between the root and target view is changing (e.g. animation, etc.), then each event can be transformed according to the best information we have at the time.",
      "parentUuid": "92b6185d_5f9265c2",
      "range": {
        "startLine": 190,
        "startChar": 24,
        "endLine": 190,
        "endChar": 29
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2a24e8d4_4c831597",
        "filename": "content/browser/renderer_host/render_widget_targeter.cc",
        "patchSetId": 4
      },
      "lineNbr": 190,
      "author": {
        "id": 1211635
      },
      "writtenOn": "2018-01-10T17:36:18Z",
      "side": 1,
      "message": "Thanks for the explanation! As discussed offline, removed wheel_target_.delta and moved the position conversion to be in dispatch.",
      "parentUuid": "ead3e7d8_658e9221",
      "range": {
        "startLine": 190,
        "startChar": 24,
        "endLine": 190,
        "endChar": 29
      },
      "revId": "50b3770b6298f353a15d977607d45f45b081ae76",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "c656c4ff_966dd2a9",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 32,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T00:29:52Z",
      "side": 1,
      "message": "Does this only initialize the first vector of the array? Or does it initialize the whole array to that vector?\n\nI seem to recall C copies the last element and continue to initialize using that last element. But it is a bit hazy to me.\n\n\n\nTerminology clarification for those following along:\nuint32x2_t would be a SIMD register that represents 2x 32-bit uints. This is called a vector. That same SIMD register (with the same number of bits) can instead represent 8x 8-bit uints, making uint8x8_t.\nBut you\u0027ll notice the type is uint8x8x4_t. This is an array of vectors. Said another way, it represents multiple SIMD registers. This is useful if you want to do something like \"Fill this vector with the first value in those 4 vectors\". Or it can be useful for what we are doing here: Loading and storing the large chunks.",
      "range": {
        "startLine": 32,
        "startChar": 6,
        "endLine": 32,
        "endChar": 27
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "69c00e21_43fb4c93",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 32,
      "author": {
        "id": 1193769
      },
      "writtenOn": "2017-12-13T00:44:04Z",
      "side": 1,
      "message": "Awkwardly, uint8x8x4_t is a struct containing a single uint8x8_t[4] array.\n\nC\u0027s kind of lax about how initialization can be expressed.  Some good compilers will warn you to write it this way to make it clear how the layout is structured:\n\nuint8x8x4_t w \u003d {{\n   { 0,0,0,0, 0,0,0 },\n}};\n\nAn extra set of braces, the outer ones for the struct, the middles ones for its single array member, and the very inner ones for each vector.\n\nNow, I think this will happen to all work as intended, because if you initialize some fields but not others in C, they rest are byte zeroed.  But there are a couple things we can do here to write this more clearly...\n\n1) probably initialize all 8 bytes to zero instead of just the first 7.  I find that writing this with a little space between groups of 4 helps the correct count stand out: { 0,0,0,0, 0,0,0,0 }.\n2) zero initialize w.val[0-2] all explicitly, or even all of [0-3].  The last redundant-seeming initialization will probably not actually cause any extra code generation, given the w.val[3] \u003d vdup_n_u8(0xff);\n\nI think we can probably write all this as\n\nuint8x8x4_t w \u003d {\n  vdup_n_u8(0x00),\n  vdup_n_u8(0x00),\n  vdup_n_u8(0x00),\n  vdup_n_u8(0xff),\n};",
      "parentUuid": "c656c4ff_966dd2a9",
      "range": {
        "startLine": 32,
        "startChar": 6,
        "endLine": 32,
        "endChar": 27
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9f2dd7c9_63a51e52",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 32,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "Actually, only w.val[3] needs to be initialised (0, 1, 2 are overwritten), I will likely change it to\n\n    uint8x8x4_t w;\n    w.val[3] \u003d vdup_n_u8(0xff);\n\nin the next patchset.",
      "parentUuid": "69c00e21_43fb4c93",
      "range": {
        "startLine": 32,
        "startChar": 6,
        "endLine": 32,
        "endChar": 27
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "23439140_34eb2a84",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 32,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T23:24:48Z",
      "side": 1,
      "message": "Oh, I didn\u0027t even count the 7. I assumed 8, and that it might either zero-fill or duplicate w.val[0] into w.val[1] and [2].\n\nBut I like your idea to explicitly initialize each vector with vdup_n_u8() (or just vector 3).",
      "parentUuid": "69c00e21_43fb4c93",
      "range": {
        "startLine": 32,
        "startChar": 6,
        "endLine": 32,
        "endChar": 27
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "790c8bd9_f532df98",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 32,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-18T19:05:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "23439140_34eb2a84",
      "range": {
        "startLine": 32,
        "startChar": 6,
        "endLine": 32,
        "endChar": 27
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f457a950_d32c3684",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 38,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T00:29:52Z",
      "side": 1,
      "message": "I really like these comments. It makes the whole function much easier to follow.",
      "range": {
        "startLine": 37,
        "startChar": 3,
        "endLine": 38,
        "endChar": 27
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7b7d6aa2_1f17e9bd",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 38,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "f457a950_d32c3684",
      "range": {
        "startLine": 37,
        "startChar": 3,
        "endLine": 38,
        "endChar": 27
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fca7e4b4_c4aabdac",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 64,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T00:29:52Z",
      "side": 1,
      "message": "missing period",
      "range": {
        "startLine": 64,
        "startChar": 69,
        "endLine": 64,
        "endChar": 70
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "95e23027_f9e55277",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 64,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "fca7e4b4_c4aabdac",
      "range": {
        "startLine": 64,
        "startChar": 69,
        "endLine": 64,
        "endChar": 70
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9d686776_7bebdc1f",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 64,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-18T19:05:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "95e23027_f9e55277",
      "range": {
        "startLine": 64,
        "startChar": 69,
        "endLine": 64,
        "endChar": 70
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4a2f59da_a54fe089",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 68,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T00:29:52Z",
      "side": 1,
      "message": "Just double checking...the comment says 16 but this value is 15. Is this a typo? If not, should the comment explain why?",
      "range": {
        "startLine": 68,
        "startChar": 20,
        "endLine": 68,
        "endChar": 22
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7132bdfe_d1eb3641",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 68,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "Yeah, the weird corrections are mostly because the original code (in pngrtran.c) processes the PNG row backwards. This is (presumably) to save memory (because the output can then overwrite the input in the same buffer). However, for NEON, we have to write things out forwards in chunks of 16 bytes, so it needs to seek back a little to get started. The original code also computes the dp pointer as the last valid offset in the buffer (so for example, if the row was 16 bytes long, this method would receive the value 15).",
      "parentUuid": "4a2f59da_a54fe089",
      "range": {
        "startLine": 68,
        "startChar": 20,
        "endLine": 68,
        "endChar": 22
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8324166a_3d9f6530",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 68,
      "author": {
        "id": 1145695
      },
      "writtenOn": "2017-12-13T23:40:09Z",
      "side": 1,
      "message": "Maybe use a const variable/macro to store the value with a descriptive name?",
      "parentUuid": "7132bdfe_d1eb3641",
      "range": {
        "startLine": 68,
        "startChar": 20,
        "endLine": 68,
        "endChar": 22
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8d45db49_55b2928b",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 68,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-18T19:05:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8324166a_3d9f6530",
      "range": {
        "startLine": 68,
        "startChar": 20,
        "endLine": 68,
        "endChar": 22
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2af56cc1_2e72eeb2",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 79,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T00:29:52Z",
      "side": 1,
      "message": "Below, you have sp - 0 which vertically aligns the code. I like that.\nHere, without the \"- 0\" the code isn\u0027t vertically aligned.\n\nYou can choose which ever method you prefer. Consistency is probably the more important part. But I would like to nudge the \"- 0\" to be here as well. :D",
      "range": {
        "startLine": 79,
        "startChar": 47,
        "endLine": 79,
        "endChar": 49
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fbdfa02f_2ad9b785",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 79,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "2af56cc1_2e72eeb2",
      "range": {
        "startLine": 79,
        "startChar": 47,
        "endLine": 79,
        "endChar": 49
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0fc6858a_7e2fcb75",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 79,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-18T19:05:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "fbdfa02f_2ad9b785",
      "range": {
        "startLine": 79,
        "startChar": 47,
        "endLine": 79,
        "endChar": 49
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8d02a5ba_364a517c",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 84,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T00:29:52Z",
      "side": 1,
      "message": "Because this can overshoot, do we know that the destination is allocated to allow this extra padding?",
      "range": {
        "startLine": 82,
        "startChar": 3,
        "endLine": 84,
        "endChar": 4
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ff696927_51ccbd4f",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 84,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "That\u0027s a good point, this is missing a return 0 case for when the row has \u003c 4 pixels in it, but it happens to work because the destination buffer is the source buffer, which (which, because the output must be 4x the size of the input) will have space for the result. What this will mean in practise is that one or more of the cur \u003d vld1q loads above will read a random 0-255 indexed value from the 8-bit palette, which is then fixed up by the code used to process the tail elements.",
      "parentUuid": "8d02a5ba_364a517c",
      "range": {
        "startLine": 82,
        "startChar": 3,
        "endLine": 84,
        "endChar": 4
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "17c462a5_bf8e6edb",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 84,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-18T19:05:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ff696927_51ccbd4f",
      "range": {
        "startLine": 82,
        "startChar": 3,
        "endLine": 84,
        "endChar": 4
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "67138c49_da0a4921",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 102,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "Also needs an additional return case.",
      "range": {
        "startLine": 101,
        "startChar": 0,
        "endLine": 102,
        "endChar": 24
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ffebfb92_3a08df81",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 102,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-18T19:05:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "67138c49_da0a4921",
      "range": {
        "startLine": 101,
        "startChar": 0,
        "endLine": 102,
        "endChar": 24
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "661c78c4_b47a21fa",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 104,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T00:29:52Z",
      "side": 1,
      "message": "Same here. We go back 23 bytes instead of 24. So I assume this is intentional.",
      "range": {
        "startLine": 104,
        "startChar": 20,
        "endLine": 104,
        "endChar": 22
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e69209bd_511a1349",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 104,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "As above, the dp pointer is originally calculated as `dp \u003d row + (png_size_t)(row_width * 3) - 1;`",
      "parentUuid": "661c78c4_b47a21fa",
      "range": {
        "startLine": 104,
        "startChar": 20,
        "endLine": 104,
        "endChar": 22
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4c346531_523e8946",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 104,
      "author": {
        "id": 1145695
      },
      "writtenOn": "2017-12-13T23:40:09Z",
      "side": 1,
      "message": "Maybe use a const variable to store the value with a descriptive name?",
      "parentUuid": "e69209bd_511a1349",
      "range": {
        "startLine": 104,
        "startChar": 20,
        "endLine": 104,
        "endChar": 22
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ed0bdb4e_850b7718",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 104,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-18T19:05:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "4c346531_523e8946",
      "range": {
        "startLine": 104,
        "startChar": 20,
        "endLine": 104,
        "endChar": 22
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "203b4271_573ca2d5",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 119,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T00:29:52Z",
      "side": 1,
      "message": "I don\u0027t fully understand this.\nThe dup line will fill the 3-element array of 8x 8-bit vectors with one palette color.\nThen the lane lines fill the other lanes with the other palette colors.\n\nSo right before the vst3 line, we have a 3-element array filled with the same palette colors.\n\nIt seems to me that we are operating on 8 pixels at a time and don\u0027t need a 3-element array of 8 pixels. It seems like it writes out 3x 8 pixels, increments 8 pixels, and next iteration overwrites the latter 2x 8 pixel chunks.\n\nSo it seems like this doesn\u0027t need to be an array of vectors. It seems like we could only operate on a vector.",
      "range": {
        "startLine": 107,
        "startChar": 3,
        "endLine": 119,
        "endChar": 4
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "caeebab3_695d9a9f",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 119,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "\u003e The dup line will fill the 3-element array of 8x 8-bit vectors with one palette color.\n\u003e Then the lane lines fill the other lanes with the other palette colors.\n\u003e \n\u003e So right before the vst3 line, we have a 3-element array filled with the same palette colors.\n\u003e \n\nYeah, I admit NEON\u0027s presentation is a bit confusing, I can attempt an explanation of what this loop does:\n\n    cur \u003d vld3_dup_u8(palette + sizeof(png_color) * (*(sp - 7)));\n\nIf the sp - 7 contains an index pointing to a palette value R\u003d0xDE, G\u003d0xAD, B\u003d0xBE, then you\u0027ll end up with 3 registers for R, G and B. \n\n   r1 \u003d 0xDE DE DE DE DE DE DE DE\n   r2 \u003d 0xAD AD AD AD AD AD AD AD\n   r3 \u003d 0xBE BE BE BE BE BE BE BE\n\nThe vst3_u8 then re-interleaves them, so if I stored the three registers above, I\u0027d end up with this in memory:\n\n   0xDEADBE 0xDEADBE ...\n\nEach vld3_lane_u8 operation changes one column, across the three three registers, so the loop eventually loads the palette information for 8 pixels. \n\nWhat should then happen after the store is dp goes down by 24 bytes and sp (which is holding the input), goes down by 8 bytes.",
      "parentUuid": "203b4271_573ca2d5",
      "range": {
        "startLine": 107,
        "startChar": 3,
        "endLine": 119,
        "endChar": 4
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3fb0a24c_e44fa506",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 119,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T23:24:48Z",
      "side": 1,
      "message": "Oh okay. I understand the benefit of the array-of-vectors now. I misunderstood it as populating the same content in each vector.\n\nSuppose the 8 pixels of color values in the palette are (clumped into rgb) 0xDEADBE 0xEF1122 0x334455 0x667788 0x99AABB 0xCCDDEE 0xFF0001 0x234567.\nThe dup line gives us:\n   r1 \u003d 0xDE DE DE DE DE DE DE DE\n   r2 \u003d 0xAD AD AD AD AD AD AD AD\n   r3 \u003d 0xBE BE BE BE BE BE BE BE\nThe lane 1 line gives us:\n   r1 \u003d 0xDE DE DE DE DE DE EF DE\n   r2 \u003d 0xAD AD AD AD AD AD 11 AD\n   r3 \u003d 0xBE BE BE BE BE BE 22 BE\nThe lane 2 line gives us:\n   r1 \u003d 0xDE DE DE DE DE 33 EF DE\n   r2 \u003d 0xAD AD AD AD AD 44 11 AD\n   r3 \u003d 0xBE BE BE BE BE 55 22 BE\n...\nThe lane 7 line gives us:\n   r1 \u003d 0x23 FF CC 99 66 33 EF DE\n   r2 \u003d 0x45 00 DD AA 77 44 11 AD\n   r3 \u003d 0x67 01 EE BB 88 55 22 BE\n\nAt this point, we have 8 pixels with their r/g/b components in r1/r2/r3 respectively. Each lane is a pixel.\nThe vst line then writes them out.\n\nSo it seems like the main benefits here are loop unrolling and a very wide write.\n\nDereferencing (sp - x) will likely be L1 cache hits after the first.\nGetting the palette color value will likely be a cache miss until all of the palette cache lines are hit. The prefetcher may help here. But some weaker ARM chips list their prefetcher as only activating after enough successive requests in the same direction with the same stride. We likely won\u0027t fulfill that requirement.\n\n(256 palette entries max in PNG, with RGBA \u003d 256 * 4 bytes \u003d 1024 bytes. Typical cache lines are 64 bytes. 1024 bytes / 64 bytes \u003d 16 cache lines for the whole palette. 17 if not cache line aligned.)\n\n\nI think I follow now.\n\nIf you want to go to crazy-town, you can measure before and after using __builtin_prefetch() to pull in the palette cache lines. At best, it will only turn 16/17 cache misses into 16/17 cache hits. That\u0027s not a ton of difference, since the loop body will be all hits after the initial misses. So it might not be worth while so don\u0027t feel obligated to.\n\nThank you for helping me follow.",
      "parentUuid": "caeebab3_695d9a9f",
      "range": {
        "startLine": 107,
        "startChar": 3,
        "endLine": 119,
        "endChar": 4
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "863e2c42_9ece3ab5",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 119,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-18T19:05:38Z",
      "side": 1,
      "message": "Yeah, I thought hard about using __builtin_prefetch, but I observed that in most PNGs, each row will contain large blocks with a single colour, so prefetching the entire palette is likely unnecessary.",
      "parentUuid": "3fb0a24c_e44fa506",
      "range": {
        "startLine": 107,
        "startChar": 3,
        "endLine": 119,
        "endChar": 4
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "83830873_83e84b0e",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 122,
      "author": {
        "id": 1145695
      },
      "writtenOn": "2017-12-13T23:40:09Z",
      "side": 1,
      "message": "Maybe use a const variable to store the value with a descriptive name?",
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f65db3d3_6482e511",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 122,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-18T19:05:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "83830873_83e84b0e",
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "866b1504_6d6162af",
        "filename": "third_party/libpng/arm/palette_neon_intrinsics.c",
        "patchSetId": 4
      },
      "lineNbr": 122,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-18T19:05:38Z",
      "side": 1,
      "message": "Variable corrected to 8 in the next patchset.",
      "range": {
        "startLine": 122,
        "startChar": 11,
        "endLine": 122,
        "endChar": 12
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c9efa5b4_89f2865c",
        "filename": "third_party/libpng/patches/README",
        "patchSetId": 4
      },
      "lineNbr": 2,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T00:29:52Z",
      "side": 1,
      "message": "Can probably drop the word \"at\" here.",
      "range": {
        "startLine": 2,
        "startChar": 39,
        "endLine": 2,
        "endChar": 41
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d1cade2e_41bad1fb",
        "filename": "third_party/libpng/patches/README",
        "patchSetId": 4
      },
      "lineNbr": 2,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "c9efa5b4_89f2865c",
      "range": {
        "startLine": 2,
        "startChar": 39,
        "endLine": 2,
        "endChar": 41
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "44fd203a_d4013931",
        "filename": "third_party/libpng/pngrtran.c",
        "patchSetId": 4
      },
      "lineNbr": 4323,
      "author": {
        "id": 1189229
      },
      "writtenOn": "2017-12-13T00:29:52Z",
      "side": 1,
      "message": "Just to help me understand, ...\n\nElsewhere--before we get here--we\u0027re checking whether or not to use the new riffling code. And that riffling code would have correctly allocated png_ptr-\u003erow_tmp_palette.\n\nMaybe between where the riffling happens and here png_ptr-\u003ebit_depth is changed to 8?\n\nMy question is really whether or not there is a better check available here. It seems to depend on far off behavior.",
      "range": {
        "startLine": 4321,
        "startChar": 18,
        "endLine": 4323,
        "endChar": 72
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "51bf5155_843acd7d",
        "filename": "third_party/libpng/pngrtran.c",
        "patchSetId": 4
      },
      "lineNbr": 4323,
      "author": {
        "id": 1177474
      },
      "writtenOn": "2017-12-13T19:30:55Z",
      "side": 1,
      "message": "Ack - the ultimate check is whether a riffled palette is available, but because png_ptr is now available, you could (in theory) substitute png_ptr-\u003ebit_depth \u003d\u003d 8. I chose not to do so because of png_free (which sets the palette to NULL), just in case there are other call routes into this function.",
      "parentUuid": "44fd203a_d4013931",
      "range": {
        "startLine": 4321,
        "startChar": 18,
        "endLine": 4323,
        "endChar": 72
      },
      "revId": "643741c4739100b9e8a1fdad44f1b6722b1e18b5",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
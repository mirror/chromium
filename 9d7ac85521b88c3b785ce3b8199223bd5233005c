{
  "comments": [
    {
      "key": {
        "uuid": "e102d7e3_501717c4",
        "filename": "chrome/browser/chrome_network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 67,
      "author": {
        "id": 1115968
      },
      "writtenOn": "2017-11-09T20:43:07Z",
      "side": 1,
      "message": "Should also test g_browser_process()-\u003esystem_network_context_manager()\u0027s NetworkContext.",
      "range": {
        "startLine": 67,
        "startChar": 23,
        "endLine": 67,
        "endChar": 60
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0353d055_5b6b06e1",
        "filename": "chrome/browser/chrome_network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 67,
      "author": {
        "id": 1166494
      },
      "writtenOn": "2017-11-09T21:37:37Z",
      "side": 1,
      "message": "I was planning to patch other |NetworkContext| providers in several CLs to keep each CL smaller, but sure I can change this CL to cover all |NetworkContext| providers if that could make the logic cleaner.",
      "parentUuid": "e102d7e3_501717c4",
      "range": {
        "startLine": 67,
        "startChar": 23,
        "endLine": 67,
        "endChar": 60
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "09376f5d_95b9e8bf",
        "filename": "chrome/browser/chrome_network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 67,
      "author": {
        "id": 1115968
      },
      "writtenOn": "2017-11-09T23:28:46Z",
      "side": 1,
      "message": "That\u0027s actually the only other NetworkContext backed by the NetworkService, currently (Well, there are incognito ones, but I\u0027m not too concerned about those, since they pass through the same path as the non-incognito ones that this code tests).\n\nIts configuration has more in common with the NetworkContext returned in this file\u0027s partition-\u003eGetNetworkContext() than it does with the one returned by the content_browsertest\u0027s partition-\u003eGetNetworkContext().",
      "parentUuid": "0353d055_5b6b06e1",
      "range": {
        "startLine": 67,
        "startChar": 23,
        "endLine": 67,
        "endChar": 60
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "268d3615_208911e8",
        "filename": "chrome/browser/chrome_network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 67,
      "author": {
        "id": 1166494
      },
      "writtenOn": "2017-11-10T00:16:27Z",
      "side": 1,
      "message": "I see, I must got confused with some IOThread and Profile stuff. Will patch |system_network_context_manager| and see if I can run \"network_context_configuration_browsertest.cc\" with a restarted Network Service.",
      "parentUuid": "09376f5d_95b9e8bf",
      "range": {
        "startLine": 67,
        "startChar": 23,
        "endLine": 67,
        "endChar": 60
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "809e7fbb_8f83cfa7",
        "filename": "chrome/browser/chrome_network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 85,
      "author": {
        "id": 1115968
      },
      "writtenOn": "2017-11-09T20:43:07Z",
      "side": 1,
      "message": "I\u0027m rather surprised this works - I want to dig into this a little myself to better understand it.",
      "range": {
        "startLine": 85,
        "startChar": 38,
        "endLine": 85,
        "endChar": 47
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "319c2523_2052b88d",
        "filename": "chrome/browser/chrome_network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 85,
      "author": {
        "id": 1166494
      },
      "writtenOn": "2017-11-09T21:37:37Z",
      "side": 1,
      "message": "Sure. It feels to me that we are only retrieving some info from Profile while setting up new NetworkContext.",
      "parentUuid": "809e7fbb_8f83cfa7",
      "range": {
        "startLine": 85,
        "startChar": 38,
        "endLine": 85,
        "endChar": 47
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "85675653_dba2e232",
        "filename": "content/browser/network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 52,
      "author": {
        "id": 1115968
      },
      "writtenOn": "2017-11-09T20:43:07Z",
      "side": 1,
      "message": "I think these tests may be racy - are we guaranteed that the network context pipe has noticed that it\u0027s been shut down by the time FlushForTesting() completes?  We may have to call FlushForTesting() on the NetworkContext, too.  That will either get the new NetworkContext, and do basically nothing, or get the old NetworkContext, and wait until it crashes.  Or are we guaranteed that we learn about the NetworkContext\u0027s death at the same time we learn about the NetworkServiceTest\u0027s death?",
      "range": {
        "startLine": 52,
        "startChar": 43,
        "endLine": 52,
        "endChar": 0
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6b3e1711_a9990a76",
        "filename": "content/browser/network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 52,
      "author": {
        "id": 1166494
      },
      "writtenOn": "2017-11-09T21:37:37Z",
      "side": 1,
      "message": "My understanding is that |NetworkContext| pipe won\u0027t notice it\u0027s death until one of:\n  1. network_context.FlushForTesting(), or\n  2. LoadBasicRequest(network_context)\nwas called.\n\nMy tests are relying on |LoadBasicRequest()|, where |NetworkContext| pipe could still be open at first, but the connection will eventually fail and |SimpleURLLoader| will handle connection error as |net::ERR_FAILED|.\n\nDoes that make sense?",
      "parentUuid": "85675653_dba2e232",
      "range": {
        "startLine": 52,
        "startChar": 43,
        "endLine": 52,
        "endChar": 0
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "596a4cc6_ecc2d0dc",
        "filename": "content/browser/network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 52,
      "author": {
        "id": 1115968
      },
      "writtenOn": "2017-11-09T21:54:02Z",
      "side": 1,
      "message": "It does, though I\u0027m not sure its accurate.  Namely, I\u0027m not sure if the NetworkContext\u0027s notices if the pipe is closed by a crash.  I suspect it is.  Regardless of that, though, I\u0027m now convinced that NetworkServiceProcessRecovery is non-racy.  I\u0027m not sure about the other test, however.",
      "parentUuid": "6b3e1711_a9990a76",
      "range": {
        "startLine": 52,
        "startChar": 43,
        "endLine": 52,
        "endChar": 0
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "04c683d1_ed65655e",
        "filename": "content/browser/network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 52,
      "author": {
        "id": 1166494
      },
      "writtenOn": "2017-11-09T23:11:16Z",
      "side": 1,
      "message": "Regarding \"notices if the pipe is closed by a crash\": I\u0027m not exactly sure how it works, but it feels like there is nothing I can do other than trusting the API...\n\nAdded the concern to the design doc though (See link below).",
      "parentUuid": "596a4cc6_ecc2d0dc",
      "range": {
        "startLine": 52,
        "startChar": 43,
        "endLine": 52,
        "endChar": 0
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ac6f2210_f3cf8ca4",
        "filename": "content/browser/network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 93,
      "author": {
        "id": 1166494
      },
      "writtenOn": "2017-11-09T21:37:37Z",
      "side": 1,
      "message": "|encountered_error()| would be false if I don\u0027t run |LoadBasicRequest()| or |network_context.FlushForTesting()| first.",
      "range": {
        "startLine": 93,
        "startChar": 30,
        "endLine": 93,
        "endChar": 47
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "86105bae_84b96f09",
        "filename": "content/browser/network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 115,
      "author": {
        "id": 1115968
      },
      "writtenOn": "2017-11-09T21:54:02Z",
      "side": 1,
      "message": "SimulateNetworkServiceCrash spins the RunLoop...So if anything else touches partition-\u003eGetNetworkContext() in the mean time, there\u0027s a chance we\u0027ll notice it was destroyed and make a new one.  That would result in deleting network_context, and lead to a use-after-free crash.\n\nI don\u0027t think this is an issue with the above test, because we own the NetworkContextPtr (And you\u0027re right about why there\u0027s no race).",
      "range": {
        "startLine": 115,
        "startChar": 29,
        "endLine": 115,
        "endChar": 30
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9b10bbf7_c12537c3",
        "filename": "content/browser/network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 115,
      "author": {
        "id": 1166494
      },
      "writtenOn": "2017-11-09T23:11:16Z",
      "side": 1,
      "message": "Just to make sure I understand your concern correctly:\nYou are saying in production, it\u0027s possible that we decided to restart and delete old |network_context|, while clients are still holding the raw |mojom::NetworkContext*|. In this case the code won\u0027t crash before CL (e.g. Clients are just accessing an invalid interface), but will crash after CL since it\u0027s an invalid pointer now.\n\nI\u0027m not sure how to avoid this issue, but it feels to me that the possibly is very low and doesn\u0027t overcome the benefits of having a restartable Network Service.\n\nI\u0027ve added this concern to the design doc for future investigation, or would you suggest we solve this issue now?\nhttps://docs.google.com/document/d/14dQpOaPgnpX0TZffSGeYyE-dUS93HY06VKGWUGZHtrY/edit#heading\u003dh.69flrjb783dm",
      "parentUuid": "86105bae_84b96f09",
      "range": {
        "startLine": 115,
        "startChar": 29,
        "endLine": 115,
        "endChar": 30
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6b134419_12c66b1c",
        "filename": "content/browser/network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 115,
      "author": {
        "id": 1115968
      },
      "writtenOn": "2017-11-09T23:24:17Z",
      "side": 1,
      "message": "Not quite.  I\u0027m concerned that this code is holding onto a raw mojom::NetworkContext*.  Since SimulateNetworkCrash both crashes the other process, and spins the MessageLoop, it\u0027s possible that if anything else tries to make a network request (Or do anything else network related) that a new NetworkContextPtr will be created, and our own mojom::NetworkContext* will be invalidated.\n\nSo the bug is actually in this test itself, not in other clients.\n\n\n\n\nEven with that aside...I\u0027m once again a bit worried about the other test (Once again).  The ERR_FAILED LoadBasicRequest creates a URLLoader from the NetworkContext.  Then when the URLLoader pipe is closed, fails the request.  I\u0027m not sure if we\u0027re guaranteed that we\u0027ll notice the URLLoader pipe fails to be created strictly after the NetworkContext starts exposing to consumers the fact that it\u0027s been disconnected.  Are there docs on this?",
      "parentUuid": "9b10bbf7_c12537c3",
      "range": {
        "startLine": 115,
        "startChar": 29,
        "endLine": 115,
        "endChar": 30
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ef9864ce_29b346c4",
        "filename": "content/browser/network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 115,
      "author": {
        "id": 1115968
      },
      "writtenOn": "2017-11-09T23:33:21Z",
      "side": 1,
      "message": "So here\u0027s my suggestion to address both issues:\n\nIn this test, create our own URLLoaderPtr, and use it for the first two requests.  Then flush partition-\u003eGetNetworkContext().  Then run a request with a new URLLoaderPtr.  Test should not be racy.\n\nIn the other test, you could do the same thing, but the only important new thing is to flush the network_context.",
      "parentUuid": "6b134419_12c66b1c",
      "range": {
        "startLine": 115,
        "startChar": 29,
        "endLine": 115,
        "endChar": 30
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c6362be7_da916d17",
        "filename": "content/browser/network_service_restart_browsertest.cc",
        "patchSetId": 4
      },
      "lineNbr": 115,
      "author": {
        "id": 1166494
      },
      "writtenOn": "2017-11-10T00:16:27Z",
      "side": 1,
      "message": "I see. I didn\u0027t realize those life-cycle issues while writing the test. Will give a try on your suggestion and do more experiments.\n\nThanks for pointing out!",
      "parentUuid": "ef9864ce_29b346c4",
      "range": {
        "startLine": 115,
        "startChar": 29,
        "endLine": 115,
        "endChar": 30
      },
      "revId": "9d7ac85521b88c3b785ce3b8199223bd5233005c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
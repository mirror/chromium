{
  "comments": [
    {
      "key": {
        "uuid": "b40729f0_59ed5f53",
        "filename": "chrome/browser/page_load_metrics/observers/android_page_load_metrics_observer.cc",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1136769
      },
      "writtenOn": "2017-08-28T09:47:20Z",
      "side": 1,
      "message": "let\u0027s also check for:\nextra_request_complete_info.detected_resource_type \u003d\u003d RESOURCE_TYPE_MAIN_RESOURCE\n\ni see we set main_resource_url_ in OnStart - this means we will deliver the wrong timing info for pages that have http redirects (We\u0027ll deliver the initial http redirect rather than the final committed resource). we may want to check the HTTP response code on the ExtraRequestCompleteInfo to make sure it\u0027s not a 3xx code. You can include the response code in ExtraRequestCompleteInfo, plumbing it through similarly to how you plumbed LoadTimingInfo.",
      "revId": "98303b117cef148352ace18b3599dfc107ddd28c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "95ce7b2e_58073591",
        "filename": "chrome/browser/page_load_metrics/observers/android_page_load_metrics_observer.cc",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1136769
      },
      "writtenOn": "2017-08-28T09:52:10Z",
      "side": 1,
      "message": "other option would be to set main_resource_url_ in OnCommit.",
      "parentUuid": "b40729f0_59ed5f53",
      "revId": "98303b117cef148352ace18b3599dfc107ddd28c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "59f567f6_17b13029",
        "filename": "chrome/browser/page_load_metrics/observers/android_page_load_metrics_observer.cc",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1154589
      },
      "writtenOn": "2017-08-28T10:53:28Z",
      "side": 1,
      "message": "Thanks! I had convinced myself that OnStart does the right thing w/rt redirects, but I should have added a test.\n\nI had originally used the resource_type field, but in the one test I did write, it never fired on the main resource, which is why I\u0027m using the URL.\n\nI will write a test that uses redirects and will confirm that OnCommit does the right thing.",
      "parentUuid": "95ce7b2e_58073591",
      "revId": "98303b117cef148352ace18b3599dfc107ddd28c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3f29cdbb_041d6918",
        "filename": "chrome/browser/page_load_metrics/observers/android_page_load_metrics_observer.cc",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1154589
      },
      "writtenOn": "2017-08-28T12:39:11Z",
      "side": 1,
      "message": "Okay, the reliable way to work for both redirects and regular loads is to use the resource type. The main resource load frequently (always?) comes in before OnCommit fires. PTAL",
      "parentUuid": "59f567f6_17b13029",
      "revId": "98303b117cef148352ace18b3599dfc107ddd28c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "673e850f_10c5d4ba",
        "filename": "chrome/browser/page_load_metrics/observers/android_page_load_metrics_observer.cc",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1136769
      },
      "writtenOn": "2017-08-28T13:00:23Z",
      "side": 1,
      "message": "Great, thanks for checking!\n\nDo you know if this ends up succeeding for all redirects as well as the final resource? My suspicion is that it will fire for all, whereas I think we only want it to succeed for the final resource in a redirect chain. If that\u0027s the case we probably do want to forward the HTTP response code and only process non-3xx cases. Can we write a browsertest for this case (HTTP redirect) that verifies that the expected callback only gets invoked once, for the final resource in the chain?",
      "parentUuid": "3f29cdbb_041d6918",
      "revId": "98303b117cef148352ace18b3599dfc107ddd28c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0d9a0578_eef7bb97",
        "filename": "chrome/browser/page_load_metrics/observers/android_page_load_metrics_observer.cc",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1154589
      },
      "writtenOn": "2017-08-28T13:03:57Z",
      "side": 1,
      "message": "This only fired for the final redirect in the test according to the logs, but let me add an explicit check for that in the test and double-check.",
      "parentUuid": "673e850f_10c5d4ba",
      "revId": "98303b117cef148352ace18b3599dfc107ddd28c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0006dee9_7ca2b900",
        "filename": "chrome/browser/page_load_metrics/observers/android_page_load_metrics_observer.cc",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1136769
      },
      "writtenOn": "2017-08-28T13:13:36Z",
      "side": 1,
      "message": "Great, thanks! Could we also add a boolean member did_dispatch_on_loaded_main_resource_, setting it when we dispatch, and DCHECKing that it\u0027s false when we dispatch? That way we\u0027ll discover if this does end up firing multiple times per page load either now or after a future refactor etc.",
      "parentUuid": "0d9a0578_eef7bb97",
      "revId": "98303b117cef148352ace18b3599dfc107ddd28c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c1318daf_89b0d612",
        "filename": "chrome/browser/page_load_metrics/observers/android_page_load_metrics_observer.cc",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1154589
      },
      "writtenOn": "2017-08-29T08:25:37Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "0006dee9_7ca2b900",
      "revId": "98303b117cef148352ace18b3599dfc107ddd28c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2b4b2a7d_9ce3fc2c",
        "filename": "chrome/browser/page_load_metrics/observers/android_page_load_metrics_observer.cc",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1136769
      },
      "writtenOn": "2017-08-29T15:22:06Z",
      "side": 1,
      "message": "Thanks!\n\nOne thing I realized is that HTTP redirects are treated as being part of the same resource load, so we should really only ever get one main frame resource callback per page load, unless some resource types use the main frame type incorrectly. So I\u0027m glad we have the dcheck in place now, thanks!",
      "parentUuid": "c1318daf_89b0d612",
      "revId": "98303b117cef148352ace18b3599dfc107ddd28c",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "ddad64fd_ce589785",
        "filename": "base/message_loop/message_loop.cc",
        "patchSetId": 2
      },
      "lineNbr": 266,
      "author": {
        "id": 1001385
      },
      "writtenOn": "2018-01-06T00:42:30Z",
      "side": 1,
      "message": "Are you sure we want to include \"delayed\" tasks here? It means that the result of IsIdleForTesting() is timing-dependent, e.g. if I post a 30ms delayed task and the system is busy by the time I call IsIdleForTesting() the answer may be |false|, rather than |true|.  \n\nWhere tests rely on IsIdleForTesting(), they really need to either (a) not post any delayed tasks or (b) post them only to MessageLoops with mocked time, for it to be deterministic(*).\n\nWDYT?\n\n(*) Assuming that the test must otherwise be arranging for inter-thread task posting to be synchronized in some way, otherwise it would already be racey :)",
      "range": {
        "startLine": 264,
        "startChar": 0,
        "endLine": 266,
        "endChar": 32
      },
      "revId": "f9c93846970ae6ddd7b9cca352571bdd718ca43d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "16533b19_e6bd6e74",
        "filename": "base/message_loop/message_loop.cc",
        "patchSetId": 2
      },
      "lineNbr": 266,
      "author": {
        "id": 1001534
      },
      "writtenOn": "2018-01-06T20:05:26Z",
      "side": 1,
      "message": "Agreed that these conditions make a test racy. I\u0027m already not a fan of this check though and think tests using it have better alternative, especially if they\u0027re playing with delayed tasks.\n\nThis test has been wrong for years IMO so this change merely highlights poorly written tests that were testing this when not necessary/inappropriate.\n\nAs I mentioned @ https://chromium-review.googlesource.com/c/chromium/src/+/853143, we do want to include delayed tasks so that this maps to \"RunUntilIdle() will not do work\".",
      "parentUuid": "ddad64fd_ce589785",
      "range": {
        "startLine": 264,
        "startChar": 0,
        "endLine": 266,
        "endChar": 32
      },
      "revId": "f9c93846970ae6ddd7b9cca352571bdd718ca43d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "db40c91a_e34d4e8c",
        "filename": "base/message_loop/message_loop.cc",
        "patchSetId": 2
      },
      "lineNbr": 266,
      "author": {
        "id": 1001385
      },
      "writtenOn": "2018-01-06T21:08:56Z",
      "side": 1,
      "message": "What is the use-case for the precise RunUntilIdle() equivalence, though?\n\nWith delayed tasks included this API is inherently racey (since there is no mock time for MessageLoop) so it feels like something of a footgun, especially if we\u0027re using OS level thread priorities as well.\n\nWith regard to the tests using this call, the specific one that is failing is only failing because of the change to the semantics of IsIdleForTesting() - previously the test passed reliably because it was checking whether anyone had posted new work to the MessageLoop, ignoring any pre-existing work in that message loop.\n\nIt sounds like we should revert this until the affected tests can be cleaned up. We can provide a separate call with the new semantics just for ScopedTaskEnvironment to use, alongside the existing version, with suitable comments and follow-up to clean up.",
      "parentUuid": "16533b19_e6bd6e74",
      "range": {
        "startLine": 264,
        "startChar": 0,
        "endLine": 266,
        "endChar": 32
      },
      "revId": "f9c93846970ae6ddd7b9cca352571bdd718ca43d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "9a35de91_73f1f19b",
        "filename": "device/hid/hid_service.cc",
        "patchSetId": 4
      },
      "lineNbr": 62,
      "author": {
        "id": 1113896
      },
      "writtenOn": "2017-08-17T21:47:55Z",
      "side": 0,
      "message": "The reason for this PostTask is to disallow reentrancy into functions that call GetDevices since now it will sometimes be called synchronously and sometimes asynchronously. That makes it more difficult for callers.",
      "range": {
        "startLine": 61,
        "startChar": 0,
        "endLine": 62,
        "endChar": 50
      },
      "revId": "db1c9d4dcb35ed27e7c5b7c0b7deafb1fe701adf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "960a9e30_f4e1e190",
        "filename": "device/hid/hid_service.cc",
        "patchSetId": 4
      },
      "lineNbr": 62,
      "author": {
        "id": 1177311
      },
      "writtenOn": "2017-08-18T00:21:46Z",
      "side": 0,
      "message": "As I commented above, The HidService Asynchronously runs the callback here, but Synchronously runs its observer\u0027s OnDeviceAdded()/OnDeviceRemoved(). If there was a new device-removing event be post before we post this callback, The HidDeviceManager may find its OnDeviceAdded()/OnDeviceRemoved() runs earlier than the HidDeviceManager::OnEnumerationComplete, and goes crash. WDYT?",
      "parentUuid": "9a35de91_73f1f19b",
      "range": {
        "startLine": 61,
        "startChar": 0,
        "endLine": 62,
        "endChar": 50
      },
      "revId": "db1c9d4dcb35ed27e7c5b7c0b7deafb1fe701adf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "13408062_25c016b0",
        "filename": "device/hid/hid_service.cc",
        "patchSetId": 4
      },
      "lineNbr": 62,
      "author": {
        "id": 1113896
      },
      "writtenOn": "2017-08-21T21:34:15Z",
      "side": 0,
      "message": "I see now, the right solution is to compute the device list in the posted callback instead of computing it and then posting. What we can do here is replace this function with:\n\nbool was_empty \u003d pending_enumerations_.empty();\npending_enumerations_.push_back(callback);\nif (enumeration_ready_ \u0026\u0026 was_empty) {\n  base::ThreadTaskRunnerHandle::Get()-\u003ePostTask(\n      FROM_HERE,\n      base::Bind(\u0026HidService::RunPendingEnumerations, GetWeakPtr()));\n}\n\nYou will need to add a virtual GetWeakPtr() method which is implemented by each of this classes subclasses (which already hold a WeakPtrFactory).\n\nRunPendingEnumerations should be the inside of the if statement in FirstEnumerationComplete and can be shared with this function.",
      "parentUuid": "960a9e30_f4e1e190",
      "range": {
        "startLine": 61,
        "startChar": 0,
        "endLine": 62,
        "endChar": 50
      },
      "revId": "db1c9d4dcb35ed27e7c5b7c0b7deafb1fe701adf",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
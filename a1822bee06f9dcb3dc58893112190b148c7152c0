{
  "comments": [
    {
      "key": {
        "uuid": "4d31c71f_af7125cd",
        "filename": "services/device/geolocation/public_ip_address_geolocator.cc",
        "patchSetId": 5
      },
      "lineNbr": 34,
      "author": {
        "id": 1113941
      },
      "writtenOn": "2017-11-16T09:14:13Z",
      "side": 1,
      "message": "you haven\u0027t actually implemented destroying itself if the notifier goes away. Presumably that means that this case also needs a test to be added ;) ?",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8bc43f81_65f71848",
        "filename": "services/device/geolocation/public_ip_address_geolocator.cc",
        "patchSetId": 5
      },
      "lineNbr": 34,
      "author": {
        "id": 1176036
      },
      "writtenOn": "2017-11-17T03:33:12Z",
      "side": 1,
      "message": "hi Colin, I added the destroying logic (and I\u0027m not sure how to test it :(), but the more I think about it the more I feel like it is not the right thing to do:\n\nthis is the following cl that Andrew has: https://chromium-review.googlesource.com/c/chromium/src/+/754255\n\nI assume since we\u0027re not strongly binding PublicIpAddressGeolocator to the mojo interface, which means we need to store it in PublicIpAddressGeolocationProvider(in Andrew\u0027s following cl), so if PublicIpAddressLocationNofier is destructed which cause the destruction of PublicIpAddressGeolocator (because of the destruction callback) but the PublicIpAddressGeolocationProvider isn\u0027t aware of it and can still make mojo request (causing danger).\n\nI\u0027m not sure about how mojo works but how about: we still keep the weak binding, but store PublicIpAddressGeolocator on PublicIpAddressGeolocationProvider as a unique_ptr, the PublicIpAddressGeolocationProvider will subscribe to PublicIpAddressLocationNofier\u0027s destruction callback, and once it\u0027s destructed, the  PublicIpAddressGeolocationProvider will reset PublicIpAddressGeolocator and unbind the mojo request?\n\n+amoylan, what do you guys think?",
      "parentUuid": "4d31c71f_af7125cd",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d2106c3e_a6b6751c",
        "filename": "services/device/geolocation/public_ip_address_geolocator.cc",
        "patchSetId": 5
      },
      "lineNbr": 34,
      "author": {
        "id": 1113941
      },
      "writtenOn": "2017-11-17T08:54:52Z",
      "side": 1,
      "message": "I\u0027m not sure I\u0027m understanding your concern here. When PublicIpAddressGeolocationProvider receives a request to bind a Geolocation, it passes that on to PublicIpAddressGeolocator. From that point, PublicIpAddressGeolocationProvider is no longer involved in the connection between that PublicIpAddressGeolocator instance and its client.\n\nAlso, PublicIpAddressLocationNotifier is owned by PublicIpAddressGeolocationProvider, so it would seem that the only way the former could be destroyed is if the latter is destroyed? If that\u0027s actually the case, maybe it just makes the most sense for PublicIpAddressGeolocationProvider to own the PublicIpAddressGeolocator instances via a StrongBindingSet? That way it would be in control of everything\u0027s lifetime and there actually shouldn\u0027t be a need for either WeakPtrs or for objects observing each others\u0027 destruction. PublicIpAddressLocationNotifier could just make sure that the StrongBindingSet is destroyed before the PublicIpAddressLocationNotifier.\n\nPlease let me know if I\u0027m misunderstanding something here though!",
      "parentUuid": "8bc43f81_65f71848",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f546a017_e42bb8b6",
        "filename": "services/device/geolocation/public_ip_address_geolocator.cc",
        "patchSetId": 5
      },
      "lineNbr": 34,
      "author": {
        "id": 1176036
      },
      "writtenOn": "2017-11-17T11:58:55Z",
      "side": 1,
      "message": "thanks Colin, that\u0027s actually exactly what I meant :)\n\nI will remove the AddDestructionCallback stuff in PublicIpAddressLocationNotifier and make PublicIpAddressGeolocationProvider controls the lifetimes.\n\nThanks a lot!",
      "parentUuid": "d2106c3e_a6b6751c",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "32cd94bc_88717a91",
        "filename": "services/device/geolocation/public_ip_address_geolocator.cc",
        "patchSetId": 5
      },
      "lineNbr": 34,
      "author": {
        "id": 1113941
      },
      "writtenOn": "2017-11-17T12:02:52Z",
      "side": 1,
      "message": "Why is there any need for destruction callbacks if we go this route? Isn\u0027t PublicAddressGeolocationProvider controlling the lifetimes sufficient on its own?",
      "parentUuid": "f546a017_e42bb8b6",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fce81bba_4b275555",
        "filename": "services/device/geolocation/public_ip_address_geolocator.cc",
        "patchSetId": 5
      },
      "lineNbr": 34,
      "author": {
        "id": 1113941
      },
      "writtenOn": "2017-11-17T12:05:43Z",
      "side": 1,
      "message": "oops, ignore this comment! I read \"remove\" as \"move\" for some reason.",
      "parentUuid": "32cd94bc_88717a91",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a3dc21ec_19225604",
        "filename": "services/device/geolocation/public_ip_address_geolocator.cc",
        "patchSetId": 5
      },
      "lineNbr": 34,
      "author": {
        "id": 1176036
      },
      "writtenOn": "2017-11-17T12:06:59Z",
      "side": 1,
      "message": "right, there\u0027s no need for destruction callbacks, that\u0027s why I have removed destruction callbacks in this cl and in upstream cl as well. :)",
      "parentUuid": "32cd94bc_88717a91",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b5e1ef75_5433c508",
        "filename": "services/device/geolocation/public_ip_address_geolocator.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1113941
      },
      "writtenOn": "2017-11-16T09:14:13Z",
      "side": 1,
      "message": "nit: PublicIpAddressGeolocator",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1d85a946_68bfd358",
        "filename": "services/device/geolocation/public_ip_address_geolocator.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1113941
      },
      "writtenOn": "2017-11-16T09:14:13Z",
      "side": 1,
      "message": "I would make this weakly bound instead and have it listen for connection error. That way (IMO) it\u0027s more clear that the object controls its own lifetime and destroys itself when either the client goes away for the notifier goes away. That\u0027s also how we generally structure this pattern.",
      "range": {
        "startLine": 24,
        "startChar": 40,
        "endLine": 24,
        "endChar": 48
      },
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2d82755c_b2eeb266",
        "filename": "services/device/geolocation/public_ip_address_geolocator.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1176036
      },
      "writtenOn": "2017-11-17T03:33:12Z",
      "side": 1,
      "message": "thanks for the suggestion, I have changed the binding to follow others\u0027 pattern. :)",
      "parentUuid": "1d85a946_68bfd358",
      "range": {
        "startLine": 24,
        "startChar": 40,
        "endLine": 24,
        "endChar": 48
      },
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "84cdac73_ed922f81",
        "filename": "services/device/geolocation/public_ip_address_geolocator.h",
        "patchSetId": 5
      },
      "lineNbr": 24,
      "author": {
        "id": 1176036
      },
      "writtenOn": "2017-11-17T03:33:12Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b5e1ef75_5433c508",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d15e6670_f5b63102",
        "filename": "services/device/geolocation/public_ip_address_geolocator.h",
        "patchSetId": 5
      },
      "lineNbr": 54,
      "author": {
        "id": 1113941
      },
      "writtenOn": "2017-11-16T09:14:13Z",
      "side": 1,
      "message": "this should be able to just be a mojo::Binding with my comment above",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "14b3cdef_a4c49237",
        "filename": "services/device/geolocation/public_ip_address_geolocator.h",
        "patchSetId": 5
      },
      "lineNbr": 54,
      "author": {
        "id": 1176036
      },
      "writtenOn": "2017-11-17T03:33:12Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "d15e6670_f5b63102",
      "revId": "a1822bee06f9dcb3dc58893112190b148c7152c0",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "49a5b564_89487381",
        "filename": "content/renderer/devtools/devtools_frontend_impl.cc",
        "patchSetId": 29
      },
      "lineNbr": 38,
      "author": {
        "id": 1000379
      },
      "writtenOn": "2017-11-11T12:50:08Z",
      "side": 1,
      "message": "I find this to be a strange change. DidClearWindowObject was _the_ place to execute JS after commit, and now every client should be aware enough to do a PostTask? Perhaps it makes sense to fire DidClearWindowObject later?\n\nAlso note, that this code is moving: https://chromium-review.googlesource.com/c/chromium/src/+/739746/4/third_party/WebKit/Source/controller/DevToolsFrontendImpl.cpp#96. Could you please wait a bit (that change has almost landed)? This also suggests that blink might have similar places which execute JS early - you might want to cover them as well.",
      "revId": "b2c4889fc025aa732ddf0fc069b7a4f83e161b4b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9fc26d72_12c28309",
        "filename": "content/renderer/devtools/devtools_frontend_impl.cc",
        "patchSetId": 29
      },
      "lineNbr": 38,
      "author": {
        "id": 1130134
      },
      "writtenOn": "2017-11-13T18:23:20Z",
      "side": 1,
      "message": "\u003e I find this to be a strange change. DidClearWindowObject was _the_ place to execute JS after commit, and now every client should be aware enough to do a PostTask? Perhaps it makes sense to fire DidClearWindowObject later?\n\nThis is a very good question - thanks for raising it.\n\n1. I brought this question up in a related CL from Balazs: https://crrev.com/c/735686\n2. I think we may need to fire DidClearWindowObject later.  I don\u0027t know how to do this yet - I\u0027ll try to look into this later this week (and then I\u0027ll get back to this CR so we can discuss whether PostTask is really needed or not).\n\n\u003e Also note, that this code is moving: https://chromium-review.googlesource.com/c/chromium/src/+/739746/4/third_party/WebKit/Source/controller/DevToolsFrontendImpl.cpp#96. Could you please wait a bit (that change has almost landed)?\n\nSure - I\u0027ll wait.\n\n\u003e This also suggests that blink might have similar places which execute JS early - you might want to cover them as well.\n\nGood point - I\u0027ll try to look into adding (or rather moving) the no-scripts-before-commit-DCHECK into blink::ScriptController::ExecuteScriptInMainWorld.  I may try to do this in a separate CL though.",
      "parentUuid": "49a5b564_89487381",
      "revId": "b2c4889fc025aa732ddf0fc069b7a4f83e161b4b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f0470313_93d8427c",
        "filename": "content/renderer/devtools/devtools_frontend_impl.cc",
        "patchSetId": 29
      },
      "lineNbr": 38,
      "author": {
        "id": 1003152
      },
      "writtenOn": "2017-11-13T18:42:50Z",
      "side": 1,
      "message": "Hang on, wasn\u0027t this already broken before?\n\nI\u0027m possibly missing something, but it looks like even before this CL, Blink ended up invoking DidClearWindowObject after DidCommitProvisionalLoad for normal navigations, but before DidCommitProvisionalLoad for cross-site navigations (when a frame is swapped (back) in).\n\nLukasz, can you please double check?",
      "parentUuid": "9fc26d72_12c28309",
      "revId": "b2c4889fc025aa732ddf0fc069b7a4f83e161b4b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6927e4ff_31263cb2",
        "filename": "content/renderer/devtools/devtools_frontend_impl.cc",
        "patchSetId": 29
      },
      "lineNbr": 38,
      "author": {
        "id": 1130134
      },
      "writtenOn": "2017-11-14T00:07:20Z",
      "side": 1,
      "message": "\u003e Hang on, wasn\u0027t this already broken before?\n\u003e \n\u003e I\u0027m possibly missing something, but it looks like even before this CL, Blink ended up invoking DidClearWindowObject after DidCommitProvisionalLoad for normal navigations, but before DidCommitProvisionalLoad for cross-site navigations (when a frame is swapped (back) in).\n\u003e \n\u003e Lukasz, can you please double check?\n\nYes, before and after this CL, for cross-process navigations RFO::DidClearWindowObject is invoked *before* RFO::DidCommitProvisionalLoad as illustrated by the following callstack:\n\n#4 0x7f214468655f content::DevToolsFrontendImpl::DidClearWindowObject()\n#5 0x7f21448890a8 content::RenderFrameImpl::DidClearWindowObject()\n#6 0x7f2138f4d5e1 blink::LocalFrameClientImpl::DispatchDidClearWindowObjectInMainWorld()\n#7 0x7f2139892bfb blink::FrameLoader::DispatchDidClearWindowObjectInMainWorld()\n#8 0x7f213869b40b blink::LocalWindowProxy::Initialize()\n#9 0x7f213873146a blink::WindowProxy::SetGlobalProxy()\n#10 0x7f213873213b blink::WindowProxyManager::SetGlobalProxies()\n#11 0x7f2138f80d13 blink::WebFrame::Swap()\n#12 0x7f21448762ff content::RenderFrameImpl::SwapIn()\n#13 0x7f21448856da content::RenderFrameImpl::DidCommitProvisionalLoad()\n\n\nSomewhat unrelated - I\u0027ve noticed that all RFO/RVO::DidClearWindowObject overrides were only installing new bindings (e.g. window.chrome, window.internals, etc.), but *only* DevToolsFrontendImpl would end up executing a script.  So - in the latest patchset I\u0027ve made DevToolsFrontendImpl override DidCommitProvisionalLoad instead of DidClearWindowObject.  Unfortunately, this doesn\u0027t help much - this makes the tests pass and possibly makes this CL landable (by undoing the rightfully frowned upon PostTask in DevToolsFrontendImpl), but the problems will come back when after https://crrev.com/c/739746 DevToolsFrontendImpl won\u0027t anymore by a subclass of RenderFrameObserver.  After https://crrev.com/c/739746, DevToolsFrontendImpl will be executing scripts from the following callstack (not an actual callstack, this is based on my reading of the other CL / of the code):\n\n- DevToolsFrontendImpl::DidClearWindowObject (moved/new in the other CL)\n- BlinkInitializer::OnClearWindowObjectInMainWorld (new in the other CL)\n- LocalFrameClientImpl::DispatchDidClearWindowObjectInMainWorld\n- ...\n\nQUESTION: How can I make sure that DevToolsFrontendImpl::DidClearWindowObject executes *after* DidCommitProvisionalLoad IPC after https://crrev.com/c/739746 lands (e.g. after DevToolsFrontendImpl is NOT a RenderFrameObserver)?  Is there some other Blink-internal method that can call into DevToolsFrontendImpl::DidClearWindowObject^H^HExecuteInitializationScripts?  So far I haven\u0027t found anything suitable in blink::CoreInitializer, but maybe I should be looking somewhere else?",
      "parentUuid": "f0470313_93d8427c",
      "revId": "b2c4889fc025aa732ddf0fc069b7a4f83e161b4b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
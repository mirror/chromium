<!DOCTYPE html>
<head>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>
  if (window.internals)
    internals.settings.setLogDnsPrefetchAndPreconnect(true);
</script>

<!-- PRECONNECT -->
<link rel="preconnect" href="//1.should.preconnect.test">
<link rel="preconnect" href="//2.should.preco
nnect.test">
<link rel="preconnect" href="//3.should.not.preco
nnect.test<">

<!-- DNS-PREFETCH -->
<link rel="dns-prefetch" href="//1.should.dns-prefetch.test">
<link rel="dns-prefetch" href="//2.should.dns-
prefetch.test">
<link rel="dns-prefetch" href="//3.should.not.dns-
prefetch.test<">

</head>
<body>
<script>
  if (window.internals)
    internals.settings.setLogDnsPrefetchAndPreconnect(true);

  function readableURL(url) {
    return url.replace(/\n/g, "\\n").replace(/\r/g, "\\r").replace(/\t/g, "\\t");
  }

  var should_load = [
    `/resources/square.png`,
    `/resources/squ\nare.png`,
    `/resources/squ\tare.png`,
    `/resources/squ\rare.png`,
    `/resources/square.png?img=<`,
    `/resources/square.png?img=&lt;`,
    `/resources/square.png?img=%3C`,
    `/resources/squ\nare.png?img=%3C`,
    `/resources/squ\rare.png?img=%3C`,
    `/resources/squ\tare.png?img=%3C`,
    `/resources/square.png?img=&#10;`,
    `/resources/squ\nare.png?img=&#10;`,
    `/resources/squ\rare.png?img=&#10;`,
    `/resources/squ\tare.png?img=&#10;`,
  ];
  should_load.forEach(url => async_test(t => {
    var link = document.createElement('link');
    link.rel = "prefetch";
    link.href = url;
    link.onload = t.step_func_done();
    link.onerror = t.unreached_func("Prefetch should not fail.");
    document.body.appendChild(link);
  }, "Prefetch: " + readableURL(url)));

  var should_block = [
    `/resources/squ\nare.png?img=<`,
    `/resources/squ\rare.png?img=<`,
    `/resources/squ\tare.png?img=<`,
    `/resources/square.png?<\n=block`,
    `/resources/square.png?<\r=block`,
    `/resources/square.png?<\t=block`,
  ];
  should_block.forEach(url => async_test(t => {
    var link = document.createElement('link');
    link.rel = "prefetch";
    link.href = url;
    link.onerror = t.step_func_done();
    link.onload = t.unreached_func("Prefetch should fail.");
    document.body.appendChild(link);
  }, "Prefetch: " + readableURL(url)));
</script>

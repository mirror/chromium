<!DOCTYPE html>
<title>Web Locks API: Shared Mode</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>
'use strict';

promise_test(async t => {
  let n = 0;
  const granted = [];
  function grant(n) { return () => { granted.push(n); }; }

  await Promise.all([
    navigator.locks.acquire('a', grant(++n), {mode: 'shared'}),
    navigator.locks.acquire('b', grant(++n), {mode: 'shared'}),
    navigator.locks.acquire('c', grant(++n), {mode: 'shared'}),
    navigator.locks.acquire('a', grant(++n), {mode: 'shared'}),
    navigator.locks.acquire('b', grant(++n), {mode: 'shared'}),
    navigator.locks.acquire('c', grant(++n), {mode: 'shared'}),
  ]);

  assert_array_equals(granted, [1, 2, 3, 4, 5, 6]);
}, 'Lock requests are granted in order');

promise_test(async t => {
  await navigator.locks.acquire(['a', 'b'], async lock => {
    assert_array_equals(lock.scope, ['a', 'b']);
    assert_equals(lock.mode, 'shared');

    // Since lock over [a, b] is held, these requests would
    // be blocked if the locks were not all 'shared'.

    await navigator.locks.acquire('a', lock => {
      assert_array_equals(lock.scope, ['a']);
      assert_equals(lock.mode, 'shared');
    }, {mode: 'shared'});

    await navigator.locks.acquire('b', lock => {
      assert_array_equals(lock.scope, ['b']);
      assert_equals(lock.mode, 'shared');
    }, {mode: 'shared'});

  }, {mode: 'shared'});
}, 'Shared locks are not exclusive');

</script>

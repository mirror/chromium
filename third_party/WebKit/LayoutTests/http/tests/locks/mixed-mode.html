<!DOCTYPE html>
<title>Web Locks API: Mixed Modes</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>
'use strict';

promise_test(async t => {
  let unblock;
  const blocked = new Promise(r => { unblock = r; });

  const granted = [];

  // These should be granted immediately, and held until unblocked.
  await Promise.all([
    requestLock('a', 'shared')
      .then(f => { granted.push('as1'); f.waitUntil(blocked); }),
    requestLock('a', 'shared')
      .then(f => { granted.push('as2'); f.waitUntil(blocked); }),
    requestLock('a', 'shared')
      .then(f => { granted.push('as3'); f.waitUntil(blocked); })
  ]);

  // This should be blocked.
  const excl = requestLock('a', 'exclusive')
    .then(f => { granted.push('ae'); return f; });

  // This should be granted immediately (different scope).
  await requestLock('b', 'shared').then(f => { granted.push('bs'); });
  assert_array_equals(granted, ['as1', 'as2', 'as3', 'bs']);

  unblock();

  // Now the blocked request can be granted.
  const lock = await excl;
  assert_equals(lock.mode, 'exclusive');

  assert_array_equals(granted, ['as1', 'as2', 'as3', 'bs', 'ae']);

}, 'Lock requests are granted in order');

</script>

<!DOCTYPE html>
<title>Service Worker: CSP default directive for ServiceWorker script</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="resources/test-helpers.js"></script>
<script>
promise_test(test => {
  var url = 'resources/service-worker-csp-default.php?directive=default';
  var scope = new URL('scope' + window.location.pathname,
                      new URL(url, window.location)).toString();

  return service_worker_unregister_and_register(test, url, scope)
    .then(reg => {
        add_completion_callback(() => {
            reg.unregister();
          });
        var sw = reg.installing;
        return new Promise(resolve => {
            return wait_for_state(test, sw, 'activated')
              .then(() => { resolve(sw); });
          });
      })
    .then(sw => {
        internals.terminateServiceWorker(sw);
        return navigator.serviceWorker.getRegistration(scope);
      })
    .then(r => {
        fetch_tests_from_worker(r.active);
      });
}, 'CSP test for default-src in installed ServiceWorkerGlobalScope');
</script>

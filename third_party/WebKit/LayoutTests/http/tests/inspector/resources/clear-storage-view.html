<html>
<head>
<script src="../inspector-test.js"></script>
<script src="../resources-test.js"></script>
<script src="../console-test.js"></script>
<script src="../indexeddb/indexeddb-test.js"></script>
<script>

async function test() {
  var updateListener = null;

  async function writeArray() {
    var array = [];
    for (var i = 0; i < 5000000; i++)
      array.push(i % 10);
    var mainFrameId = InspectorTest.resourceTreeModel.mainFrame.id;
    await new Promise(resolve => InspectorTest.createDatabase(mainFrameId, 'Database1', resolve));
    await new Promise(resolve => InspectorTest.createObjectStore(mainFrameId, 'Database1', 'Store1', 'id', true, resolve));
    await new Promise(resolve => InspectorTest.addIDBValue(mainFrameId, 'Database1', 'Store1', {key: 1, value: array}, '', resolve));
  }

  function findTreeNodeByName(parent, name) {
    for (var child of parent.children()) {
      if (child.title == name)
        return child;
    }
  }

  function matchingRefreshPromise(predicate) {
    return new Promise(resolve => {
      function sniffer(data) {
        if (!predicate || predicate(data))
          resolve();
        else
          InspectorTest.addSniffer(clearStorageView, '_updateQuotaDisplay', sniffer);
      }
      InspectorTest.addSniffer(clearStorageView, '_updateQuotaDisplay', sniffer);
    });
  }

  function dumpWithoutQuota(element) {
    // Quota will vary between setups, rather strip it altogether
    var clean = element.innerHTML.replace(/\&nbsp;/g, ' ');
    var quotaStripped = clean.replace(/(.*) \d+ .?B([^\d]*)/, '$1 -$2');
    InspectorTest.addResult(quotaStripped);
  }
  try {

  UI.viewManager.showView('resources');

  var parent = UI.panels.resources._sidebar._applicationTreeElement;
  var clearStorageElement = parent.children().find(child => child.title === 'Clear storage');

  console.assert(clearStorageElement);
  clearStorageElement.select();

  var clearStorageView = UI.panels.resources.visibleView;
  InspectorTest.addResult("Clear storage view is visible: " + (clearStorageView instanceof Resources.ClearStorageView));

  var tempRefreshed = false;
  var persistentRefreshed = false;

  await matchingRefreshPromise();

  dumpWithoutQuota(clearStorageView._temporaryQuotaRow);
  dumpWithoutQuota(clearStorageView._persistentQuotaRow);

  InspectorTest.markStep('Now with data');

  await writeArray();
  await matchingRefreshPromise((data) => {
    for (var entry of data) {
      if (entry.persistence === Protocol.Storage.QuotaAndUsagePersistence.Temporary)
        return entry.usage > 5000000;
    }
  });

  dumpWithoutQuota(clearStorageView._temporaryQuotaRow);
  dumpWithoutQuota(clearStorageView._persistentQuotaRow);
  } catch (e) {
    console.log(e)
  }

  InspectorTest.completeTest();
}
</script>
</head>
<body onload="runTest()">
  <p>Tests Clear Storage view functions.</p>
</body>
</html>

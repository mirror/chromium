<html>
<head>
<script src="../inspector-test.js"></script>
<script src="../network-test.js"></script>
<script>

async function test()
{
    await InspectorTest.clearNetworkCache();

    InspectorTest.recordNetwork();

    await requestResource('resources/style.css');
    await requestResource('resources/abe.png');
    // Second one should be from cache.
    await requestResource('resources/abe.png');
    await requestResource('missing/foo.bar');

    checkFilter("-.css", false);
    checkFilter("-.png", false);
    checkFilter("css", false);
    checkFilter("", false);
    checkFilter(".*", true);
    checkFilter(".*\\..*", true);
    checkFilter(".*\\.png", true);
    checkFilter("NOTHINGTOMATCH", true);
    checkFilter("", true);
    checkFilter("png", false);
    checkFilter("-missing", false);
    checkFilter("is:from-cache", false);
    checkFilter("-is:from-cache", false);
    checkFilter("foo method:GET", false);
    checkFilter("foo", false);

    InspectorTest.completeTest();

    /**
     * @param {string} filterText
     * @param {boolean} isRegex
     */
    function checkFilter(filterText, isRegex)
    {
        InspectorTest.addResult("filterText: " + filterText);
        InspectorTest.addResult("isRegex: " + isRegex);

        UI.panels.network._networkLogView._textFilterUI._regexCheckBox.checked = isRegex;
        UI.panels.network._networkLogView._textFilterUI.setValue(filterText);
        UI.panels.network._networkLogView._filterChanged(null); // event not used in this method, so passing null

        var nodes = UI.panels.network._networkLogView.flatNodesList();
        var foundNodesCount = 0;
        for (var i = 0; i < nodes.length; i++) {
            if (!nodes[i][Network.NetworkLogView._isFilteredOutSymbol])
                foundNodesCount++;
        }

        InspectorTest.addResult("Found results: " + foundNodesCount);
        InspectorTest.addResult("");
    }

    /**
     * @param {string} url
     * @return {!Promise}
     */
    async function requestResource(url)
    {
        InspectorTest.evaluateInPage(`fetch('${url}')`);
        var request = await InspectorTest.waitForEvent(SDK.NetworkManager.Events.RequestFinished, InspectorTest.networkManager,
            request => request.url().endsWith(url));
        await InspectorTest.waitForNetworkLogViewNodeForRequest(request);
    }
}
</script>
</head>
<body onload="runTest()">
<p>Tests fetch network filters</p>
</body>
</html>

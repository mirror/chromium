<!DOCTYPE html>
<title>Credential Manager: create() is permitted within secure context framed document that is same-origin with its ancestors.</title>
<script src="../resources/testharness.js"></script>
<script src="../resources/testharnessreport.js"></script>
<script src="/gen/layout_test_data/mojo/public/js/mojo_bindings.js"></script>
<script src="/gen/third_party/WebKit/public/platform/modules/credentialmanager/credential_manager.mojom.js"></script>
<script src="/gen/third_party/WebKit/public/platform/modules/webauth/authenticator.mojom.js"></script>
<script src="resources/credential-helpers.js"></script>

<div id="log"></div>
<script>

if (document.location.hostname == "127.0.0.1")
document.location = "https://subdomain.example.test:8443/credentialmanager/credentialscontainer-create-iframe.html";

const success_cases = [
    { "iframe" : "about:blank" },
];

const failure_cases = [
	{ "iframe" : "data:text/html" },
];

promise_test(() => {
    return new Promise((resolve,reject) => {
        var iframe = document.createElement('iframe');
        iframe.src = "data:text/html,<script>if(navigator.credentials==undefined){parent.postMessage('PASS', '*')}else{parent.postMessage('FAIL', '*')};<\/script>";
        iframe.onload = () => iframe.contentWindow.postMessage('LOADED', '*');
        document.body.appendChild(iframe);
        window.onmessage = message => {
            if (message.data == 'PASS') {
                resolve();
            } else if (message.data == 'FAIL') {
               reject();
            }
        }
    });
}, "iframe failure test");

// Use an invalid algorithm in the parameters so each test will
// exercise the rpID checks in  both the renderer and browser 
// and return prior to reaching the device layer.
var custom_public_key = {
    challenge,
    rp: public_key_rp,
    user: public_key_user,
    pubKeyCredParams: [{type: "public-key", alg: 0,},],
    excludeCredentials: [],
};

for (let test of success_cases) {

    promise_test(t => {
        var iframe = document.createElement("iframe");
        iframe.src = test.iframe;
        let eventWatcher = new EventWatcher(t, iframe, "load");
        window.setTimeout(function() { document.body.appendChild(iframe);});
        return eventWatcher.wait_for("load")
            .then(function() { return promise_rejects(t, 'NotSupportedError',
                                      iframe.contentWindow.navigator.credentials.create({custom_public_key}))});
     }, "iframe test");
}
</script>
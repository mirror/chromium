<!DOCTYPE html>
<html>
  <head>
    <title>
      Test cross-thread passing of AudioWorkletNodeOptions
    </title>
    <script src="../../resources/testharness.js"></script>
    <script src="../../resources/testharnessreport.js"></script>
    <script src="../../../webaudio-resources/audit.js"></script>
    <script src="audio-worklet-common.js"></script>
  </head>
  <body>
    <script id="layout-test-code">
      // TODO(hongchan): remove this assertion when AudioWorklet shipped.
      assertAudioWorklet();

      const audit = Audit.createTaskRunner();
      const context = new AudioContext();

      // Create a OptionTestProcessor and feed |processorData| to it. The
      // processor should echo the received data to the node's |onmessage|
      // handler.
      audit.define('valid-processor-data', (task, should) => {
        context.audioWorklet.addModule('option-test-processor.js').then(() => {
          let processorData = {
            description: 'foo',
            payload: [0, 1, 2, 3]
          };

          let optionTestNode =
              new AudioWorkletNode(context, 'option-test-processor', {
                processorData: processorData
              });

          optionTestNode.port.onmessage = (event) => {
            should(event.data.processorData.description,
                   '|description| field in processorData from processor("' +
                       event.data.processorData.description + '")')
                .beEqualTo(processorData.description,
                           'the field in node constructor options ("' +
                           processorData.description + '")');
            should(event.data.processorData.payload,
                   '|payload| array in processorData from processor([' +
                       event.data.processorData.payload + '])')
                .beEqualToArray([0, 1, 2, 3],
                                'the array in node constructor options ([' +
                                event.data.processorData.payload + '])');
            task.done();
          };
        });
      });


      // Passing empty option dictionary should work without a problem.
      audit.define('empty-option', (task, should) => {
        context.audioWorklet.addModule('option-test-processor.js').then(() => {
          let optionTestNode =
              new AudioWorkletNode(context, 'option-test-processor');

          optionTestNode.port.onmessage = (event) => {
            should(Object.keys(event.data).length,
                   'Number of properties in data from processor')
                .beEqualTo(2);
            should(event.data.numberOfInputs,
                   '|numberOfInputs| field in data from processor')
                .beEqualTo(1);
            should(event.data.numberOfOutputs,
                   '|numberOfOutputs| field in data from processor')
                .beEqualToArray(1);
            task.done();
          };
        });
      });


      audit.run();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <title>
      Test AudioWorkletProcessorState in AudioWorkletNode
    </title>
    <script src="../../resources/testharness.js"></script>
    <script src="../../resources/testharnessreport.js"></script>
    <script src="../../../webaudio-resources/audit.js"></script>
    <script src="audio-worklet-common.js"></script>
  </head>
  <body>
    <script id="layout-test-code">
      // TODO(hongchan): remove this assertion when AudioWorklet shipped.
      assertAudioWorklet();

      let audit = Audit.createTaskRunner();

      let context = new AudioContext();

      audit.define('timed',
          (task, should) => {
            audioWorklet.addModule('timed-processor.js').then(() => {
              let timedWorkletNode = new AudioWorkletNode(context, 'timed');
              
              // The construction of associated processor has not been
              // completed. In this state, no audio processing can happen and
              // all messages to the processor will be queued.
              should(timedWorkletNode.processorState,
                     'timedWorkletNode.processorState')
                  .beEqualTo('pending');

              // Checks the handler of |onprocessorstatechange|. Because the
              // processor script is correct, the |running| state change MUST
              // be fired.
              timedWorkletNode.onprocessorstatechange = () => {
                should(timedWorkletNode.processorState,
                       'Checking the processor state after upon ' +
                       'processorstatechange event')
                    .beEqualTo('running');
                task.done();
              };              
            });
          });

      audit.run();
    </script>
  </body>
</html>

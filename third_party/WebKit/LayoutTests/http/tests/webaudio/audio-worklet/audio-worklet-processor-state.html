<!DOCTYPE html>
<html>
  <head>
    <title>
      Test AudioWorkletProcessorState in AudioWorkletNode
    </title>
    <script src="../../resources/testharness.js"></script>
    <script src="../../resources/testharnessreport.js"></script>
    <script src="../../../webaudio-resources/audit.js"></script>
    <script src="audio-worklet-common.js"></script>
  </head>
  <body>
    <script id="layout-test-code">
      // TODO(hongchan): remove this assertion when AudioWorklet shipped.
      assertAudioWorklet();

      let audit = Audit.createTaskRunner();

      let context = new AudioContext();

      // Test "pending", "running" and "stopped" state transition.
      audit.define('pending-running-stopped',
          (task, should) => {
            let timedWorkletNode = new AudioWorkletNode(context, 'timed');

            // Starts from |pending| state.
            let expectedState = 'pending';

            // The construction of associated processor has not been
            // completed. In this state, no audio processing can happen and
            // all messages to the processor will be queued.
            should(timedWorkletNode.processorState,
                   'Checking the processor state upon the constructor call')
                .beEqualTo(expectedState);

            // Transition to |running| state.
            expectedState = 'running';

            timedWorkletNode.connect(context.destination);

            // Checks the handler of |onprocessorstatechange|. Because the
            // processor script is correct, the |running| state change MUST
            // be fired.
            timedWorkletNode.onprocessorstatechange = () => {
              if (expectedState === 'running') {
                should(timedWorkletNode.processorState,
                       'Checking the processor state upon ' +
                       'processorstatechange event')
                    .beEqualTo(expectedState);
                expectedState = 'stopped';
              } else {
                should(timedWorkletNode.processorState,
                       'Checking the processor state after ' +
                       'processor stopped processing')
                    .beEqualTo(expectedState);
                task.done();
              }
            };
          });

      // Test the error state caused by the failure of processor constructor.
      audit.define('constructor-error',
          (task, should) => {
            let constructorErrorWorkletNode =
                new AudioWorkletNode(context, 'constructor-error');
            should(constructorErrorWorkletNode.processorState,
                   'constructorErrorWorkletNode.processorState after ' +
                   'its construction')
                .beEqualTo('pending');
            constructorErrorWorkletNode.onprocessorstatechange = () => {
              should(constructorErrorWorkletNode.processorState,
                     'workletNode.processorState upon processorstatechange ' +
                     'event after the failure from processor.constructor()')
                  .beEqualTo('error');
              task.done();
            };
          });

      // Test the error state caused by the failure of processor's process()
      // function.
      audit.define('process-error',
          (task, should) => {
            let processErrorWorkletNode =
                new AudioWorkletNode(context, 'process-error');
            should(processErrorWorkletNode.processorState,
                   'processErrorWorkletNode.processorState after ' +
                   'its construction')
                  .beEqualTo('pending');

            processErrorWorkletNode.connect(context.destination);

            processErrorWorkletNode.onprocessorstatechange = () => {
              if (processErrorWorkletNode.processorState !== 'running') {
                should(processErrorWorkletNode.processorState,
                       'workletNode.processorState upon processorstatechange ' +
                       'event after the failure from processor.process()')
                    .beEqualTo('error');
                task.done();
              }
            };
          });

      audioWorklet.addModule('state-processor.js').then(() => {
        audit.run();
      });
    </script>
  </body>
</html>

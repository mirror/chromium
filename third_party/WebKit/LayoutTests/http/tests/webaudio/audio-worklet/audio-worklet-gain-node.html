<!DOCTYPE html>
<html>
  <head>
    <title>
      Test AudioWorkletNode's basic AudioParam features
    </title>
    <script src="../../resources/testharness.js"></script>
    <script src="../../resources/testharnessreport.js"></script>
    <script src="../../../webaudio-resources/audit.js"></script>
    <script src="audio-worklet-common.js"></script>
  </head>
  <body>
    <script id="layout-test-code">
      // TODO(hongchan): remove this assertion when AudioWorklet shipped.
      assertAudioWorklet();

      let audit = Audit.createTaskRunner();
      let context;
      let sampleRate = 48000;
      let renderLength = 1024;

      // Sets up AudioWorklet and OfflineAudioContext.
      audit.define('Initializing AudioWorklet and Context', (task, should) => {
        audioWorklet.addModule('gain-processor.js').then(() => {
          context = new OfflineAudioContext(1, renderLength, sampleRate);
          task.done();
        });
      });

      // Verifies the functionality of AudioParam in AudioWorkletNode by
      // comparing (canceling out) values from GainNode and AudioWorkletNode
      // with simple gain computation code by AudioParam.
      audit.define(
          'Verifying AudioParam in AudioWorkletNode',
          (task, should) => {
            let constantSourceNode = new ConstantSourceNode(context);
            let gainNode = new GainNode(context);
            let inverterNode = new GainNode(context, {gain: -1});
            let gainWorkletNode = new AudioWorkletNode(context, 'gain');
            constantSourceNode.connect(gainNode)
                .connect(inverterNode)
                .connect(context.destination);
            constantSourceNode.connect(gainWorkletNode)
                .connect(context.destination);

            [gainNode.gain, gainWorkletNode.parameters.get('gain')]
                .forEach((param) => {
              param.setValueAtTime(0, 0);
              param.linearRampToValueAtTime(1, 0.1);
              param.exponentialRampToValueAtTime(0.5, 0.2);
              param.setTargetAtTime(0.01, 0.2, 0.5);
              param.setValueAtTime(0.0, 0.5);
            });

            constantSourceNode.start();
            context.startRendering().then((renderedBuffer) => {
              should(renderedBuffer.getChannelData(0)).beConstantValueOf(0);
              task.done();
            });
          });

      audit.run();
    </script>
  </body>
</html>

<html>
<head>
<script src="../../inspector/inspector-test.js"></script>
<script src="../../inspector/layers-test.js"></script>
<script>
function test() {
  LayersTestRunner.requestLayers(onGotLayers);

  async function onGotLayers() {
    var layer = LayersTestRunner.findLayerByNodeIdAttribute("layer");
    var snapshotWithRect = await layer.snapshots()[0];
    await testImageForSnapshot(snapshotWithRect.snapshot, undefined);
    await testImageForSnapshot(snapshotWithRect.snapshot, 0.5);
    TestRunner.completeTest();
  }

  async function testImageForSnapshot(snapshot, scale) {
    var imageURL = await snapshot.replay(scale);
    var image = await new Promise(fulfill => {
      var image = new Image();
      image.addEventListener('load', () => fulfill(image), false);
      image.src = imageURL;
    });
    TestRunner.addResult(`Image dimensions at scale ${scale}: ${image.naturalWidth} x ${image.naturalHeight}`);
  }
}
</script>
</head>
<body onload="runTest()">
<p>
Tests that when layer snapshots are replayed with scaling applied the image dimensions are properly scaled.
</p>
<div id="layer" style="background-color:blue; transform: translateZ(0px); position: absolute">
  <div id="clip" style="overflow: hidden">
    <script>
(function()
{
    var clip = document.getElementById("clip");
    var size = (180 / window.devicePixelRatio) + "px";
    clip.style.width = size;
    clip.style.height = size;
})();
    </script>
    <div style="width:50px; height:50px; background-color:red;"></div>
    <img src="../tracing/resources/test.png">
    <svg>
        <rect x="0" y="0" width="10" height="10" style="opacity:0.5"/>
    </svg>
  </div>
</div>
</body>
</html>

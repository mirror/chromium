<html>
<head>
<script src="../../inspector/inspector-test.js"></script>
<script src="../../inspector/timeline-test.js"></script>
<script src="../../inspector/service-workers/service-workers-test.js"></script>
<script>

function loadScript() {
  const url = 'v8-cache-script.js';
  const frameId = 'frame_id';
  let iframeWindow = document.getElementById(frameId).contentWindow;
  return iframeWindow.loadScript(url)
    .then(() => iframeWindow.loadScript(url));
}


function continueInstall(scope) {
    let reg = registrations[scope];
    if (!reg)
      return Promise.reject(new Error('No registration'));
    if (!reg.installing)
      return Promise.reject(new Error('No installing service worker'));
    reg.installing.postMessage('');
  }


function test() {
  const scriptURL = 'resources/v8-cache-worker.js';
  const scope = 'resources/v8-cache-iframe.html';
  const frameId = 'frame_id';

  ApplicationTestRunner.registerServiceWorker(scriptURL, scope)
      .then(_ => {
        // Need to suspend targets, because V8 doesn't produce the cache when
        // the debugger is loaded.
        return SDK.targetManager.suspendAllTargets();
      })
      .then(_ => {
        return TestRunner.callFunctionInPageAsync('continueInstall', [scope]);
      })
      .then(_ => ApplicationTestRunner.waitForActivated(scope))
      .then(() => {
        return TestRunner.addIframe(scope, {id: frameId});
      })
      .then(() => {
        return new Promise(
            (r) => {
              PerformanceTestRunner.invokeAsyncWithTimeline('loadScript', r);
            });
      })
      .then(() => {
        PerformanceTestRunner.printTimelineRecordsWithDetails(
            TimelineModel.TimelineModel.RecordType.CompileScript);
        TestRunner.completeTest();
      });
}

</script>
</head>
<body onload="runTest()">
<p>Tests V8 cache information of Service Worker Cache Storage in timeline</p>
</body>
</html>

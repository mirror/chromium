<!DOCTYPE html>
<meta charset="utf-8">
<title>Encoding: ISO-2022-JP unencodable replacement in form submission</title>
<link rel="help" href="https://encoding.spec.whatwg.org/#iso-2022-jp-encoder">
<link rel="author" title="Benjamin C. Wiley Sittler"
      href="mailto:bsittler@chromium.org">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>
'use strict';

promise_test(async testCase => {
  const target = Object.assign(document.createElement('iframe'), {
    name: 'target',
  });
  if (document.readyState !== 'complete') {
    await new Promise(resolve => addEventListener('load', resolve));
  }
  document.body.insertBefore(target, document.body.firstChild);
  const form = Object.assign(document.createElement('form'), {
    acceptCharset: 'iso-2022-jp',
    action: 'data:text/html;charset=iso-2022-jp,' + escape(
            '<body onload="(' +
            (() => parent.postMessage({
              utf16: document.body.innerText.split('=').pop(),
              iso2022jp: unescape(location.href.split('=').pop()),
            }, '*')) +
            ')()"><plaintext>'),
    target: target.name,
  });
  form.appendChild(Object.assign(document.createElement('input'), {
    name: 'utf16',
    value: 'ABC~Â¤â€¢â˜…æ˜ŸðŸŒŸæ˜Ÿâ˜…â€¢Â¤~XYZ',
  }));
  document.body.insertBefore(form, document.body.firstChild);
  const {iso2022jp, utf16} = await new Promise(resolve => {
    addEventListener('message', ({data}) => resolve(data));
    form.submit();
  });
  assert_equals(utf16, 'ABC~&#164;&#8226;â˜…æ˜Ÿ&#127775;æ˜Ÿâ˜…&#8226;&#164;~XYZ');
  assert_equals(
      iso2022jp,
      'ABC~&#164;&#8226;\x1b$B!z@1\x1b(B&#127775;\x1b$B@1!z\x1b(B&#8226;&#164;~XYZ');
}, 'Form submission using ISO-2022-JP correctly replaces unencodables');

</script>

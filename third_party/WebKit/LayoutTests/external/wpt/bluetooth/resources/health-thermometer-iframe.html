<!DOCTYPE html>
<script>
let device, gatt;

function requestDeviceWithOptionsAndConnect(options) {
  return navigator.bluetooth.requestDevice(options)
  .then(device => device.gatt.connect());
}

window.onmessage = messageEvent => {
  switch (messageEvent.data.type) {
    case 'RequestAndConnect':
      requestDeviceWithOptionsAndConnect(messageEvent.data.options)
      .then(_ => gatt = _)
      .then(() => {
        device = gatt.device;
        parent.postMessage('Connected', '*');
      }).catch(err => {
        parent.postMessage(`FAIL: ${err}`, '*');
      });
      break;
    case 'DiscoverServices':
      requestDeviceWithOptionsAndConnect(messageEvent.data.options)
      .then(_ => gatt = _)
      .then(() => gatt.getPrimaryServices())
      .then(() => parent.postMessage('DiscoveryComplete', '*'))
      .catch(err => {
        parent.postMessage(`FAIL: ${err}`, '*');
      });
      break;
    case 'GetService':
      if (typeof gatt === 'undefined') {
        parent.postMessage('FAIL: no GATT server', '*');
        break;
      }
      gatt.getPrimaryService(messageEvent.data.options)
      .then(() => parent.postMessage('ServiceReceived', '*'))
      .catch(err => parent.postMessage(`FAIL: ${err}`, '*'));
      break;
    default:
      parent.postMessage(`FAIL: Bad message type: ${messageEvent.data.type}`,
                         '*');
  }
};
</script>

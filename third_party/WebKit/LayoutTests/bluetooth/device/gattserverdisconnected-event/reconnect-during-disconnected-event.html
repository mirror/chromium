<!DOCTYPE html>
<script src="../../../resources/testharness.js"></script>
<script src="../../../resources/testharnessreport.js"></script>
<script src="../../../resources/bluetooth/bluetooth-helpers.js"></script>
<script src="../../../resources/bluetooth/web-bluetooth-test.js"></script>
<script src="../../../resources/mojo-helpers.js"></script>
<script>
'use strict';
promise_test(() => {
  let device, fake_peripheral;
  return getHealthThermometerDevice()
    .then(_ => ({device, fake_peripheral} = _))
    .then(() => new Promise(resolve => {
      // 1. Attach a listener that tries to reconnect.
      function reconnect(event) {
        device.removeEventListener('gattserverdisconnected', reconnect);
        fake_peripheral.setNextGATTConnectionResponse({
          code: HCI_SUCCESS,
        })
          .then(() => device.gatt.connect())
          .then(resolve);
      };
      device.addEventListener('gattserverdisconnected', reconnect);
      // 2. Disconnect.
      fake_peripheral.simulateGATTDisconnection();
    }))
    .then(() => {
      let disconnected = eventPromise(device, 'gattserverdisconnected');
      // 3. Disconnect after reconnecting.
      fake_peripheral.simulateGATTDisconnection();
      return disconnected;
    });
}, 'A device that reconnects during the gattserverdisconnected event ' +
   'should still receive gattserverdisconnected events after re-connection.');
</script>

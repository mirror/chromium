<!DOCTYPE html>
<script src="../../../resources/testharness.js"></script>
<script src="../../../resources/testharnessreport.js"></script>
<script src="../../../resources/bluetooth/bluetooth-helpers.js"></script>
<script src="../../../resources/bluetooth/web-bluetooth-test.js"></script>
<script src="../../../resources/mojo-helpers.js"></script>
<script>
'use strict';
promise_test(() => {
  return getMeasurementIntervalCharacteristic()
    .then(({characteristic, fake_characteristic}) => {
      return fake_characteristic.setNextSubscribeToNotificationsResponse(
          GATT_SUCCESS)
        .then(() => characteristic.startNotifications())
        .then(() => {
          let event_promise = new Promise(resolve => {
            let event_listener = () => {
              characteristic.removeEventListener(
                'characteristicvaluechanged', event_listener);
              resolve();
            };
            characteristic.addEventListener(
              'characteristicvaluechanged', event_listener);
          });
          fake_characteristic.simulateNotification({value: [0, 1]});
          return event_promise;
        })
        .then(() =>
          fake_characteristic.setNextUnsubscribeFromNotificationsResponse(
            GATT_SUCCESS));
    });
}, 'Registering after the promise resolves shouldn\'t result in events ' +
   'getting dropped.');
</script>

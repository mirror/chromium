<!DOCTYPE html>
<script>
let device;
window.onmessage = messageEvent => {
  // Check message data
  switch (messageEvent.data) {
    case 'RequestAndConnect':
      navigator.bluetooth.requestDevice({
        filters: [{services: ['health_thermometer']}]
      })
      .then(device => device.gatt.connect())
      .then(gattServer => {
        device = gattServer.device;
        parent.postMessage('Connected', '*');
      }).catch(err => {
        console.error(err);
        parent.postMessage('FAIL: ' + err, '*');
      });
      break;
    default:
      break;
  }
  // Check message data type.
  switch (messageEvent.data.type) {
    case 'DiscoverServices':
      navigator.bluetooth.requestDevice(messageEvent.data.options)
      .then(device => device.gatt.connect())
      .then(gatt => {
        return gatt.getPrimaryServices()
        // TODO(crbug.com/719816): Remove catch once the device
        // has some services.
          .catch(e => {
            if (e.name !== 'NotFoundError' ||
                e.message !== 'No Services found in device.') {
              throw e;
            }
          });
      })
      .then(() => parent.postMessage('DiscoveryComplete', '*'))
      .catch(err => {
        console.error(err);
        parent.postMessage('FAIL: ' + err, '*');
      });
      break;
  }
};
</script>

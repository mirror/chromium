<!DOCTYPE HTML>
<script src="../../resources/testharness.js"></script>
<script src="../../resources/testharnessreport.js"></script>
<script src="canvas-createImageBitmap-drawImage.js"></script>
<script>

var imageBitmap;

// Image sources to be passed to createImageBitmap
var canvas;
var image;
var imageBitmap;
var imageData;
var blob;

var imageWidth = 20;
var imageHeight = 20;

// createImageBitmap from canvas
canvas = document.createElement("canvas");
canvas.width = imageWidth;
canvas.height = imageHeight;
var ctx = canvas.getContext("2d");
drawPattern(ctx);
var t_canvas = async_test("Testing createImageBitmap from canvas.");
var runCanvasTests = t_canvas.step_func(function() {
    return runTests(t_canvas, canvas);
});
runCanvasTests();

// createImageBitmap from image and imagebitmap
image = new Image();
var t_image = async_test("Testing createImageBitmap from image.");
image.onload = t_image.step_func(function() {
    async_test(t => {
        createImageBitmap(image).then(function(bitmap) {
            imageBitmap = bitmap;
            var runImageBitmapTests = t.step_func(function() {
                return runTests(t, imageBitmap);
            });
            runImageBitmapTests();
            t.done();
        }, function() {
            promiseRejectedUnexpectedly();
        });
    }, "Testing createImageBitmap from imagebitmap.");
    return runTests(t_image, image);
});
image.src = canvas.toDataURL();

// createImageBitmap from image and imagedata
imageData = ctx.getImageData(0, 0, 20, 20);
var t_imageData = async_test("Testing createImageBitmap from ImageData.");
var runImageDataTests = t_imageData.step_func(function() {
    return runTests(t_imageData, imageData);
});
runImageDataTests();

// createImageBitmap from image and blob
var xhr = new XMLHttpRequest();
xhr.open("GET", 'resources/pattern.png');
xhr.responseType = 'blob';
xhr.send();
var t_blob = async_test("Testing createImageBitmap from blob.");
xhr.onload = t_blob.step_func(function() {
    blob = xhr.response;
    return runTests(t_blob, blob);
});

function runTests(t, element) {
    imageBitmaps = {};
    var p1 = createImageBitmap(element).then(function (image) { 
        imageBitmaps.noCrop = image });
    var p2 = createImageBitmap(element, 0, 0, 10, 10).then(function (image) { imageBitmaps.crop = image });
    var p3 = createImageBitmap(element, 5, 5, 10, 10).then(function (image) { imageBitmaps.cropCenter = image });
    var p4 = createImageBitmap(element, 10, 10, 10, 10).then(function (image) { imageBitmaps.cropRight = image });
    var p5 = createImageBitmap(element, -10, -10, 60, 60).then(function (image) { imageBitmaps.overCrop = image });
    var p6 = createImageBitmap(element, 10, 10, 50, 50).then(function (image) { imageBitmaps.overCropRight = image });
    var p7 = createImageBitmap(element, 10, 10, -10, -10).then(function (image) { imageBitmaps.negativeCrop = image });
    var p8 = createImageBitmap(element, -30, -30, 30, 30).then(
        function (image) { imageBitmaps.blankImage1 = image });
    var p9 = createImageBitmap(element, 40, 30, 30, 30).then(
        function (image) { imageBitmaps.blankImage2 = image });

    return Promise.all([p1, p2, p3, p4, p5, p6, p7, p8, p9]).then(
        t.step_func_done(function() {

        var acanvas = document.createElement("canvas");
        acanvas.setAttribute("width", "50");
        acanvas.setAttribute("height", "50");
        var actx = acanvas.getContext("2d");

        checkNoCrop(actx, imageBitmaps.noCrop);
        checkCrop(actx, imageBitmaps.crop);
        checkCropCenter(actx, imageBitmaps.cropCenter);
        checkCropRight(actx, imageBitmaps.cropRight);
        checkOverCrop(actx, imageBitmaps.overCrop);
        checkOverCropRight(actx, imageBitmaps.overCropRight);
        checkCrop(actx, imageBitmaps.negativeCrop);
        checkBlankImageBitmap(actx, imageBitmaps.blankImage1);
        checkBlankImageBitmap(actx, imageBitmaps.blankImage2);

        async_test(t => {
            createImageBitmap(element, 0, 0, Math.pow(10, 6),
                                             Math.pow(10, 6)).then(function() {
                promiseResolvedUnexpectedly(
                    'Asking for a huge ImageBitmap unexpectedly resolved.');
                t.done();
            }, function() {
                t.done();
            });
        }, "Asking for a huge ImageBitmap from " + jsWrapperClass(element) + " should be rejected.");

    }), t.step_func_done(function() {
        promiseRejectedUnexpectedly();
    }));
}

</script>
</body>
</html>

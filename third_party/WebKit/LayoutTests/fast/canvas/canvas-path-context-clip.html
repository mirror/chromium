<script src="../../resources/testharness.js"></script>
<script src="../../resources/testharnessreport.js"></script>
<body>
<canvas id="canvas" width="200" height="200"></canvas>
<script>

var ctx = document.getElementById('canvas').getContext('2d');

function checkResult(expectedColors, sigma) {
    data = ctx.getImageData(50, 50, 1, 1).data;
    for (var i = 0; i < 4; i++)
        assert_approx_equals(data[i], expectedColors[i], sigma);
}

function drawRectanglesOn(contextOrPath) {
    contextOrPath.rect(0, 0, 100, 100);
    contextOrPath.rect(25, 25, 50, 50);
}

function testClipWith(fillRule, path) {
    ctx.fillStyle = 'rgb(255,0,0)';
    ctx.beginPath();
    ctx.fillRect(0, 0, 100, 100);
    ctx.fillStyle = 'rgb(0,255,0)';
    if (path) {
        if (fillRule) {
            ctx.clip(path, fillRule);
        } else {
            ctx.clip(path);
        }
    } else {
        ctx.beginPath();
        drawRectanglesOn(ctx);
        if (fillRule) {
            ctx.clip(fillRule);
        } else {
            ctx.clip();
        }
    }
    ctx.beginPath();
    ctx.fillRect(0, 0, 100, 100);
    if (fillRule == 'evenodd') {
        checkResult([255, 0, 0, 255], 5);
    } else {
        checkResult([0, 255, 0, 255], 5);
    }
}

test(function(t) {
    fillRules = [undefined, 'nonzero', 'evenodd'];
    path = new Path2D();
    drawRectanglesOn(path);

    for (var i = 0; i < fillRules.length; i++) {
       testClipWith(fillRules[i]);
       testClipWith(fillRules[i], path);
    }

    // Test exception cases.
    try {
      ctx.clip(null);
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip(null, null);
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip(null, 'nonzero');
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip(path, null);
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip([], 'nonzero');
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
        ctx.clip({}, 'nonzero');
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip(null, 'evenodd');
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip([], 'evenodd');
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip({}, 'evenodd');
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip('gazonk');
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip(path, 'gazonk');
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip(undefined, undefined);
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
    try {
      ctx.clip(undefined, 'nonzero');
    } catch (ex) {
      assert_equals(ex.name, "TypeError");
    }
}, 'Series of tests to ensure clip() works with path and winding rule parameters.');
</script>
</body>

<!DOCTYPE HTML>
<script src="../../resources/testharness.js"></script>
<script src="../../resources/testharnessreport.js"></script>
<script src="canvas-createImageBitmap-drawImage.js"></script>
<script>

var bitmap;
var video;
var t = async_test('createImageBitmap from video');

var canvas1 = document.createElement("canvas");
canvas1.setAttribute("width", "500");
canvas1.setAttribute("height", "500");
var ctx1 = canvas1.getContext("2d");

var canvas2 = document.createElement("canvas");
canvas2.setAttribute("width", "500");
canvas2.setAttribute("height", "500");
var ctx2 = canvas2.getContext("2d");

video = document.createElement("video");
video.addEventListener("canplaythrough",
                       t.step_func(function() {
                           return runTests();
                        }), false);
video.src = "../../compositing/resources/video.ogv";

function runTests() {
    var imageBitmaps = {};
    var p1 = createImageBitmap(video).then(
        function (image) { imageBitmaps.noCrop = image });
    var p2 = createImageBitmap(video, 0, 0, 100, 100).then(
        function (image) { imageBitmaps.crop = image });
    var p3 = createImageBitmap(video, 50, 50, 100, 100).then(
        function (image) { imageBitmaps.cropRight = image });
    var p4 = createImageBitmap(video, 100, 100, 100, 100).then(
        function (image) { imageBitmaps.cropCenter = image });
    var p5 = createImageBitmap(video, -100, -100, 600, 600).then(
        function (image) { imageBitmaps.overCrop = image });
    var p6 = createImageBitmap(video, 100, 100, 500, 500).then(
        function (image) { imageBitmaps.overCropRight = image });
    var p7 = createImageBitmap(video, 100, 100, -100, -100).then(
        function (image) { imageBitmaps.negativeCrop = image });
    var p8 = createImageBitmap(video, -300, -300, 300, 300).then(
        function (image) { imageBitmaps.blankImage1 = image });
    var p9 = createImageBitmap(video, 400, 300, 300, 300).then(
        function (image) { imageBitmaps.blankImage2 = image });

    return Promise.all([p1, p2, p3, p4, p5, p6, p7]).then(
        t.step_func_done(function() {

        checkNoCropVideo(ctx1, ctx2, video, imageBitmaps.noCrop);
        checkCropVideo(ctx1, ctx2, video, imageBitmaps.crop, 0, 0, 100, 100);
        checkCropVideo(ctx1, ctx2, video, imageBitmaps.cropRight,
                       50, 50, 100, 100);
        checkCropVideo(ctx1, ctx2, video, imageBitmaps.cropCenter,
                       100, 100, 100, 100);
        checkOverCropVideo(ctx1, ctx2, video, imageBitmaps.overCrop);
        checkOverCropRightVideo(ctx1, ctx2, video, imageBitmaps.overCropRight);
        checkCropVideo(ctx1, ctx2, video, imageBitmaps.negativeCrop,
                       0, 0, 100, 100);
        checkBlankImageBitmapVideo(ctx1, imageBitmaps.blankImage1);
        checkBlankImageBitmapVideo(ctx1, imageBitmaps.blankImage2);

        async_test(t => {
            createImageBitmap(video, 0, 0, Math.pow(10, 6),
                                           Math.pow(10, 6)).then(function() {
                promiseResolvedUnexpectedly(
                    'Asking for a huge ImageBitmap unexpectedly resolved.');
                t.done();
            }, function() {
                t.done();
            });
        }, "Asking for a huge ImageBitmap should be rejected.");

    }), t.step_func_done(function() {
        promiseRejectedUnexpectedly();
    }));
}

</script>
</body>
</html>

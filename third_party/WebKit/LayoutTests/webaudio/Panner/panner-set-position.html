<!doctype html>
<html>
  <head>
    <title>
      Test Panner.setPosition
    </title>
    <script src="../../resources/testharness.js"></script>
    <script src="../../resources/testharnessreport.js"></script>
    <script src="../resources/audit-util.js"></script>
    <script src="../resources/audit.js"></script>
  </head>
  <body>
    <script id="layout-test-code">
      // Fairly arbitrary rate
      let sampleRate = 16000;

      // For the tests we need to render for at least two render quanta.
      // Otherwise, pretty arbitrary.
      let renderFrames = 256;
      let renderDuration = renderFrames / sampleRate;

      // The curve duration for the test.  Anything less than one render quantum
      // is fine.  Arbitrarily choose something small.
      let curveDurationFrames = 8;

      // When to call setPosition, after the setValueCurve has ended.  Any value
      // after the end of the first render quantum is fine.
      let suspendFrame = 129;

      let audit = Audit.createTaskRunner();

      // Three separate tests for each axis.
      audit.define('setPosition X exception', (task, should) => {
        Promise
            .all([
              testSetPosition(should, {coordName: 'positionX'}),
              testSetPosition(should, {
                coordName: 'positionX',
                curveDuration: curveDurationFrames / sampleRate,
                suspendFrame: suspendFrame
              })
            ])
            .then(() => task.done());
      });

      audit.define('setPosition Y exception', (task, should) => {
        Promise
            .all([
              testSetPosition(should, {coordName: 'positionY'}),
              testSetPosition(should, {
                coordName: 'positionY',
                curveDuration: curveDurationFrames / sampleRate,
                suspendFrame: suspendFrame
              })
            ])
            .then(() => task.done());
      });

      audit.define('setPosition Z exception', (task, should) => {
        Promise
            .all([
              testSetPosition(should, {coordName: 'positionZ'}),
              testSetPosition(should, {
                coordName: 'positionZ',
                curveDuration: curveDurationFrames / sampleRate,
                suspendFrame: suspendFrame
              })
            ])
            .then(() => task.done());
      });

      audit.run();

      // Test that setPosition throws an error if there is already a
      // setValueCurve scheduled during the same time period.
      function testSetPosition(should, options) {
        let context = new OfflineAudioContext(1, renderFrames, sampleRate);

        // Create the graph consisting of a source node and the panner.
        let src = new ConstantSourceNode(context, {offset: 1});
        let panner = new PannerNode(context);
        src.connect(panner).connect(context.destination);

        let curve = Float32Array.from([-10, 10]);

        let message = options.coordName + '.setValueCurve(..., 0, ' +
            (options.curveDuration || renderDuration) + ')';

        // Set the curve automation on the specified axis.
        should(() => {
          panner[options.coordName].setValueCurveAtTime(
              curve, 0, options.curveDuration || renderDuration);
        }, message).notThrow();

        if (options.suspendFrame) {
          // We're testing setPosition after the curve has ended to verify that
          // we don't throw an error.  Thus, suspend the context and call
          // setPosition.
          let suspendTime = options.suspendFrame / context.sampleRate;
          context.suspend(suspendTime)
              .then(() => {
                should(
                    () => {
                      console.log('currentTime ' + context.currentTime);
                      panner.setPosition(1, 1, 1)
                    },
                    'setPosition(1,1,1) for ' + options.coordName +
                        ' at time ' + suspendTime)
                    .notThrow();
              })
              .then(() => context.resume());
        } else {
          // Basic test where setPosition is called where setValueCurve is
          // already active.
          context.suspend(0)
              .then(() => {
                should(
                    () => {
                      panner.setPosition(1, 1, 1);
                    },
                    'setPosition(1,1,1) for ' + options.coordName)
                    .throw('NotSupportedError');
              })
              .then(() => context.resume());
        }

        src.start();
        return context.startRendering();
      }
    </script>
  </body>
</html>

#!/usr/bin/env python
# Copyright 2017 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

from webkitpy.common.host import Host
from webkitpy.w3c.chromium_finder import absolute_chromium_dir
from webkitpy.w3c.common import CHROMIUM_WPT_DIR

import sys

assert CHROMIUM_WPT_DIR.endswith('/')
CHROMIUM_WPT_DIR_LEN = len(CHROMIUM_WPT_DIR.split('/')) - 1


def main():
    host = Host()
    chromium_dir = absolute_chromium_dir(host)

    since = sys.argv[1]

    revs = host.executive.run_command([
        'git', 'rev-list', 'origin/master',
        '--since={}T00:00:00Z'.format(since),
        '--', CHROMIUM_WPT_DIR,
    ], cwd=chromium_dir).strip().split()

    dir_counts = {}

    for sha in revs:
        print sha

        message = host.executive.run_command([
            'git', 'show', '-s', '--format=%B', sha,
        ], cwd=chromium_dir).strip()

        if 'NOEXPORT=true' in message or 'No-Export: true' in message or message.startswith('Import'):
            continue

        changed_files = host.executive.run_command([
            'git', 'diff-tree', '--name-only', '--no-commit-id', '-r', sha,
            '--', CHROMIUM_WPT_DIR,
        ], cwd=chromium_dir).splitlines()

        for f in changed_files:
            components = f.split('/')[CHROMIUM_WPT_DIR_LEN:]
            # pretend as if css/foo are top level directories
            if components[0] == 'css':
                components = ['css/' + components[1]] + components[2:]
            # ignore changes to files in the root dir (and css/)
            if len(components) == 1:
                continue
            top_dir = components[0]
            dir_counts[top_dir] = dir_counts.get(top_dir, 0) + 1
            print f

        print

    dirs = dir_counts.keys()
    dirs.sort()
    for key in dirs:
        print key, dir_counts[key]

if __name__ == '__main__':
    main()

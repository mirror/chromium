#!/usr/bin/env python
# Copyright 2017 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

from webkitpy.common.host import Host
from webkitpy.w3c.chromium_finder import absolute_chromium_dir
from webkitpy.w3c.common import CHROMIUM_WPT_DIR

import sys

assert CHROMIUM_WPT_DIR.endswith('/')
CHROMIUM_WPT_DIR_LEN = len(CHROMIUM_WPT_DIR.split('/')) - 1


SKIP_COMMITS = set([
    # Reland "Import wpt@edf1d4d14d8ee7ff5f0f306ed83dfbb1325d0bd7 (manual)""
    'c62bebdff1b9d9f8aa6d5e5339f14586e7ec1b04',
    # Run automatic spell-checker on web-platform-tests
    '816d3a265c5315f0f39b1691be9b9b048b8ceaa8',
    # Add real baselines for new .any.js and .worker.js tests (batch 1 of N)
    '550d62d7eb5fc6f269b3568df6ba48d3221fcdc9',
    # Trim whitespace from message strings in testharnessreport
    '3fb9fd31d5f4384271ae0ace68b80185829b8cc5',
    # In testharnessreport.js, add space before message on fail lines
    'a6df92167f0eabd6496a84877ba80f66a928ecbd',
])


def main():
    host = Host()
    chromium_dir = absolute_chromium_dir(host)

    since = sys.argv[1]

    revs = host.executive.run_command([
        'git', 'rev-list', 'origin/master',
        '--since={}T00:00:00Z'.format(since),
        '--', CHROMIUM_WPT_DIR,
    ], cwd=chromium_dir).strip().split()

    dir_counts = {}

    for sha in revs:
        if sha in SKIP_COMMITS:
            continue

        print sha

        message = host.executive.run_command([
            'git', 'show', '-s', '--format=%B', sha,
        ], cwd=chromium_dir).strip()

        if 'NOEXPORT=true' in message or 'No-Export: true' in message or message.startswith('Import'):
            continue

        changed_files = host.executive.run_command([
            'git', 'diff-tree', '--name-only', '--no-commit-id', '-r', sha,
            '--', CHROMIUM_WPT_DIR,
        ], cwd=chromium_dir).splitlines()

        for f in changed_files:
            # ignore OWNERS changes
            if f.endswith('/OWNERS'):
                continue
            components = f.split('/')[CHROMIUM_WPT_DIR_LEN:]
            # pretend as if css/foo are top level directories
            if components[0] == 'css':
                components = ['css/' + components[1]] + components[2:]
            # ignore changes to files in the root dir (and css/)
            if len(components) == 1:
                continue
            top_dir = components[0]
            dir_counts[top_dir] = dir_counts.get(top_dir, 0) + 1
            print f

        print

    dirs = dir_counts.keys()
    dirs.sort()
    for key in dirs:
        print key, dir_counts[key]

if __name__ == '__main__':
    main()

{
  "comments": [
    {
      "key": {
        "uuid": "40d65276_974458ab",
        "filename": "components/arc/common/timer.mojom",
        "patchSetId": 3
      },
      "lineNbr": 10,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2017-08-15T04:55:33Z",
      "side": 1,
      "message": "Could you share the plan a bit more details?\nBecause of the lack of background, it is difficult for me to review.\nSpecifically, what feature/APIs are you implementing/supporting? The linked bug looks also not informative enough to me, unfortunately.\n\nJust according to your commit message, at the moment, I do not think Timer is needed,\nbecause you can just extend power.mojom?\n\nAlso, it sounds a bit weird to me that you\u0027re exposing raw syscalls because they are prohibited in container for security purpose? More precise explanation is appreciated.",
      "revId": "b338c98f6b6fd29f1e83c4b34f148d03f247f3e8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "85df6a3b_4f4bc118",
        "filename": "components/arc/common/timer.mojom",
        "patchSetId": 3
      },
      "lineNbr": 10,
      "author": {
        "id": 1137924
      },
      "writtenOn": "2017-08-16T01:17:08Z",
      "side": 1,
      "message": "Please find a detailed explanation at b/64581307. Copying pasting what I wrote there -\n\nThe Android container uses the timerfd_settime syscall to set alarms. This happens in the file frameworks/base/services/core/jni/com_android_server_AlarmManagerService.cpp . Currently, the container doesn\u0027t have the CAP_WAKE_ALARM capability. This prevents it from setting wake up alarms i.e. alarms that wake the processor up from suspend. This capability is explicitly checked by timerfd_settime while\nsetting wake up alarms.\n\nFor Chrome OS tablets slated to release in the future, Calendar and Alarm apps should be able to set wake up alarms. One way to do is to just give CAP_WAKE_ALARM to the container. However, this means that Android apps can potentially use the raw syscall interface and keep setting wake up alarms. Also, these alarms won\u0027t necessarily work well with Chrome OS alarms i.e if Android and Chrome OS alarms can\u0027t be coalesced and may result in excessive wake ups.\n\nTo counter these two issues it is decided that instead of giving permission to the container the JNI layer redirects wake up alarm calls to Chrome via mojo. Chrome then calls powerd using existing or new APIs to set wake up alarms on the behalf of the container. Powerd then sets and manages alarms like a native alarm knowing when to batch or restrict alarms in case of malicious use. This is better for battery and overall experience.",
      "parentUuid": "40d65276_974458ab",
      "revId": "b338c98f6b6fd29f1e83c4b34f148d03f247f3e8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4b47cf64_86fa0166",
        "filename": "components/arc/common/timer.mojom",
        "patchSetId": 3
      },
      "lineNbr": 10,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2017-08-16T07:23:17Z",
      "side": 1,
      "message": "Thank you for sharing the background.\n\nI took a look Alarm code, and the syscall looks just used one of ways to implement timer,\nand it looks not important to return FD.\nSo, questions;\nIs it necessary to expose the syscall directly?\nAt the moment, I couldn\u0027t find a reason, because if an event is sent at specified timing to the container, it looks just enough?\nDo we need to proxy it to powerd? Does PostTask family work?\n\nFor security wise, defer to the expert, Jorge.",
      "parentUuid": "85df6a3b_4f4bc118",
      "revId": "b338c98f6b6fd29f1e83c4b34f148d03f247f3e8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ad36ebd3_070a5dc4",
        "filename": "components/arc/common/timer.mojom",
        "patchSetId": 3
      },
      "lineNbr": 10,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2017-08-16T20:06:18Z",
      "side": 1,
      "message": "We just need to be careful to only expose a timer interface in the container that\u0027s safe. Rule of thumb: assume the container is fully malicious. How do you design an API that cannot be trivially abused?\n\nEssentially, if your Mojo API doesn\u0027t do any useful checks on the requests coming from the container, having a Mojo API is not better than allowing access to the raw syscall.",
      "parentUuid": "4b47cf64_86fa0166",
      "revId": "b338c98f6b6fd29f1e83c4b34f148d03f247f3e8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0e3e9a84_2d68c534",
        "filename": "components/arc/common/timer.mojom",
        "patchSetId": 3
      },
      "lineNbr": 12,
      "author": {
        "id": 1003166
      },
      "writtenOn": "2017-08-16T20:08:14Z",
      "side": 1,
      "message": "Can you use an enum for this?",
      "range": {
        "startLine": 12,
        "startChar": 16,
        "endLine": 12,
        "endChar": 30
      },
      "revId": "b338c98f6b6fd29f1e83c4b34f148d03f247f3e8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5e8be01e_6b92d188",
        "filename": "components/arc/common/timer.mojom",
        "patchSetId": 3
      },
      "lineNbr": 12,
      "author": {
        "id": 1003166
      },
      "writtenOn": "2017-08-16T20:08:14Z",
      "side": 1,
      "message": "this does not have the same semantics. you need to declare this as a handle if you want to ship the fd.",
      "range": {
        "startLine": 12,
        "startChar": 49,
        "endLine": 12,
        "endChar": 61
      },
      "revId": "b338c98f6b6fd29f1e83c4b34f148d03f247f3e8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "80ea7485_bf1b0332",
        "filename": "components/arc/timer/arc_timer_bridge.h",
        "patchSetId": 3
      },
      "lineNbr": 22,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2017-08-15T14:22:31Z",
      "side": 1,
      "message": "Nit: \"DBus\".",
      "range": {
        "startLine": 22,
        "startChar": 42,
        "endLine": 22,
        "endChar": 46
      },
      "revId": "b338c98f6b6fd29f1e83c4b34f148d03f247f3e8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "26af36fd_989c07ac",
        "filename": "components/arc/timer/arc_timer_bridge.h",
        "patchSetId": 3
      },
      "lineNbr": 22,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2017-08-16T07:23:17Z",
      "side": 1,
      "message": "nit: I was recommended to use \"D-Bus\" :-).",
      "parentUuid": "80ea7485_bf1b0332",
      "range": {
        "startLine": 22,
        "startChar": 42,
        "endLine": 22,
        "endChar": 46
      },
      "revId": "b338c98f6b6fd29f1e83c4b34f148d03f247f3e8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "236fc831_542e2e89",
        "filename": "components/arc/timer/arc_timer_bridge.h",
        "patchSetId": 3
      },
      "lineNbr": 22,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2017-08-16T20:03:28Z",
      "side": 1,
      "message": "Agreed, if it were up to me we\u0027d put \"D-Bus\" everywhere, but I now settle for at least calling it DBus \u003d)",
      "parentUuid": "26af36fd_989c07ac",
      "range": {
        "startLine": 22,
        "startChar": 42,
        "endLine": 22,
        "endChar": 46
      },
      "revId": "b338c98f6b6fd29f1e83c4b34f148d03f247f3e8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
#!/usr/bin/env python
# Copyright 2017 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

import optparse
import os
import sys

from core import path_util
from core import benchmark_finders

from py_utils import cloud_storage


def GetAllStorySets():
  story_sets = []
  benchmarks_to_skip = [
      'skpicture_printer_ct',
      'screenshot_ct',
      'repaint_ct',
      'rasterize_and_record_micro_ct',
      'multipage_skpicture_printer_ct',
      'loading.cluster_telemetry',
      'skpicture_printer',
      'cros_tab_switching.typical_24',
      'multipage_skpicture_printer']

  for benchmark in benchmark_finders.GetAllBenchmarks():
    if benchmark.Name() in benchmarks_to_skip:
      continue

    parser = optparse.OptionParser()
    benchmark.AddBenchmarkCommandLineArgs(parser)
    options, _ = parser.parse_args([])
    story_sets.append(benchmark().CreateStorySet(options))
  return story_sets


def GetMissingArchivesInCloudStorage(wpr_archive_info):
  missing_archives = []
  bucket = wpr_archive_info._bucket
  story_archives = wpr_archive_info._data['archives']
  for story in story_archives:
    for _, archive_path in story_archives[story].iteritems():
      hash_path = archive_path + '.sha1'
      if not os.path.exists(hash_path):
        missing_archives.append(archive_path)
        continue
      remote_path = cloud_storage.ReadHash(hash_path)
      if not cloud_storage.Exists(bucket, remote_path):
        missing_archives.append(archive_path)
  return missing_archives


def main():
  for s in GetAllStorySets():
    if not s.wpr_archive_info:
      continue
    missing_archives = GetMissingArchivesInCloudStorage(s.wpr_archive_info)
    assert missing_archives, (
        'Archives not checked in cloud storage properly: %s' %
        '\n'.join(missing_archives))


if __name__ == '__main__':
  sys.exit(main())

<html>

<!--
  Copyright (c) 2006-2008 The Chromium Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can be
  found in the LICENSE file.
-->

<!--
  A brief note on terminology as used here: a "graph" is a plotted screenful
  of data, showing the results of one type of test: for example, the
  page-load-time graph.  A "trace" is a single line on a graph, showing one
  one for the test: for example, the reference build trace on the
  page-load-time graph.

  This page plots arbitrary numerical data loaded from files in a specific
  format.  It uses two or more data files, all JSON-encoded:

    graphs.dat: a list of objects, each with these properties: name (the name
        of a graph) and units (the units for the data to be read by humans).
        Schematically:
          [{"name": <graph_name>, "units": <units>}, ...]

    <graphname>-summary.dat: for each of the graphs listed in graphs.dat, the
        corresponding summary file holds rows of data. Each row of data is an
        object with several properties:
          "rev": the revision number for this row of data
          "traces": an object with several properties of its own. The name of
              the property corresponds to a trace name, used only as an
              internal identifier, and the property's value is an array of
              its measurement and that measurement's standard deviation (or
              other measurement error).
        Schematically:
          {"rev": <rev>,
           "traces": {<trace_name1>: [<value1>, <stddev1>],
                      <trace_name2>: [<value2>, <stddev2>], ...}
          }
-->
<head>
<style>
body {
  font-family: sans-serif;
}
div#output {
  cursor: pointer;
}
div#switcher {
  cursor: pointer;
}
div#switcher a {
  border-top: 1px solid black;
  border-left: 1px solid black;
  padding-left: 0.5em;
  padding-right: 0.5em;
}
canvas.plot {
  border: 1px solid black;
}
div.plot-coordinates {
  font-family: monospace;
}
iframe {
  display: none;
  width: 100%;
  height: 100%;
  border: none;
}
div.selector {
  border: solid 1px black;
  cursor: pointer;
  padding-left: 0.3em;
  background-color: white;
}
div.selector:hover {
  background-color: rgb(200,200,250);
}
div.selected {
  border-left: none;
}
div#selectors {
  width: 80px;
  display: none;
}
#explain {
  font-size: 0.75em;
  font-style: italic;
  color: rgb(100,100,100);
}
</style>

<script src="js/common.js"></script>
<script src="js/plotter.js"></script>
<script src="js/coordinates.js"></script>
<script src="config.js"></script>
<script>
document.title = Config.title;

var did_position_details = false;
var units = 'thing-a-ma-bobs';
var graph_list = [];

var params = ParseParams();
if (!('history' in params)) {
  params.history = 150;
  // make this option somewhat user discoverable :-/
  window.location.href = MakeURL(params);
}

function jsonToJs(data) {
  return eval('(' + data + ')')
}

function received_graph_list(data) {
  graph_list = jsonToJs(data);

  if (!('graph' in params) || params.graph == '') {
    if (graph_list.length > 0)
      params.graph = graph_list[0].name
  }

  // Add a selection tab for each graph, and find the units for the selected
  // one while we're at it.
  tabs = [];
  for (var index = 0; index < graph_list.length; ++index) {
    var graph = graph_list[index];
    tabs.push(graph.name);
    if (graph.name == params.graph)
      units = graph.units;
  }
  initPlotSwitcher(tabs);

  // Fetch the data for the selected graph.
  fetch_summary();

}

function go_to(graph) {
  params.graph = graph;
  if (params.graph == '')
    delete params.graph;
  window.location.href = MakeURL(params);
}

function get_url() {
  new_url = window.location.href;
  new_url = new_url.replace(/50/, "150");
  new_url = new_url.replace(/\&lookout/, "");
  return new_url;
}

function on_clicked_plot(prev_cl, cl) {
  if ('lookout' in params) {
    window.open(get_url());
    return;
  }

  document.getElementById('view-change').
      setAttribute('src', Config.changeLinkPrefix + prev_cl + ':' + cl);

  document.getElementById('view-pages').
      setAttribute('src', 'details.html?cl=' + cl);

  if (!did_position_details) {
    position_details();
    did_position_details = true;
  }
}

function received_summary(data) {
  // Parse the summary data file.
  var rows = data.split('\n');
  var max_rows = rows.length;
  if (max_rows > params.history)
    max_rows = params.history;

  var allTraces = {};

  // graphData[rev] = {trace1:[value, stddev], trace2:[value, stddev], ...}
  var graphData = {};
  for (var i = 0; i < max_rows; ++i) {
    if (!rows[i].length)
      continue;
    var row = jsonToJs(rows[i]);
    var traces = row['traces'];
    var revision = parseInt(row['rev']);
    graphData[revision] = traces;

    // Collect unique trace names.
    for (var traceName in traces)
      allTraces[traceName] = 1;
  }

  // Sort trace names, putting traces with corresponding _ref lines first
  // under the assumption that those are the most interesting ones.
  // Returns 1 if name1 is larger, -1 if it's smaller, and 0 if they're equal.
  // Use a closure so we have access to allTraces.
  function trace_compare(name1, name2) {
    function compare(x, y) {
      return ((x < y) ? -1 : (x > y) ? 1 : 0);
    }

    // The main trace name associated with this _ref name, and whether this is
    // in fact a _ref trace.
    main1 = name1.substring(0, name1.length - 4);
    main2 = name2.substring(0, name2.length - 4);
    is_ref1 = name1.substr(-4) == "_ref" && main1 in allTraces;
    is_ref2 = name2.substr(-4) == "_ref" && main2 in allTraces;

    // Whether this trace has a corresponding _ref. If so, it's its own main
    // trace.
    is_main1 = name1 + "_ref" in allTraces;
    is_main2 = name2 + "_ref" in allTraces;
    if (is_main1)
      main1 = name1;
    if (is_main2)
      main2 = name2;

    // A main trace is smaller than its own _ref, compared alphabetically by
    // main name to any other main or _ref traces, and smaller than anything
    // else.
    if (is_main1) {
      if (is_ref2 && main1 == main2)
        return -1;
      if (is_main2 || is_ref2)
        return compare(main1, main2);
      return -1;
    }
    if (is_ref1) {
      if (is_main2 && main1 == main2)
        return 1;
      if (is_main2 || is_ref2)
        return compare(main1, main2);
      return -1;
    }
    if (is_main2 || is_ref2)
      return 1;
    return compare(name1, name2);
  }

  // Build and sort a list of all the trace names we've seen.
  var traceNames = [];
  for (var traceName in allTraces)
    traceNames.push(traceName);
  traceNames.sort(trace_compare);

  // Build and numerically sort a list of revision numbers.
  var revisionNumbers = [];
  for (var rev in graphData)
    revisionNumbers.push(rev);
  revisionNumbers.sort(
      function(a, b) { return parseInt(a, 10) - parseInt(b, 10) });

  // Build separate ordered lists of trace data.
  var traceData = {};
  for (var revIndex = 0; revIndex < revisionNumbers.length; ++revIndex) {
    var rev = revisionNumbers[revIndex];
    var revisionData = graphData[rev];
    for (var nameIndex = 0; nameIndex < traceNames.length; ++nameIndex) {
      var traceName = traceNames[nameIndex];
      if (!traceData[traceName])
        traceData[traceName] = [];
      if (!revisionData[traceName])
        traceData[traceName].push([NaN, NaN]);
      else
        traceData[traceName].push(revisionData[traceName]);
    }
  }
  var plotData = [];
  for (var traceName in traceData)
    plotData.push(traceData[traceName]);

  var plotter = new Plotter(revisionNumbers, plotData, traceNames, units,
    document.getElementById("output"), true);
  plotter.onclick = on_clicked_plot;
  plotter.plot();
}

function fetch_summary() {
  if ('graph' in params)
    file = params.graph + "-summary.dat"
  else
    file = "summary.dat"
  Fetch(file, received_summary);
}

function fetch_graph_list() {
  Fetch("graphs.dat", received_graph_list);
}

function initPlotSwitcher(tabs) {
  var switcher = document.getElementById("switcher");
  for(var i = 0; i < tabs.length; i++) {
    var anchor = document.createElement("a");
    anchor.appendChild(document.createTextNode(tabs[i] + " "));
    anchor.addEventListener("click", goToClosure(tabs[i]), false);
    switcher.appendChild(anchor);
  }
}

function goToClosure(graph) {
  return function(){go_to(graph)};
}

function position_details() {
  var output = document.getElementById("output");

  var win_height = window.innerHeight;

  var details = document.getElementById("views");

  var views = document.getElementById("views");
  var selectors = document.getElementById("selectors");
  selectors.style.display = "block";

  var views_width = output.offsetWidth - selectors.offsetWidth;

  views.style.border = "1px solid black";
  views.style.width = views_width + "px";
  views.style.height = (win_height - output.offsetHeight - output.offsetTop -
                        30) + "px";

  selectors.style.position = "absolute";
  selectors.style.left = (views.offsetLeft + views_width + 1) + "px";
  selectors.style.top = views.offsetTop + "px";

  change_view("view-change");
}

function change_view(target) {
  if (target == "view-change") {
    document.getElementById("view-pages").style.display = "none";
    document.getElementById("view-change").style.display = "block";
  } else {
    document.getElementById("view-change").style.display = "none";
    document.getElementById("view-pages").style.display = "block";
  }
}

function init() {
  // We need to fill the graph list before parsing the params or fetching the
  // data, so we have a default graph in case none was specified.
  fetch_graph_list();
}

window.addEventListener("load", init, false);
</script>
</head>


<body>
<div id="header_lookout" align="center">
  <font style='color: #0066FF; font-family: Arial, serif;
               font-size: 20pt; font-weight: bold;'>
    <script>
      document.write("<a target=\"_blank\" href=\"");
      document.write(get_url());
      document.write("\">");
      document.write(Config.title);
      document.write("</a>");
    </script>
  </font>
</div>

<div id="header_text">
Builds generated by the <a href="http://buildbot.chromium.org/">buildbot</a>
are run through the <b>
<script>
document.write(Config.title);
</script>
</b>and the results of that test are charted here.
</div>

<div id="explain">
The vertical axis is measured values, and the horizontal
axis is the revision number for the build being tested.
</div>
<p></p>
<div id="switcher">

</div>
<div id="output"></div>
<div id="details">
  <div id="views">
    <iframe id="view-change"></iframe>
    <iframe id="view-pages"></iframe>
  </div>
  <div id="selectors">
    <div class="selector" onclick="change_view('view-change')">CL</div>
    <div style="border-top: none" class="selector"
         onclick="change_view('view-pages')">Pages</div>
  </div>
</div>
<pre id="log"></pre>
<script>
if ('lookout' in params) {
  switcher.style.display = "none";
  details.style.display = "none";
  header_text.style.display = "none";
  explain.style.display = "none";
  selection.style.display = "none";
} else {
  document.getElementById("header_lookout").style.display = "none";
}
</script>
</body>
</html>

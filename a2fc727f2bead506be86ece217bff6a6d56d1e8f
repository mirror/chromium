{
  "comments": [
    {
      "key": {
        "uuid": "cccabf87_cb8113b4",
        "filename": "chrome/browser/profiles/avatar_menu_desktop.cc",
        "patchSetId": 29
      },
      "lineNbr": 21,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-08-14T16:22:54Z",
      "side": 1,
      "message": "Move this after 28 (not needed until then).",
      "range": {
        "startLine": 21,
        "startChar": 2,
        "endLine": 21,
        "endChar": 51
      },
      "revId": "a2fc727f2bead506be86ece217bff6a6d56d1e8f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b1747fd3_97151f8e",
        "filename": "chrome/browser/profiles/avatar_menu_desktop.cc",
        "patchSetId": 29
      },
      "lineNbr": 21,
      "author": {
        "id": 1228990
      },
      "writtenOn": "2017-08-14T18:56:34Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "cccabf87_cb8113b4",
      "range": {
        "startLine": 21,
        "startChar": 2,
        "endLine": 21,
        "endChar": 51
      },
      "revId": "a2fc727f2bead506be86ece217bff6a6d56d1e8f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ef8fd5bc_569123aa",
        "filename": "chrome/browser/profiles/avatar_menu_desktop.cc",
        "patchSetId": 29
      },
      "lineNbr": 45,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-08-14T16:22:54Z",
      "side": 1,
      "message": "It\u0027s not clear what you mean by USE_DEFAULT here. In fact do you really need the AS_GAIA at all either? I\u0027m wondering if the enums can be LOADED, LOADING, MISSING, PROFILE_DELETED?",
      "range": {
        "startLine": 45,
        "startChar": 32,
        "endLine": 45,
        "endChar": 43
      },
      "revId": "a2fc727f2bead506be86ece217bff6a6d56d1e8f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "90820803_8e0b5384",
        "filename": "chrome/browser/profiles/avatar_menu_desktop.cc",
        "patchSetId": 29
      },
      "lineNbr": 45,
      "author": {
        "id": 1228990
      },
      "writtenOn": "2017-08-14T18:56:34Z",
      "side": 1,
      "message": "Actually I wanted to say \"use default avatar because GAIA image is missing\". Sorry I made it confusing.\n\nYour proposal of the new enums SGTM, except that maybe it\u0027s better to use \"GAIA_LOADING\" and \"GAIA_MISSING\". I think a return of \"MISSING\" status is confusing as it sounds like the image load fails and we should call some error handler instead of painting. However, it\u0027s the GAIA image missing and the API has fallen back to the default avatar image. In this case, we treat it as a load success and do the paint.\n\nI\u0027ve added comments to the enums to avoid any confusing.",
      "parentUuid": "ef8fd5bc_569123aa",
      "range": {
        "startLine": 45,
        "startChar": 32,
        "endLine": 45,
        "endChar": 43
      },
      "revId": "a2fc727f2bead506be86ece217bff6a6d56d1e8f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4c6b7e41_8d668941",
        "filename": "chrome/browser/profiles/avatar_menu_desktop.cc",
        "patchSetId": 29
      },
      "lineNbr": 45,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-08-14T22:20:08Z",
      "side": 1,
      "message": "\u003e Actually I wanted to say \"use default avatar because GAIA image is missing\". Sorry I made it confusing.\n\u003e \n\u003e Your proposal of the new enums SGTM, except that maybe it\u0027s better to use \"GAIA_LOADING\" and \"GAIA_MISSING\". I think a return of \"MISSING\" status is confusing as it sounds like the image load fails and we should call some error handler instead of painting. However, it\u0027s the GAIA image missing and the API has fallen back to the default avatar image. In this case, we treat it as a load success and do the paint.\n\nIMO Prefixing with GAIA does not clarify this distinction, the comment does. But if you feel it really helps, leave it in.\n\n\u003e I\u0027ve added comments to the enums to avoid any confusing.",
      "parentUuid": "90820803_8e0b5384",
      "range": {
        "startLine": 45,
        "startChar": 32,
        "endLine": 45,
        "endChar": 43
      },
      "revId": "a2fc727f2bead506be86ece217bff6a6d56d1e8f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7e72e849_b5a2035b",
        "filename": "chrome/browser/ui/views/frame/browser_non_client_frame_view.cc",
        "patchSetId": 29
      },
      "lineNbr": 341,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-08-14T16:22:54Z",
      "side": 1,
      "message": "Can you add test coverage?",
      "range": {
        "startLine": 341,
        "startChar": 7,
        "endLine": 341,
        "endChar": 48
      },
      "revId": "a2fc727f2bead506be86ece217bff6a6d56d1e8f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a2d35dab_9e11ec9f",
        "filename": "chrome/browser/ui/views/frame/browser_non_client_frame_view.cc",
        "patchSetId": 29
      },
      "lineNbr": 341,
      "author": {
        "id": 1228990
      },
      "writtenOn": "2017-08-14T18:56:34Z",
      "side": 1,
      "message": "Honestly, I have spent days on adding test coverage for this, but unfortunately cannot get it work. It has driven me into nuts.\n\nFirst, since I have added unit test for AvatarMenu::GetImageForMenuButton() in profile_info_cache_unittest.cc, I think the if-condition of |status| added here is well covered. Second, the cause of the bug is that BrowserNonClientFrameView didn\u0027t override the OnProfileHighResAvatarLoaded observer function I added in line 302.\n\nTo test the observer function, it seems that I must use TestWithBrowserView to initialize a  BrowserNonClientFrameView object, since the frame view cannot survive without a browser view. In the constructor of BrowserNonClientFrameView, it detects if there\u0027s a profile manager available. If there is one, BrowserNonClientFrameView makes it an observer of the profile manager. Since the browser process associated with TestWithBrowserView doesn\u0027t have a profile manager, we need to use TestingProfileManager and set it up before the browser view (so that the BrowserNonClientFrameView can detect it in its constructor). Finally, TestWithBrowserView resets the local_state_ in its SetUp() method and made the test crash/fail constantly.\n\nI am also not seeing this OnProfile* observer methods tested in the way I am doing anywhere else, so I start to wonder if it\u0027s practical or preferable to test it in this way. Any suggestion please?\n\nI am not rushing this fix, but unfortunately I\u0027m losing my free cycles for this task now. No one seems to have time for this bug so this bug got bounced back and forth a few times before got assigned to me. I saw users keep complaining about this so I decided to stop my main task and fix this bug for them now. I am thinking if we can let the fix meet the users first and add the test (to avoid regression) later when I have free cycles again (with a bug filed for adding the test and assigned to myself). Otherwise, I have to slow down the progress for this task now as I am pretty stressed about my main task. Thanks for understanding and please let me know what you think please.",
      "parentUuid": "7e72e849_b5a2035b",
      "range": {
        "startLine": 341,
        "startChar": 7,
        "endLine": 341,
        "endChar": 48
      },
      "revId": "a2fc727f2bead506be86ece217bff6a6d56d1e8f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8ba90ee3_37a03124",
        "filename": "chrome/browser/ui/views/frame/browser_non_client_frame_view.cc",
        "patchSetId": 29
      },
      "lineNbr": 341,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-08-14T22:20:08Z",
      "side": 1,
      "message": "\u003e Honestly, I have spent days on adding test coverage for this, but unfortunately cannot get it work. It has driven me into nuts.\n\u003e \n\u003e First, since I have added unit test for AvatarMenu::GetImageForMenuButton() in profile_info_cache_unittest.cc, I think the if-condition of |status| added here is well covered. Second, the cause of the bug is that BrowserNonClientFrameView didn\u0027t override the OnProfileHighResAvatarLoaded observer function I added in line 302.\n\u003e \n\nAgreed. The interesting part is GetImageForMenuButtons.\n\n\u003e To test the observer function, it seems that I must use TestWithBrowserView to initialize a  BrowserNonClientFrameView object, since the frame view cannot survive without a browser view. In the constructor of BrowserNonClientFrameView, it detects if there\u0027s a profile manager available. If there is one, BrowserNonClientFrameView makes it an observer of the profile manager. Since the browser process associated with TestWithBrowserView doesn\u0027t have a profile manager, we need to use TestingProfileManager and set it up before the browser view (so that the BrowserNonClientFrameView can detect it in its constructor). Finally, TestWithBrowserView resets the local_state_ in its SetUp() method and made the test crash/fail constantly.\n\u003e \n\u003e I am also not seeing this OnProfile* observer methods tested in the way I am doing anywhere else, so I start to wonder if it\u0027s practical or preferable to test it in this way. Any suggestion please?\n\nI would have to dig into understand this. Seems like you should be able to create a ProfileManager in the test setup, but as I am not familiar with the specifics I don\u0027t know exactly the wiring you need.\n\n\u003e I am not rushing this fix, but unfortunately I\u0027m losing my free cycles for this task now. No one seems to have time for this bug so this bug got bounced back and forth a few times before got assigned to me. I saw users keep complaining about this so I decided to stop my main task and fix this bug for them now. I am thinking if we can let the fix meet the users first and add the test (to avoid regression) later when I have free cycles again (with a bug filed for adding the test and assigned to myself). Otherwise, I have to slow down the progress for this task now as I am pretty stressed about my main task. Thanks for understanding and please let me know what you think please.\n\nI agree the important part is the GetImageForMenuButtons, so I\u0027m ok with only that.",
      "parentUuid": "a2d35dab_9e11ec9f",
      "range": {
        "startLine": 341,
        "startChar": 7,
        "endLine": 341,
        "endChar": 48
      },
      "revId": "a2fc727f2bead506be86ece217bff6a6d56d1e8f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "7b532fca_7deacc12",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 137,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-01-31T03:15:30Z",
      "side": 1,
      "message": "Optional nit: consider dropping |result| local variable",
      "range": {
        "startLine": 137,
        "startChar": 16,
        "endLine": 137,
        "endChar": 22
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b256f97d_1db517cc",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 137,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2018-01-31T20:06:45Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "7b532fca_7deacc12",
      "range": {
        "startLine": 137,
        "startChar": 16,
        "endLine": 137,
        "endChar": 22
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6fb3e591_c7d13781",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 144,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-01-31T03:15:30Z",
      "side": 1,
      "message": "ditto",
      "range": {
        "startLine": 144,
        "startChar": 25,
        "endLine": 144,
        "endChar": 29
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "99a3b2e1_7aecb15f",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 144,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2018-01-31T20:06:45Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6fb3e591_c7d13781",
      "range": {
        "startLine": 144,
        "startChar": 25,
        "endLine": 144,
        "endChar": 29
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bb98c984_ed13f22b",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 157,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-01-31T03:15:30Z",
      "side": 1,
      "message": "Normally in EG tests we create helpers for matchers, or actions. Wrapping |performAction:| calls into helpers makes logging less useful (performAction: prints line number, which is rarely useful when log points to a helper). We have some EG tests for context menu, which also uses action sheet on the phone and popover on iPad. Can we use the same approach here?",
      "range": {
        "startLine": 157,
        "startChar": 5,
        "endLine": 157,
        "endChar": 29
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e76c62cd_3ffc860a",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 157,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2018-01-31T20:06:45Z",
      "side": 1,
      "message": "The technique used in context_menu_egtest does not seem applicable here. It matches a button with a specific label in the popover / action sheet. The issue is that there is no \"cancel\" button in the form repost confirmation popover on iPad. Tapping anywhere outside the popover is treated as cancel, which is what\u0027s simulated here...\n\nI changed this helper to only return the matcher so logging can still be useful.",
      "parentUuid": "bb98c984_ed13f22b",
      "range": {
        "startLine": 157,
        "startChar": 5,
        "endLine": 157,
        "endChar": 29
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d05daba4_e51fbbee",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 157,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-01-31T21:57:49Z",
      "side": 1,
      "message": "Context Menu popover does not have cancel button on iPad as well (would ElementToDismissContextMenu work for you?)",
      "parentUuid": "e76c62cd_3ffc860a",
      "range": {
        "startLine": 157,
        "startChar": 5,
        "endLine": 157,
        "endChar": 29
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4b5da39b_b83d263b",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 157,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2018-01-31T23:41:04Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "d05daba4_e51fbbee",
      "range": {
        "startLine": 157,
        "startChar": 5,
        "endLine": 157,
        "endChar": 29
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1f039924_db22a993",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 157,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2018-01-31T23:41:04Z",
      "side": 1,
      "message": "Ah I missed ElementToDismissContextMenu. It works nicely.",
      "parentUuid": "d05daba4_e51fbbee",
      "range": {
        "startLine": 157,
        "startChar": 5,
        "endLine": 157,
        "endChar": 29
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9b00a7f4_6e77cbe9",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 268,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-01-31T03:15:30Z",
      "side": 1,
      "message": "I remember Chrome on desktop and Android used to show form resubmission UI for back forward navigations. Charlie, by any chance do you know id we made this change intentionally in Chrome?",
      "range": {
        "startLine": 268,
        "startChar": 31,
        "endLine": 268,
        "endChar": 37
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0df0ed49_4891ed0e",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 268,
      "author": {
        "id": 1001216
      },
      "writtenOn": "2018-01-31T06:50:20Z",
      "side": 1,
      "message": "\u003e I remember Chrome on desktop and Android used to show form resubmission UI for back forward navigations. Charlie, by any chance do you know id we made this change intentionally in Chrome?\n\nSorry, I\u0027m not familiar with changes to form resubmission, and I\u0027m not sure who\u0027s worked on it over time.",
      "parentUuid": "9b00a7f4_6e77cbe9",
      "range": {
        "startLine": 268,
        "startChar": 31,
        "endLine": 268,
        "endChar": 37
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f14938f2_76e37539",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 268,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2018-01-31T20:06:45Z",
      "side": 1,
      "message": "From what I can tell, there is some kind of cache that affects whether a back/forward navigation would be considered a form repost. In Safari, if I navigate sufficiently far away from the form post page, and then navigate back, that navigation sometimes triggers the repost warning. This is clear in WebKit code: https://github.com/WebKit/webkit/blob/2c6fda85fe8008030de50d87e32cdb6af748fe3e/Source/WebCore/loader/FrameLoader.cpp#L3481\n\nThe Blink code is less clear:\nhttps://cs.chromium.org/chromium/src/third_party/WebKit/Source/core/loader/FrameLoader.cpp?sq\u003dpackage:chromium\u0026dr\u0026l\u003d800\nPerhaps the cache behavior happens at a layer below content so any load visible to content should be considered repost?\n\nBtw, Firefox behaves the same as Safari and Blink.\n\nSo there is some risk that this test may become flakey if [ChromeEarlGrey goBack] results in a cache miss for whatever reason. I haven\u0027t seen it in testing so far... I\u0027m not sure how to mitigate this issue. I\u0027m tempted to update the test and see if it becomes a problem.\n\nEugene, what do you think?",
      "parentUuid": "0df0ed49_4891ed0e",
      "range": {
        "startLine": 268,
        "startChar": 31,
        "endLine": 268,
        "endChar": 37
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ded7569a_76c5e31e",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 268,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-01-31T21:57:49Z",
      "side": 1,
      "message": "Still trying to understand what\u0027s going on in WKWebView. Are the following statements true?:\n - Safari does not show report form dialog for fast back-forward navigations\n - Safari shows report form dialog for slow back-forward navigations \n - decidePolicyForNavigationRequest is not called for fast back-forward navigations\n\nIf these are true then the tests will definitely be flaky. In which case we should do something like PurgeCachedWebViewPages(), which is used in VisibleURLTestCase.",
      "parentUuid": "f14938f2_76e37539",
      "range": {
        "startLine": 268,
        "startChar": 31,
        "endLine": 268,
        "endChar": 37
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9d4e26b5_04e326f5",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 268,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2018-01-31T23:41:04Z",
      "side": 1,
      "message": "\u003e Still trying to understand what\u0027s going on in WKWebView. Are the following statements true?:\n\u003e  - Safari does not show report form dialog for fast back-forward navigations\nYes\n\u003e  - Safari shows report form dialog for slow back-forward navigations \nYes\n\u003e  - decidePolicyForNavigationRequest is not called for fast back-forward navigations\nNo. decidePolicyForNavigationRequest[sic] is called for fast back-forward navigation, but with WKNavigationTypeBackForward instead of WKNavigationTypeFormResubmitted.\n\nI prototyped decidePolicyForNavigationAction callback to also warn repost for WKNavigationTypeBackForward. This way we won\u0027t have test flakes regardless whether the back-forward navigations are fast or slow. This essentially preserves the current Bling behavior.\n\nI chose this over using PurgeCachedWebViewPages() because purging will trigger history restoration. restore_session.html currently can\u0027t restore POST request (so the page will be loaded without POST body), so it won\u0027t recognize the navigation as repost at all.\n\nA problem with this approach is that under fast back-forward navigation, if user clicks on \"Continue\", it\u0027s not actually a repost. We can fix this by forcing a reload in decidePolicyForNavigationAction (not yet implemented in this CL).\n\nAlternatively, we can match Safari behavior, and mitigate the flakiness in test using this pattern:\n\n[ChromeEarlGrey goBack]\nNSError* error;\n[[EarlGrey selectElementWithMatcher:resendWarning] performAction:grey_longPress() error:\u0026error];\nif (error) {\n  // fast back-forward navigation didn\u0027t trigger repost\n  [ChromeEarlGrey reload];\n  [self confirmResendWarning];\n}\n\nI\u0027m leaning towards the last option (i.e. match Safari and mitigate test flakes). WDYT?",
      "parentUuid": "ded7569a_76c5e31e",
      "range": {
        "startLine": 268,
        "startChar": 31,
        "endLine": 268,
        "endChar": 37
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7ef8d5fa_785e50a4",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 268,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-02-01T01:45:23Z",
      "side": 1,
      "message": "The last option will not catch the bug if Chrome stop showing form repost dialog for all back-forward navigations. I think it is better to have predictable behavior (like your option #1).",
      "parentUuid": "9d4e26b5_04e326f5",
      "range": {
        "startLine": 268,
        "startChar": 31,
        "endLine": 268,
        "endChar": 37
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "aa1f7122_cc132aab",
        "filename": "ios/chrome/browser/web/forms_egtest.mm",
        "patchSetId": 2
      },
      "lineNbr": 268,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2018-02-01T15:37:31Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "7ef8d5fa_785e50a4",
      "range": {
        "startLine": 268,
        "startChar": 31,
        "endLine": 268,
        "endChar": 37
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2c2e5257_5592d7d6",
        "filename": "ios/web/web_state/ui/crw_web_controller.mm",
        "patchSetId": 2
      },
      "lineNbr": 1950,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-01-31T03:15:30Z",
      "side": 1,
      "message": "Does this fix testCachingBehaviorOnNavigateBackAndPageReload by any chance?",
      "range": {
        "startLine": 1950,
        "startChar": 18,
        "endLine": 1950,
        "endChar": 24
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "77ecd704_2a7d1f21",
        "filename": "ios/web/web_state/ui/crw_web_controller.mm",
        "patchSetId": 2
      },
      "lineNbr": 1950,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2018-01-31T20:06:45Z",
      "side": 1,
      "message": "No... WebKit sends \"Cache-Control: no-cache\" on reload instead of \"Cache-Control: max-age\u003d0\", which Chrome and Firefox sends. AFAICT, these are semantically identical, though it does seem a compat issue. I\u0027ll follow up separately to see if there\u0027s a reason why one should be used versus another. Do you know any off the top of your head?",
      "parentUuid": "2c2e5257_5592d7d6",
      "range": {
        "startLine": 1950,
        "startChar": 18,
        "endLine": 1950,
        "endChar": 24
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "41783b32_c94d6675",
        "filename": "ios/web/web_state/ui/crw_web_controller.mm",
        "patchSetId": 2
      },
      "lineNbr": 1950,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-01-31T21:57:49Z",
      "side": 1,
      "message": "No :(",
      "parentUuid": "77ecd704_2a7d1f21",
      "range": {
        "startLine": 1950,
        "startChar": 18,
        "endLine": 1950,
        "endChar": 24
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8329f3c6_9b3d5b25",
        "filename": "ios/web/web_state/ui/crw_web_controller.mm",
        "patchSetId": 2
      },
      "lineNbr": 4216,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-01-31T03:15:30Z",
      "side": 1,
      "message": "It may sound surprising, but calling this callback asynchronously can break certain things (\nlike loadHTML API):\nhttps://chromium-review.googlesource.com/782744\n\nThis may not be a problem for form reposts navigations, but you still you be aware about our unsuccessful attempt to call this asynchronously.",
      "range": {
        "startLine": 4216,
        "startChar": 14,
        "endLine": 4216,
        "endChar": 29
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "176104db_8eaadc4b",
        "filename": "ios/web/web_state/ui/crw_web_controller.mm",
        "patchSetId": 2
      },
      "lineNbr": 4216,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2018-01-31T20:06:45Z",
      "side": 1,
      "message": "Thanks for calling it out! It might be related to https://bugs.webkit.org/show_bug.cgi?id\u003d53785, and I\u0027m helping the Apple fix https://bugs.webkit.org/show_bug.cgi?id\u003d180568 to make decidePolicy async again.\n\nIs there a way for us to block until we get a callback from the dialog?",
      "parentUuid": "8329f3c6_9b3d5b25",
      "range": {
        "startLine": 4216,
        "startChar": 14,
        "endLine": 4216,
        "endChar": 29
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "af06d126_8fceab17",
        "filename": "ios/web/web_state/ui/crw_web_controller.mm",
        "patchSetId": 2
      },
      "lineNbr": 4216,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2018-01-31T21:57:49Z",
      "side": 1,
      "message": "There is a way (spin NSRunLoop), but we should not use this technique in production code as it may break other things. We can land this and see if there are any issues with async callback.",
      "parentUuid": "176104db_8eaadc4b",
      "range": {
        "startLine": 4216,
        "startChar": 14,
        "endLine": 4216,
        "endChar": 29
      },
      "revId": "e668aa966fa2fd08936fb3728827090b2a178438",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "1e3d4ce6_9bdcfff3",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1000023
      },
      "writtenOn": "2017-08-18T15:28:03Z",
      "side": 1,
      "message": "Virtual URLs are for display to a user; why are you using it rather than GetURL()?",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f4d6d0c0_c8820888",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1142059
      },
      "writtenOn": "2017-08-18T16:11:30Z",
      "side": 1,
      "message": "As discussed offline, moved this to WebContents::GetLastCommittedURL, which uses virtual urls in its implementation :)\n\nThis doesn\u0027t solve the particular worry, but since this is a very common technique for using content settings, we should probably figure out a solution at the WebContents level.\n\nMartin, I\u0027ve ccd you in case you have any experience with this particular problem.",
      "parentUuid": "1e3d4ce6_9bdcfff3",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2cd9fce1_8f10d727",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1000023
      },
      "writtenOn": "2017-08-18T16:47:40Z",
      "side": 1,
      "message": "This has now spun off into a discussion with my colleagues of eliminating virtual urls entirely.\n\nCongrats!",
      "parentUuid": "f4d6d0c0_c8820888",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "44432fae_7d3c42fc",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1142059
      },
      "writtenOn": "2017-08-18T16:52:13Z",
      "side": 1,
      "message": "Nice, very curious to hear the outcome :)",
      "parentUuid": "2cd9fce1_8f10d727",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b4ae892b_b2cb457e",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1118331
      },
      "writtenOn": "2017-08-18T16:56:40Z",
      "side": 1,
      "message": "Not sure which particular problem, but IMHO GetLastCommittedURL() is correct, exactly for the reasons which you already explained in the .h file.\n\nI would perhaps add that setting window.location.hash or calling history.pushState() may bring you to a different URL than the one which opened the popup, but certainly on the same origin. That\u0027s what matters for permissions (I didn\u0027t read much of the code, but I assume this URL is checked against the content setting?).",
      "parentUuid": "f4d6d0c0_c8820888",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2a13efd7_4ebb54ae",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1142059
      },
      "writtenOn": "2017-08-18T16:59:50Z",
      "side": 1,
      "message": "Yes the last committed URL is correct, but should we use the \"raw\" version of the URL, or the \"virtual\" version?\n\nVirtual URL (if I understand my history correctly) was originally mainly for the omnibox, where some URLs (not exactly sure which...) get re-written to be cleaner / more user friendly. I am not sure what security/privacy implications this has for content settings exactly.",
      "parentUuid": "b4ae892b_b2cb457e",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5f98e229_ae26b473",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1118331
      },
      "writtenOn": "2017-08-18T20:01:41Z",
      "side": 1,
      "message": "Same here. Also not an expert on NavigationEntry et al., but I believe virtual URL is just for display purposes, GetLastComittedURL() is the \"real\" URL for all security purposes.\n\nAs an empirical datapoint, permission_manager.cc uses GetLastComittedURL().",
      "parentUuid": "2a13efd7_4ebb54ae",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ca2d9219_db543390",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1142059
      },
      "writtenOn": "2017-08-18T20:04:09Z",
      "side": 1,
      "message": "The thing is, GetLastCommittedURL() uses the virtual URL of the last committed entry :)\n\nhttps://cs.chromium.org/chromium/src/content/browser/web_contents/web_contents_impl.cc?rcl\u003ddc9b6255da39f347a70048695430a6313417ba15\u0026l\u003d911",
      "parentUuid": "5f98e229_ae26b473",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2751d2e1_cd25cd7c",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1118331
      },
      "writtenOn": "2017-08-18T20:29:37Z",
      "side": 1,
      "message": "OK, I can\u0027t explain that :) Hopefully Scott can.\n\nIt seems that an interstitial is one example of a virtual URL. If I understand correctly, the page behind the interstitial is the virtual URL in the omnibox, whereas the real URL is the local one where the interstitial is hosted. Now the question is - if a safebrowsing interstitial decided to show popups (which it won\u0027t), whom should they be attributed? Apparently to the website behind the interstitial.\n\nBut pragmatically, if this code used virtual url and you now rewrite it to last committed, which seems to be the same thing, you\u0027re not breaking anything. You might be propagating an existing bug if the raw URL is the correct one, but I don\u0027t think so; as I said, PermissionManager also uses last committed.",
      "parentUuid": "ca2d9219_db543390",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5112b642_8b4338b8",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1142059
      },
      "writtenOn": "2017-08-18T20:33:48Z",
      "side": 1,
      "message": "Yeah good point wrt interstitial, I suspect that is all subject to change with the recent project to de-insanify interstitials though (e.g. make them real committed navs).\n\nIn any case yeah I agree I am not changing behavior with this CL, and it looks like content owners are now discussing removing virtual URLs entirely, so would help simplify this a lot.",
      "parentUuid": "2751d2e1_cd25cd7c",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7f3e3162_0f36be92",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 94,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-08-18T22:35:43Z",
      "side": 1,
      "message": "It seems like you guys decided not to touch this code, meaning you don\u0027t have a question anymore for me. I don\u0027t think I could answer the question here anyway...",
      "parentUuid": "5112b642_8b4338b8",
      "range": {
        "startLine": 94,
        "startChar": 24,
        "endLine": 94,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9508f56c_7257a467",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 104,
      "author": {
        "id": 1000023
      },
      "writtenOn": "2017-08-18T15:28:03Z",
      "side": 1,
      "message": "Why the hard check? This doesn\u0027t seem crashworthy to me.\n\n(In the long term we should get rid of one of those two copies of the variable.)",
      "range": {
        "startLine": 104,
        "startChar": 2,
        "endLine": 104,
        "endChar": 7
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1e9a3b3b_810822cf",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 104,
      "author": {
        "id": 1142059
      },
      "writtenOn": "2017-08-18T16:11:30Z",
      "side": 1,
      "message": "Sure, turned into DCHECK. I only kept this because existing code had it.",
      "parentUuid": "9508f56c_7257a467",
      "range": {
        "startLine": 104,
        "startChar": 2,
        "endLine": 104,
        "endChar": 7
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0d8b058f_8150addd",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 111,
      "author": {
        "id": 1000023
      },
      "writtenOn": "2017-08-18T15:28:03Z",
      "side": 1,
      "message": "Adding knowledge of the prerender code to the popup blocker feels off.\n\nPopupBlockerTabHelper::MaybeBlockPopup is called from two places.\n\nOne is Browser::OpenURLFromTab. But the prerender code sets the delegate of its prerender WebContentses to be PrerenderContents::WebContentsDelegateImpl, so this condition will never be true when called this way.\n\nThe other is ChromeContentBrowserClient::CanCreateWindow. ChromeContentBrowserClient already knows about prerender, so can we move this block of \"if prerender disallow\" to be one of the many disqualifications in ChromeContentBrowserClient::CanCreateWindow before calling PopupBlockerTabHelper::MaybeBlockPopup?",
      "range": {
        "startLine": 111,
        "startChar": 5,
        "endLine": 111,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2a8ada76_87d86ed8",
        "filename": "chrome/browser/ui/blocked_content/popup_blocker_tab_helper.cc",
        "patchSetId": 5
      },
      "lineNbr": 111,
      "author": {
        "id": 1142059
      },
      "writtenOn": "2017-08-18T16:11:30Z",
      "side": 1,
      "message": "I see, yes I like that solution best. Done",
      "parentUuid": "0d8b058f_8150addd",
      "range": {
        "startLine": 111,
        "startChar": 5,
        "endLine": 111,
        "endChar": 37
      },
      "revId": "3ab9848169dc144d08c1dac6bde3465b4296a204",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
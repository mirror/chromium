{
  "comments": [
    {
      "key": {
        "uuid": "889e4c25_46364fd1",
        "filename": "ios/chrome/browser/metrics/tab_usage_recorder_egtest.mm",
        "patchSetId": 1
      },
      "lineNbr": 233,
      "author": {
        "id": 1134915
      },
      "writtenOn": "2017-06-19T15:09:12Z",
      "side": 1,
      "message": "This is probably not the best fix, but a first baseline for this WIP CL. Can you advise on how to evolve it to a better standard?",
      "range": {
        "startLine": 233,
        "startChar": 15,
        "endLine": 233,
        "endChar": 56
      },
      "revId": "1ddbebaad201d901901aaed46f8915f98f55a1ff",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "eeac6b75_d418fc62",
        "filename": "ios/chrome/browser/metrics/tab_usage_recorder_egtest.mm",
        "patchSetId": 1
      },
      "lineNbr": 233,
      "author": {
        "id": 1164104
      },
      "writtenOn": "2017-06-20T17:52:50Z",
      "side": 1,
      "message": "Do we understand why this is failing on iOS 9 iPhone simulator?\n\nOriginally, the matcher |WebViewContainingText| waits for the web view to contain specific text, however, a matcher should not wait, and that\u0027s why this line was replaced by |waitForWebViewContainingText|, so |waitForWebViewContainingText| is probably the right way to go. I think we need to figure out why |waitForWebViewContainingText| doesn\u0027t work for this test, maybe there is a bug in the helper functions.",
      "parentUuid": "889e4c25_46364fd1",
      "range": {
        "startLine": 233,
        "startChar": 15,
        "endLine": 233,
        "endChar": 56
      },
      "revId": "1ddbebaad201d901901aaed46f8915f98f55a1ff",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "97edbc5e_fb94a3da",
        "filename": "ios/chrome/browser/metrics/tab_usage_recorder_egtest.mm",
        "patchSetId": 1
      },
      "lineNbr": 233,
      "author": {
        "id": 1134915
      },
      "writtenOn": "2017-06-21T09:42:41Z",
      "side": 1,
      "message": "It is failing on the line below: it waits for 3 tabs to open, but there are only two. I guess it\u0027s because this matcher matches on the first tab and doesn\u0027t really wait for the two others to open. So only the second has the time to open, not the third.\n\nI added a [[GREYUIThreadExecutor sharedInstance] drainUntilIdle]; and it fixes the test. See latest patch. The issue might just be this test that waits for something to appear that is similar to something already on screen.",
      "parentUuid": "eeac6b75_d418fc62",
      "range": {
        "startLine": 233,
        "startChar": 15,
        "endLine": 233,
        "endChar": 56
      },
      "revId": "1ddbebaad201d901901aaed46f8915f98f55a1ff",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0454ed53_4c4ecfe9",
        "filename": "ios/chrome/browser/metrics/tab_usage_recorder_egtest.mm",
        "patchSetId": 1
      },
      "lineNbr": 233,
      "author": {
        "id": 1164104
      },
      "writtenOn": "2017-06-21T16:27:51Z",
      "side": 1,
      "message": "ha! I see, it\u0027s because all the three tabs we open have the same URL and the same content, so [ChromeEarlGrey waitForWebViewContainingText:kURL1FirstWord]; doesn\u0027t really help at all as it always succeeds no matter which tab we\u0027re in.\n\nHow about?\n\n  for (NSUInteger i \u003d 0; i \u003c numberOfTabs; i++) {\n    chrome_test_util::OpenNewTab();\n    [ChromeEarlGrey loadURL:url1];\n    [ChromeEarlGrey waitForWebViewContainingText:kURL1FirstWord];\n    chrome_test_util::AssertMainTabCount(i + 1);\n  }\n\nAnd remove the chrome_test_util::AssertMainTabCount(numberOfTabs);\n\nI think this way it\u0027s clearer that we\u0027re waiting for the tab to be opened instead of other UI parts. Let me know how you think of it.\n\nIn either cause, could you please add a short comment explaining why [ChromeEarlGrey waitForWebViewContainingText:kURL1FirstWord]; alone doesn\u0027t work?",
      "parentUuid": "97edbc5e_fb94a3da",
      "range": {
        "startLine": 233,
        "startChar": 15,
        "endLine": 233,
        "endChar": 56
      },
      "revId": "1ddbebaad201d901901aaed46f8915f98f55a1ff",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "320a984c_cd079516",
        "filename": "ios/chrome/browser/metrics/tab_usage_recorder_egtest.mm",
        "patchSetId": 1
      },
      "lineNbr": 233,
      "author": {
        "id": 1134915
      },
      "writtenOn": "2017-06-21T17:32:28Z",
      "side": 1,
      "message": "Actually, I don\u0027t find it cleaner. It relies on (and hides) the fact that AssertMainTabCount calls drainUntilIdle.\n\nI tried this approach:\n  chrome_test_util::OpenNewTab();\n  [ChromeEarlGrey loadURL:url1];\n  [ChromeEarlGrey waitForWebViewContainingText:kURL1FirstWord];\n  chrome_test_util::OpenNewTab();\n  [ChromeEarlGrey loadURL:url2];\n  [ChromeEarlGrey waitForWebViewContainingText:kURL2FirstWord];\n  chrome_test_util::OpenNewTab();\n  [ChromeEarlGrey loadURL:url3];\n  [ChromeEarlGrey waitForWebViewContainingText:kURL3FirstWord];\n  chrome_test_util::AssertMainTabCount(3);\n\nIt fails too at the AssertMainTabCount. The UI shows two tabs, so I don\u0027t understand how waitForWebViewContainingText:kURL3FirstWord passed. Maybe it\u0027s because chrome_test_util::GetCurrentWebState used in waitForWebViewContainingText points to the new webstate, but it\u0027s not yet displayed? But it seems like what the old code did.\n\nI am at a loss and not sure what to do next. Maybe the old code path starting at https://cs.chromium.org/chromium/src/ios/web/public/test/earl_grey/web_view_matchers.mm?type\u003dcs\u0026q\u003d%22DescribeToBlock+describe+%3D+%5E(id%3CGREYDescription%3E+description)+%7B%22\u0026sq\u003dpackage:chromium\u0026l\u003d111 did a drainUntilIdle at some point and made it work?",
      "parentUuid": "0454ed53_4c4ecfe9",
      "range": {
        "startLine": 233,
        "startChar": 15,
        "endLine": 233,
        "endChar": 56
      },
      "revId": "1ddbebaad201d901901aaed46f8915f98f55a1ff",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9d85a0be_fe6cf32d",
        "filename": "ios/chrome/browser/metrics/tab_usage_recorder_egtest.mm",
        "patchSetId": 1
      },
      "lineNbr": 233,
      "author": {
        "id": 1164104
      },
      "writtenOn": "2017-06-21T18:00:52Z",
      "side": 1,
      "message": "Yeah, I think you are right, I didn\u0027t find where exactly drainUntilIdle is called, but when you |assertWithMatcher|, EarlGrey does something to synchronize the UI and waits for the UI thread to become idle.\n\n|AssertMainTabCount| is a bad name, it\u0027s not only asserting, but it\u0027s also waiting, so it should be refactored to something like [ChromeEarlGrey waitForMainTabCount:], then I think it should be more intuitive that waitForMainTabCount relies on drainUntilIdle. I\u0027ll file a bug for that.\n\nIn this CL, I think I\u0027m fine with either drainUntilIdle or AssertMainTabCount. lgtm!\n\nThanks for working on this!",
      "parentUuid": "320a984c_cd079516",
      "range": {
        "startLine": 233,
        "startChar": 15,
        "endLine": 233,
        "endChar": 56
      },
      "revId": "1ddbebaad201d901901aaed46f8915f98f55a1ff",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
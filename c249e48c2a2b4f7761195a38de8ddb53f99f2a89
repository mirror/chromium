{
  "comments": [
    {
      "key": {
        "uuid": "329ef2c5_b25dddfe",
        "filename": "content/browser/web_contents/web_contents_impl.cc",
        "patchSetId": 2
      },
      "lineNbr": 815,
      "author": {
        "id": 1130134
      },
      "writtenOn": "2017-10-04T22:58:19Z",
      "side": 1,
      "message": "It is unfortunate that this CL preserves this ugliness, rather than having WebUIImpl handle IPC messages by overriding WebContentsObserver::OnMessageReceived(const IPC::Message\u0026, RenderFrameHost* sender).  Unfortunately making WebUIImpl implement WebContentsObserver leads to other issues (e.g. when to stop observing, what to do with conflicting method names like WebUIImpl::RenderFrameCreated).",
      "range": {
        "startLine": 811,
        "startChar": 0,
        "endLine": 815,
        "endChar": 3
      },
      "revId": "c249e48c2a2b4f7761195a38de8ddb53f99f2a89",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c19c2a2f_5251305a",
        "filename": "content/browser/webui/web_ui_impl.cc",
        "patchSetId": 2
      },
      "lineNbr": 113,
      "author": {
        "id": 1130134
      },
      "writtenOn": "2017-10-04T22:58:19Z",
      "side": 1,
      "message": "This seems like a good reason for landing the CL, right?  We get a more correct security checks + we will be able to remove WebContents::GetRenderProcessHost.  Yay?\n\nNote that the security checks are agnostic-to and compatible-with all of 1) disallowing any web pages in WebUI, 2) disallowing any subframes in WebUI, 3) pushing webframes in WebUI to OOPIFs.",
      "range": {
        "startLine": 112,
        "startChar": 0,
        "endLine": 113,
        "endChar": 43
      },
      "revId": "c249e48c2a2b4f7761195a38de8ddb53f99f2a89",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7fb89527_e6cea1a5",
        "filename": "content/common/frame_messages.h",
        "patchSetId": 2
      },
      "lineNbr": 1693,
      "author": {
        "id": 1130134
      },
      "writtenOn": "2017-10-04T22:58:19Z",
      "side": 1,
      "message": "Ideally, this would be removed, but we cannot quite use RenderFrameHost::GetLastCommittedURL.  One reason is that some WebUI scripts execute before DidCommitProvisionalLoad is sent (see https://crbug.com/766329).",
      "range": {
        "startLine": 1693,
        "startChar": 20,
        "endLine": 1693,
        "endChar": 24
      },
      "revId": "c249e48c2a2b4f7761195a38de8ddb53f99f2a89",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7c260a36_9768d815",
        "filename": "content/common/frame_messages.h",
        "patchSetId": 2
      },
      "lineNbr": 1693,
      "author": {
        "id": 1002169
      },
      "writtenOn": "2017-10-06T18:41:33Z",
      "side": 1,
      "message": "I agree it would be nice to drop this. It seems reasonable to delay the the WebUI script execution until after we send the DidCommit IPC, instead of just before.\n\nTBH, I feel like the SendDidCommitProvisionalLoad in render_frame_impl.cc ought to occur before observers are notified, but that\u0027s just me. Any IPC sent up before the URL commit seems like it would potentially be out-of-order. I wonder if there\u0027s a way to get a list of IPCs that are sent from the observers.",
      "parentUuid": "7fb89527_e6cea1a5",
      "range": {
        "startLine": 1693,
        "startChar": 20,
        "endLine": 1693,
        "endChar": 24
      },
      "revId": "c249e48c2a2b4f7761195a38de8ddb53f99f2a89",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "871066e2_a3f55747",
        "filename": "content/common/frame_messages.h",
        "patchSetId": 2
      },
      "lineNbr": 1693,
      "author": {
        "id": 1130134
      },
      "writtenOn": "2017-10-06T22:18:46Z",
      "side": 1,
      "message": "I agree that SendDidCommitProvisionalLoad should happen before observers are notified, but this is surprisingly difficult... :-(  Copy \u0026 pasting my current notes on the commit-before-scripts stuff:\n\nApproach #1: Postpone notifying the observers\n(https://chromium-review.googlesource.com/671469)\n- Test failures:\n  - SubresourceFilterBrowserTest.PageLoadMetrics (browser_tests)\n  - MultiTabLoadingPageLoadMetricsBrowserTest.MultiTabForeground (browser_tests)\n  - (CrOs) PageLoadMetricsBrowserTest.DocumentWriteReload (mus_browser_tests)\n  - Fix idea #1: Switch to WillCommit\n      - Difficult - MetricsRenderFrameObserver depends on\n        |is_same_document_navigation| arg of DidCommit...\n        this is missing in WillCommit…).  Maybe this argument\n        can be added to WillCommit… as well?\n      - Risk of changing the metrics - if WillCommit… fires\n        earlier, then the metrics measures by MetricsRenderFrameObservers\n        will change - this is undesirable\n  - Fix idea #2: Fix PLM so that it works fine after the change?\n      - TODO: look what goes wrong here...\n\nApproach #2: PostTask to postpone WebUI script execution\n(https://chromium-review.googlesource.com/701420)\n- Test failures:\n  - a bunch of failures in chromevox_tests\n    (e.g. CvoxBrailleDisplayManagerUnitTest.BasicGroup)\n\nI hope that I can make some progress on the above next week (the out-of-order script execution is blocking more verification of localStorage origin - https://chromium-review.googlesource.com/c/chromium/src/+/666317).",
      "parentUuid": "7c260a36_9768d815",
      "range": {
        "startLine": 1693,
        "startChar": 20,
        "endLine": 1693,
        "endChar": 24
      },
      "revId": "c249e48c2a2b4f7761195a38de8ddb53f99f2a89",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ea08fb44_50f08efa",
        "filename": "content/common/view_messages.h",
        "patchSetId": 2
      },
      "lineNbr": 15,
      "author": {
        "id": 1130134
      },
      "writtenOn": "2017-10-04T22:58:19Z",
      "side": 1,
      "message": "These are just fixes for IWYU issues found by |git cl lint|.",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 17
      },
      "revId": "c249e48c2a2b4f7761195a38de8ddb53f99f2a89",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
#! /bin/bash

function usage() {
  echo "Usage: $0 [-h | [-# n] [-v] [-o file] command]";
  echo
  echo "Options:"
  echo "  -h      : Print this message and exit.";
  echo "  -v      : Echo output from opcontrol to std out.";
  echo "  -# n    : Iterate n times. Default is 100.";
  echo "  -o file : Redirect program output to the given file. Default is /dev/null.";
}

TIMES_TO_RUN=100;
OUT='/dev/null';
COMMAND_OUT='/dev/null';

while [ $# -ge 1 ]; do
  case $1 in
    -h )  usage; exit;;
    -# )  shift; TIMES_TO_RUN=$1;;
    -v )  OUT='/dev/stdout' ;;
    -o )  shift; COMMAND_OUT=$1;;
    * ) break;;
  esac
  shift
done

echo -n > $COMMAND_OUT
sudo opcontrol --reset > $OUT;
sudo opcontrol --no-vmlinux > $OUT;
sudo opcontrol --start > $OUT;
for i in `seq 1 $TIMES_TO_RUN`; do
  $@ >> $COMMAND_OUT;
done
sudo opcontrol --shutdown > $OUT;
opreport -l -n $1

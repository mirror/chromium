<h1>OAuth2: Authenticate Users with Google</h1>

<h2 id="set_up">Set up base extension</h2>
<p>
  <!-- TODO include link to starter files -->
  Create a directory and the following files, or download them here.
</p>
<h3 id="manifest">manifes.json</h3>
<pre data-filename="manifest.json">
  {
    "name": "OAuth Tutorial FaceBlock",
    "version": "1.0",
    "description": "Uses OAuth to connect to Google's People API and display contacts photos.",
    "manifest_version": 2,
    "browser_action": {
      "default_title": "FaceBlock, faces in blocks."
    },
    "permissions": [
      "identity"
    ],
    "background": {
      "scripts": [
        "background.js"
      ],
      "persistent": false
    }
  }
</pre>
<h3 id="background">background.js</h3>
<pre data-filename="background.js">
  chrome.browserAction.onClicked.addListener(function(){
      chrome.tabs.create({ 'url' : 'index.html'});
  });
</pre>
<h3 id="index">index.html</h3>
<pre data-filename="index.html">
  &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;FaceBlock&lt;/title&gt;
    &lt;script type="text/javascript" src="oauth.js"&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div id="button"
        style="padding: 10px;
               background-color: #3C79F8;
               display: inline-block;"&gt;FaceBlock Contacts&lt;/div&gt;
      &lt;div id="faceDiv"&gt;
      &lt;/div&gt;
    &lt;/body&gt;
  &lt;/html&gt;
</pre>

<h2 id="upload_to_dashboard">Upload to the Developer Dashboard</h2>
<p>
  Package the extension directory into a <code>.zip</code> file and upload it to the
  <a href="https://chrome.google.com/webstore/developer/dashboard">
    Chrome Developer Dashboard
  </a>
  without publishing it:
</p>
<ol>
  <li>
    At the Developer Dashboard, click "Add new item".
  </li>
  <li>
    Click "Choose file" and select the
    <code>.zip</code> extension directory and upload it.
  </li>
  <li>
    Navigate back to the Developer Dashboard landing page,
    no further information is required.
  </li>
</ol>
<p>
  Find the extension under "Your Listings" and click on "more info".
  From the popup,
  copy the public key and add it to the manifest in the
  <a href="/key"><code>"key"</code></a> field.
</p>
<pre data-filename="manifest.json">
  {
    "name": "OAuth Tutorial FaceBlcok",
  ...
    "key": "ThisKeyIsGoingToBeVeryLong/go8GGC2u3UD9WI3MkmBgyiDPP2OreImEQhPvwpliioUMJmERZK3zPAx72z8MDvGp7Fx7ZlzuZpL4yyp4zXBI+MUhFGoqEh32oYnm4qkS4JpjWva5Ktn4YpAWxd4pSCVs8I4MZms20+yx5OlnlmWQEwQiiIwPPwG1e1jRw0Ak5duPpE3uysVGZXkGhC5FyOFM+oVXwc1kMqrrKnQiMJ3lgh59LjkX4z1cDNX3MomyUMJ+I+DaWC2VdHggB74BNANSd+zkPQeNKg3o7FetlDJya1bk8ofdNBARxHFMBtMXu/ONfCT3Q2kCY9gZDRktmNRiHG/1cXhkIcN1RWrbsCkwIDAQAB"
  }
</pre>
<h2 id="extension_management">Compare IDs</h2>
<p>
  Open the Extensions Management page at
  <code>chrome://extensions</code>,
  enable developer mode
  and upload the unpackaged extension directory.
  Compare the extension ID on the extensions management page
  to the Item ID in the Developer Dashboard.
  They should match.
</p>
<img src="{{static}}/images/oauth2/extension_ids.png"
 height="400"
 alt="The ID of the extension matches in all places.">
<p>
  The extension will maintain the same ID by including
  the <code>"key"</code> field in the manifest.
  Matching IDs is essential for API registration.
</p>
<h2 id="oauth_client">Create OAuth Client ID</h2>
<p>
  Navigate to the
  <a href="https://console.developers.google.com/apis">
    Google API console
  </a>
  and create a new project.
  Once ready,
  select "Credentials" in the sidebar,
  click "Create credentials"
  and choose "OAuth client ID".
</p>
<img src="{{static}}/images/oauth2/create_credentials.png"
 height="400"
 alt="Create credentials for extension.">
<p>
  On the Create client ID page,
  select "Chrome App".
  Fill out the name of the extension
  and place the extension ID at the end of the URL in the
  Application ID field.
</p>
<img src="{{static}}/images/oauth2/register_extension.png"
 height="350"
 alt="Fill out extension information.">
<p>
  Finish by clicking create.
  The console will provide an OAuth client ID.
</p>
<h2 id="oauth_registration">Register OAuth in Manifest</h2>
<p>
  Include the <code>"oauth2"</code> field in the extension manifest.
  Place the generated OAuth client ID in the <code>"client_id"</code>
  variable.
  Include an empty string in <code>"scopes"</code> for now.
</p>
<pre data-filename="manifest.json">
{
  "name": "OAuth Tutorial FaceBlcok",
  ...
  "oauth2": {
    "client_id": "yourExtensionOAuthClientIDWillGoHere.apps.googleusercontent.com",
    "scopes":[""]
  },
  ...
}
</pre>
<h2 id="identity_permission">Initiate First OAuth Flow</h2>
<p>
  Register the <a href="/identity"><code>identity</code></a>
  permission in the manifest.
</p>
<pre data-filename="manifest.json">
  {
    "name": "OAuth Tutorial FaceBlcok",
    ...
    "permissions": [
      "identity"
    ],
    ...
  }
</pre>
<p>
  Create a file to manage the OAuth flow called
  <code>oauth.js</code> and include the following code.
</p>
<pre data-filename="oauth.js">
  window.onload = function() {
    document.querySelector('#button').addEventListener('click', function() {
      chrome.identity.getAuthToken({'interactive': true}, function(token) {
        console.log(token)
      })
    })
  }
</pre>
<p>
  Place a script tag for <code>oauth.js</code> in the head of
  <code>index.html</code>.
</p>
<pre data-filename="index.html">
  ...
    &lt;head&gt;
      &lt;title>FaceBlock&lt;/title&gt;
    &lt;script type="text/javascript" src="oauth.js"&gt;&lt;/script&gt;
    &lt;/head&gt;
  ...
</pre>
<p>
  Reload the extension and click on the browser icon to open
  <code>index.html</code>.
  Open the console and click on the "FaceBlock Contacts"
  button.
  An OAuth token will appear in the console.
</p>
<img src="{{static}}/images/oauth2/first_flow.png"
 height="150"
 alt="View the token in the console.">
<h2 id="enable_people">Enable the Google People API</h2>
<p>
 Return to the Google API console
 and select "Library" from the sidebar.
 Search for "Google People API",
 click on the correct result
 and enable it.
</p>
<img src="{{static}}/images/oauth2/enable_people.png"
 height="250"
 alt="Enable the People API.">
<p>
  Add the
  <a href="https://developers.google.com/people/">
    Google People API
  </a>
  client libary to <code>"scopes"</code> in the extension manifest.
</p>
<pre data-filename="manifest.json">
{
  "name": "OAuth Tutorial FaceBlcok",
  ...
  "oauth2": {
    "client_id": "yourExtensionOAuthClientIDWillGoHere.apps.googleusercontent.com",
    "scopes": [
      "https://www.googleapis.com/auth/contacts.readonly"
    ]
  },
  ...
}
</pre>
<p>
  Return to the Google API console
  and navigate back to credentials.
  Click "Create credentials"
  and select "API key" from the dropdown.
</p>
<img src="{{static}}/images/oauth2/api_credentials.png"
  height="350"
  alt="Create People API credentials.">
<p>
  Keep the generated API key for later use.
</p>
<h2 id="create_call">Create First API Request</h2>
<p>
  Now that the extension has proper permissions, credentials,
  and can authorize a Google user,
  it can request data through the People API.
  Update the code in <code>oauth.js</code>
  to match below.
</p>
<pre data-filename="oauth.js">
  window.onload = function() {
    document.querySelector('#button').addEventListener('click', function() {
      chrome.identity.getAuthToken({'interactive': true}, function(token) {
        var init = {
          'method': 'GET',
          'async': true,
          'headers': {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          'contentType': 'json'
        };
        fetch(
            'https://people.googleapis.com/v1/contactGroups/all?maxMembers=20&key=<API_Key_Here>',
            init)
            .then((response) => response.json())
            .then(function(data) {
              console.log(data)
            })
      })
    })
  }
</pre>
<p>
 Replace <code>&lt;API_Key_Here&gt;</code> with the API key
 generated from the Google API console.
 The extension should log a JSON object
 that includes an array of <code>people/account_id</code>s
 under the <code>memberResourceNames</code> field.
</p>
<h2 id="block_faces">Block Faces</h2>
<p>
  Now that the extension is returning a list of the user's contacts,
  it can make additional requests to
  <a href="https://developers.google.com/people/v1/read-people">
    retrieve those contact's profiles and information
  </a>.
  The extension will use the <code>memberResourceNames</code>
  to retrieve the photo information of user contacts.
  Update <code>oauth.js</code> to include the following code.
</p>
<pre data-filename="oauth.js">
  window.onload = function() {
    document.querySelector('#button').addEventListener('click', function() {
      chrome.identity.getAuthToken({'interactive': true}, function(token) {
        var init = {
          'method': 'GET',
          'async': true,
          'headers': {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          'contentType': 'json'
        };
        fetch(
            'https://people.googleapis.com/v1/contactGroups/all?maxMembers=20&key=<b>&lt;API_Key_Here&gt;</b>',
            init)
            .then((response) => response.json())
            .then(function(data) {
              let photoDiv = document.querySelector('#faceDiv');
              let returnedContacts = data.memberResourceNames;
              for (var i = 0; i &lt; returnedContacts.length;; i++) {
                fetch(
                    'https://people.googleapis.com/v1/' + returnedContacts[i] +
                        '?personFields=photos&key=<b>&lt;API_Key_Here&gt;</b>',
                    init)
                    .then((response) => response.json())
                    .then(function(data) {
                      let profileImg = document.createElement('img');
                      profileImg.src = data.photos[0].url;
                      photoDiv.appendChild(profileImg);
                    })
              }
            })
      })
    })
  }
</pre>
<p>
  Reload and return to the extension.
  Click the FaceBlock button and ta-da!
  Enjoy contact's faces in a block.
</p>
<img src="{{static}}/images/oauth2/faceblock_block.png"
  height="300"
  alt="Contact faces in a block.">
<!-- <p>
<a href="http://oauth.net/">OAuth</a> is an open protocol that aims to standardize the way desktop and web applications access a user's private data. OAuth provides a mechanism for users to grant access to private data without sharing their private credentials (username/password). Many sites have started enabling APIs to use OAuth because of its security and standard set of libraries.
</p>
<p>
This tutorial will walk you through the necessary steps for creating a Google Chrome Extension that uses OAuth to access an API. It leverages a library that you can reuse in your extensions.
</p>
<p>
This tutorial uses the <a href="http://code.google.com/apis/documents/">Google Documents List Data API</a> as an example OAuth-enabled API endpoint.
</p>

<h2 id="requirements">Requirements</h2>

<p>
This tutorial expects that you have some experience writing extensions for Google Chrome and some familiarity with the <a href="http://code.google.com/apis/accounts/docs/OAuth.html">3-legged OAuth</a> flow. Although you don’t need a background in the <a href="http://code.google.com/apis/documents/">Google Documents List Data API</a> (or the other <a href="http://code.google.com/apis/gdata/">Google Data APIs</a> for that matter), having an understanding of the protocol may be helpful.
</p>

<h2 id="getting-started">Getting started</h2>

<p>
First, copy the four library files from the Chromium source tree at <a href="https://chromium.googlesource.com/chromium/src/+/master/chrome/common/extensions/docs/examples/extensions/oauth_contacts/">.../examples/extensions/oauth_contacts/</a>:
</p>
<ul>
<li><strong><a href="examples/extensions/oauth_contacts/chrome_ex_oauth.html" download="chrome_ex_oauth.html">chrome_ex_oauth.html</a></strong> - interstitial page for the oauth_callback URL</li>
<li><strong><a href="examples/extensions/oauth_contacts/chrome_ex_oauth.js" download="chrome_ex_oauth.js">chrome_ex_oauth.js</a></strong> - core OAuth library</li>
<li><strong><a href="examples/extensions/oauth_contacts/chrome_ex_oauthsimple.js" download="chrome_ex_oauthsimple.js">chrome_ex_oauthsimple.js</a></strong> - helpful wrapper for chrome_ex_oauth.js</li>
<li><strong><a href="examples/extensions/oauth_contacts/onload.js" download="onload.js">onload.js</a></strong> -
initializes chrome_ex_oauth.html and redirects the page if needed to start the OAuth flow</li>
</ul>

<p>Place the four library files in the root of your extension directory (or wherever your JavaScript is stored). Then include the .js files in your background page in the following order:</p>

<pre>
&lt;script type="text/javascript" src="chrome_ex_oauthsimple.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="chrome_ex_oauth.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="onload.js"&gt;&lt;/script&gt;
</pre>

<p>Your background page will manage the OAuth flow.</p>

<h2 id="oauth-dance">The OAuth dance in an extension</h2>

<p>
If you are familiar with the OAuth protocol, you'll recall that the OAuth dance consists of three steps:
</p>

<ol>
<li>fetching an initial request token</li>
<li>having the user authorize the request token</li>
<li>fetching an access token</li>
</ol>

<p>In the context of an extension, this flow gets a bit tricky. Namely, there is no established consumer key/secret between the service provider and the application. That is, there is no web application URL for the user to be redirected to after the approval process.
</p>

<p>
Luckily, Google and a few other companies have been working on an <a href="http://code.google.com/apis/accounts/docs/OAuthForInstalledApps.html">OAuth for installed applications</a> solution that you can use from an extension environment. In the installed applications OAuth dance, the consumer key/secret are ‘anonymous’/’anonymous’ and you provide an <em>application name</em> for the user to grant access to (instead of an application URL). The end result is the same: your background page requests the initial token, opens a new tab to the approval page, and finally makes the asynchronous call for the access token.
</p>

<h3 id="set-code">Setup code</h3>

<p>To initialize the library, create a <code>ChromeExOAuth</code> object in the background page:</p>

<pre>
var oauth = ChromeExOAuth.initBackgroundPage({
  'request_url': &lt;OAuth request URL&gt;,
  'authorize_url': &lt;OAuth authorize URL&gt;,
  'access_url': &lt;OAuth access token URL&gt;,
  'consumer_key': &lt;OAuth consumer key&gt;,
  'consumer_secret': &lt;OAuth consumer secret&gt;,
  'scope': &lt;scope of data access, not used by all OAuth providers&gt;,
  'app_name': &lt;application name, not used by all OAuth providers&gt;
});
</pre>

<p>In the case of the Documents List API and Google’s OAuth endpoints, a possible initialization may be:</p>

<pre>
var oauth = ChromeExOAuth.initBackgroundPage({
  'request_url': 'https://www.google.com/accounts/OAuthGetRequestToken',
  'authorize_url': 'https://www.google.com/accounts/OAuthAuthorizeToken',
  'access_url': 'https://www.google.com/accounts/OAuthGetAccessToken',
  'consumer_key': 'anonymous',
  'consumer_secret': 'anonymous',
  'scope': 'https://docs.google.com/feeds/',
  'app_name': 'My Google Docs Extension'
});
</pre>

<p>
To use the OAuth library,
you must declare the "tabs" permision in the
<a href="manifest">extension manifest</a>.
You must also declare the sites you are using
including the request URL, the authorize URL, access URL,
and, if necessary, the scope URL.
For example:
</p>

<pre data-filename="manifest.json">
"permissions": [ "tabs", "https://docs.google.com/feeds/*",
  "https://www.google.com/accounts/OAuthGetRequestToken",
  "https://www.google.com/accounts/OAuthAuthorizeToken",
  "https://www.google.com/accounts/OAuthGetAccessToken"
]
</pre>

<h3 id="request-token">Fetching and authorizing a request token</h3>

<p>
Once you have your background page set up, call the <code>authorize()</code> function to begin the OAuth dance and redirect the user to the OAuth provider. The client library abstracts most of this process, so all you need to do is pass a callback to the <code>authorize()</code> function, and a new tab will open and redirect the user.
</p>

<pre>
oauth.authorize(function() {
  // ... Ready to fetch private data ...
});
</pre>

<p>
You don't need to provide any additional logic for storing the token and secret, as this library already stores these values in the browser’s <code>localStorage</code>. If the library already has an access token stored for the current scope, then no tab will be opened. In either case, the callback will be called.
</p>

<h3 id="signed-requests">Sending signed API requests</h3>

<p>
Once your specified callback is executed, call the <code>sendSignedRequest()</code> function to send signed requests to your API endpoint(s). <code>sendSignedRequest()</code> takes three arguments: a URI, a callback function, and an optional parameter object. The callback is passed two arguments: the response text and the <code>XMLHttpRequest</code> object that was used to make the request.
</p>

<p>This example sends an HTTP <code>GET</code>:</p>

<pre>
function callback(resp, xhr) {
  // ... Process text response ...
};

function onAuthorized() {
  var url = 'https://docs.google.com/feeds/default/private/full';
  var request = {
    'method': 'GET',
    'parameters': {'alt': 'json'}
  };

  // Send: GET https://docs.google.com/feeds/default/private/full?alt=json
  oauth.sendSignedRequest(url, callback, request);
};

oauth.authorize(onAuthorized);
</pre>

<p>A more complex example using an HTTP <code>POST</code> might look like this:</p>

<pre>
function onAuthorized() {
  var url = 'https://docs.google.com/feeds/default/private/full';
  var request = {
    'method': 'POST',
    'headers': {
      'GData-Version': '3.0',
      'Content-Type': 'application/atom+xml'
    },
    'parameters': {
      'alt': 'json'
    },
    'body': 'Data to send'
  };

  // Send: POST https://docs.google.com/feeds/default/private/full?alt=json
  oauth.sendSignedRequest(url, callback, request);
};
</pre>

<p>
By default, the <code>sendSignedRequest()</code> function sends the <code>oauth_*</code> parameters in the URL (by calling <code>oauth.signURL()</code>). If you prefer to send the <code>oauth_*</code> parameters in the <code>Authorization</code> header (or need direct access to the generated header), use <code>getAuthorizationHeader()</code>. Its arguments are a URI, an HTTP method, and an optional object of URL query parameters as key/value pairs.
</p>

<p>Here is the example above using <code>getAuthorizationHeader()</code> and an <code>XMLHttpRequest</code> object:</p>

<pre>
function stringify(parameters) {
  var params = [];
  for(var p in parameters) {
    params.push(encodeURIComponent(p) + '=' +
                encodeURIComponent(parameters[p]));
  }
  return params.join('&');
};

function onAuthorized() {
  var method = 'POST';
  var url = 'https://docs.google.com/feeds/default/private/full';
  var params = {'alt': 'json'};

  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function(data) {
    callback(xhr, data);
  };
  xhr.open(method, url + '?' + stringify(params), true);
  xhr.setRequestHeader('GData-Version', '3.0');
  xhr.setRequestHeader('Content-Type', 'application/atom+xml');
  xhr.setRequestHeader('Authorization', oauth.getAuthorizationHeader(url, method, params));

  xhr.send('Data to send');
};
</pre>

<h2 id="sample-code">Sample code</h2>

<p>
Sample extensions that use these techniques are available in the Chromium source tree:
</p>

<ul>
<li><a href="https://chromium.googlesource.com/chromium/src/+/master/chrome/common/extensions/docs/examples/extensions/gdocs/">.../examples/extensions/gdocs/</a></li>
<li><a href="https://chromium.googlesource.com/chromium/src/+/master/chrome/common/extensions/docs/examples/extensions/oauth_contacts/">.../examples/extensions/oauth_contacts/</a></li>
</ul> -->

{
  "comments": [
    {
      "key": {
        "uuid": "637940e8_ef53e925",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/notifications/channels/ChannelDefinitions.java",
        "patchSetId": 2
      },
      "lineNbr": 68,
      "author": {
        "id": 1187649
      },
      "writtenOn": "2017-07-21T14:24:28Z",
      "side": 1,
      "message": "Hmmm.. this raises a tricky question of whether CHANNELS_VERSION should be incremented in this case - where a new channel is only added if the flag is enabled.\n\nI think incrementing it conditionally would be too messy.\n\nWe *could* only increment it once the flag is removed and the feature is on by default. But until then we\u0027d have to live with updaters with the flag enabled not seeing the channel in settings until they receive a content suggestions notification, while fresh-installs with the flag enabled *would* see it. Which is a bit weird and inconsistent. But maybe fine if this is just a command line flag to aid development. (Still, if you go for this option I\u0027d like to see a TODO on line 90 to increment the version once the flag is removed.)\n\nAn alternative option would be to increment the CHANNELS_VERSION now, and also once the flag is removed. This would result in more consistent behaviour, but also lead to some unnecessary upgrade code running when channels don\u0027t actually need to be updated. Also, if the flag is enabled, and then later disabled, the channel will still show up  (although this will also be the case if the user receives one of the notifications while the flag is enabled, even if we go with the previous option).\n\nI don\u0027t feel very strongly about this so happy to leave the decision up to you.",
      "range": {
        "startLine": 68,
        "startChar": 0,
        "endLine": 68,
        "endChar": 96
      },
      "revId": "7c134544f480e36b9006531d1caea2b8678ad594",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f31fd4fa_c44b0a66",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/notifications/channels/ChannelDefinitions.java",
        "patchSetId": 2
      },
      "lineNbr": 68,
      "author": {
        "id": 1150535
      },
      "writtenOn": "2017-07-24T11:26:01Z",
      "side": 1,
      "message": "So, to be clear, this feature is associated with a real experiment. It\u0027s already live in EM and (fair warning) we have a good track record of launching in EM and a not so good record of getting approval to launch globally. The experiment is a transitional state but it could be a long transition.\n\nThe ideal solution would have:\n\n1. No entry in settings if the experiment has never been enabled locally.\n2. An entry in settings on startup if the experiment is enabled.\n3. No entry if the experiment was but is no longer enabled.\n\nThat\u0027s in order of precedence: I think #1 is a must, and #3 isn\u0027t needed, but I would like #2 if possible. I think that means we would need some kind of conditional.\n\nInstead of storing a version number, did you consider storing getStartupChannelIds() directly in prefs? That would adapt to channels being added or removed without any version bookkeeping on the side. (satisfies 1+2+3)\n\nAnother option would be for us to call ensureInitialized() from our own code. The method is public, though it doesn\u0027t look like it\u0027s necessarily intended for public use. This would require our channel to be in PredefinedChannels.MAP but not getStartupChannelIds(), though. (satisfies 1+2)",
      "parentUuid": "637940e8_ef53e925",
      "range": {
        "startLine": 68,
        "startChar": 0,
        "endLine": 68,
        "endChar": 96
      },
      "revId": "7c134544f480e36b9006531d1caea2b8678ad594",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "48c0ad73_222cfda7",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/notifications/channels/ChannelDefinitions.java",
        "patchSetId": 2
      },
      "lineNbr": 68,
      "author": {
        "id": 1187649
      },
      "writtenOn": "2017-07-25T15:14:18Z",
      "side": 1,
      "message": "Thanks for explaining.\n\nSo if this feature flag is associated with an experiment, does that mean it can be turned on/off remotely by the experimental framework, without a user updating? \n\nIf so, the existing channels upgrade code can\u0027t really be used for creating/deleting the channel - which currently assumes startup channels can only change if/when the app updates.\n\nSo then the channel will need to be created/deleted from content suggestions code like you\u0027ve done in the latest patch. However, I\u0027m a bit confused why this is done from flushCachedMetrics -  Is flushCachedMetrics guaranteed to run at the right time for initializing the channel? What about initializing the channel from ContentSuggestionsNotifierService::SetEnabled(true) (and maybe deleting it from ContentSuggestionsNotifierService::SetEnabled(false) ?). That would make more sense to me, but perhaps I\u0027m missing something..",
      "parentUuid": "f31fd4fa_c44b0a66",
      "range": {
        "startLine": 68,
        "startChar": 0,
        "endLine": 68,
        "endChar": 96
      },
      "revId": "7c134544f480e36b9006531d1caea2b8678ad594",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a999d645_7cb68a9d",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/notifications/channels/ChannelDefinitions.java",
        "patchSetId": 2
      },
      "lineNbr": 90,
      "author": {
        "id": 1150535
      },
      "writtenOn": "2017-07-24T11:26:01Z",
      "side": 1,
      "message": "Now that I think of it, it\u0027s probably not always safe to use this from a static initializer.",
      "revId": "7c134544f480e36b9006531d1caea2b8678ad594",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "d2496ccf_a652bb8e",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.cc",
        "patchSetId": 1
      },
      "lineNbr": 66,
      "author": {
        "id": 1151884
      },
      "writtenOn": "2018-02-06T21:51:30Z",
      "side": 1,
      "message": "I think you should add a method to WidgetObserver (maybe \"OnAddedToWidget\"; sky will probably have an opinion on the name) that will be called when AddObserver is called, then you don\u0027t need to change the callsites. I also think this should just call OnWidgetVisibilityChanged(bubble_widget, bubble_widget-\u003eIsVisible()), or at least have them delegate to the same method.",
      "range": {
        "startLine": 66,
        "startChar": 6,
        "endLine": 66,
        "endChar": 19
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3fe95f1b_e1fb5580",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.cc",
        "patchSetId": 1
      },
      "lineNbr": 66,
      "author": {
        "id": 1126912
      },
      "writtenOn": "2018-02-06T23:11:57Z",
      "side": 1,
      "message": "Observing a widget !\u003d being added to it, so that is confusing. Calling it OnWidgetObserving and letting sky@ have input too.\n\nGood suggestion, thanks!",
      "parentUuid": "d2496ccf_a652bb8e",
      "range": {
        "startLine": 66,
        "startChar": 6,
        "endLine": 66,
        "endChar": 19
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "eb32e3cd_ee16dfa7",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.cc",
        "patchSetId": 1
      },
      "lineNbr": 66,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2018-02-07T00:14:20Z",
      "side": 1,
      "message": "The pattern you have here basically comes down to:\nsource-\u003eAddObserver(x);\n// In AddObserver impl:\nx-\u003eYouAddedMe();\n\nThat\u0027s weird, and I don\u0027t think such a function belongs in WidgetObserver. If code creating the widget needs to know when the widget has been created it should be responsible for tracking that. By which I mean don\u0027t change the base class just because it\u0027s convenient.",
      "parentUuid": "3fe95f1b_e1fb5580",
      "range": {
        "startLine": 66,
        "startChar": 6,
        "endLine": 66,
        "endChar": 19
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9b2fa376_9f883460",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.cc",
        "patchSetId": 1
      },
      "lineNbr": 66,
      "author": {
        "id": 1126912
      },
      "writtenOn": "2018-02-07T00:27:03Z",
      "side": 1,
      "message": "It\u0027s convenient because it lets all call sites use a single call:\n\nwidget-\u003eAddObserver(observer);\n\nThe observer here needs to know the initial state of the widget as it needs to be *in sync* with widget-\u003eIsVisible(). If we don\u0027t have this callback all call sites are essentially:\n\nobserver-\u003eSetInitialWidgetState(widget-\u003eIsVisible());\nwidget-\u003eAddObserver(observer);\n\nThis pattern *is brittle* because all call sites (7 of them, + new code) will need to remember the SetInitialWidgetState() call. Also we\u0027d need a public SetInitialWidgetState which is just wonky.\n\nAn alternative is:\n\nObserver /* does not inherit from WidgetObserver as it\u0027s error prone (AddObserver does not set initial state) */ {\n  void ObserveWidget(widget) {\n    SetState(widget-\u003eIsVisible());\n    widget-\u003eAddObserver(\u0026widget_observer_proxy_);\n  }\n  private:\n    WidgetObserverProxy {\n      ctor(Observer* parent) : parent_(parent)\n      void OnWidgetVisibilityChanged(widget, visible) override { parent-\u003eSetState(visible); }\n      void OnWidgetDestroying(widget) { widget-\u003eRemoveObserver(this); }\n    }\n};\n\nBut then we can\u0027t use WidgetObserver directly and instead need boilerplate code (as code style forbids protected inheritance). Is this pattern recommended / do you see any other patterns? I don\u0027t want the solution to be as brittle as having all code sites duplicate SetInitialState + AddObserver.",
      "parentUuid": "eb32e3cd_ee16dfa7",
      "range": {
        "startLine": 66,
        "startChar": 6,
        "endLine": 66,
        "endChar": 19
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "beb4cd24_c913797f",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.cc",
        "patchSetId": 1
      },
      "lineNbr": 66,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2018-02-07T18:38:03Z",
      "side": 1,
      "message": "I need to study this code a bit more. My knee jerk reaction is the problem stems from having an object other than the observer responsible for attaching it. I would expect the observer implementation itself to attach itself to the appropriate object. Basically the ObserverWidget() implementation you have on the WidgetObserver impl. You mention that is error prone. Why?",
      "parentUuid": "9b2fa376_9f883460",
      "range": {
        "startLine": 66,
        "startChar": 6,
        "endLine": 66,
        "endChar": 19
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f8ba233c_62ec232c",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.cc",
        "patchSetId": 1
      },
      "lineNbr": 66,
      "author": {
        "id": 1126912
      },
      "writtenOn": "2018-02-07T19:14:55Z",
      "side": 1,
      "message": "If the object should always responsible for attaching itself we shouldn\u0027t have public WidgetObserver inheritance right (or other code would be able to attach the observer for the widget, which breaks the code).\n\nIt\u0027s error prone because there\u0027s no automatic enforcement that the attachment is done by the observer that way. Example:\n\nObserver (public WidgetObserver):\n  void AttachToWidget(views::Widget* widget):\n    SetInitialStateBasedOnWidgetState(widget);\n    widget-\u003eAddObserver(this);\n\nWe would then expect that the call sites call:\n\nobserver-\u003eAttachToWidget(widget);\n\nBut there is no enforcement of this, so:\n\nwidget-\u003eAddObserver(observer);\n\nThis will still compile and run fine, but the observer cannot set its initial state based on the widget, and parts of the functionality (observing when the widget goes invisible), still works.\n\nSo long as WidgetObserver is public inheritance we can\u0027t reasonably enforce that attachment is done using the correct method. My current workaround plan is to have:\n\nAttachToWidget(widget):\n  attached_using_correct_method_ \u003d true;\n\nOnWidgetVisibilityChanged(widget, visibility):\n DCHECK(attached_using_correct_method_);\n\nTo just enforce that AddObserver is *not used* to attach this externally from call sites. I think it would be preferable if there was only one way to attach the observer to and observe the widget, and that\u0027s using Widget/WidgetObserver APIs.\n\nDoes this reasoning make sense? SetInitialStateBasedOnWidgetState() is an important call for us to be in sync with the widget in this case and not just observe future changes.",
      "parentUuid": "beb4cd24_c913797f",
      "range": {
        "startLine": 66,
        "startChar": 6,
        "endLine": 66,
        "endChar": 19
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ca54beac_4c6ba442",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.cc",
        "patchSetId": 1
      },
      "lineNbr": 204,
      "author": {
        "id": 1151884
      },
      "writtenOn": "2018-02-06T21:51:30Z",
      "side": 1,
      "message": "nit: no {}",
      "range": {
        "startLine": 204,
        "startChar": 14,
        "endLine": 204,
        "endChar": 16
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "037fd0ff_f3495df9",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.cc",
        "patchSetId": 1
      },
      "lineNbr": 204,
      "author": {
        "id": 1126912
      },
      "writtenOn": "2018-02-06T23:11:57Z",
      "side": 1,
      "message": "pref keeping since it\u0027s part of an if-else block",
      "parentUuid": "ca54beac_4c6ba442",
      "range": {
        "startLine": 204,
        "startChar": 14,
        "endLine": 204,
        "endChar": 16
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1a8d1822_b1149217",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.h",
        "patchSetId": 1
      },
      "lineNbr": 29,
      "author": {
        "id": 1126912
      },
      "writtenOn": "2018-02-06T21:08:06Z",
      "side": 1,
      "message": "Note that this is protected to prevent AddObserver calls from the outside that misses highlighting the icon.",
      "range": {
        "startLine": 29,
        "startChar": 23,
        "endLine": 29,
        "endChar": 33
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "21a318d8_1d2e9cc4",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.h",
        "patchSetId": 1
      },
      "lineNbr": 29,
      "author": {
        "id": 1151884
      },
      "writtenOn": "2018-02-06T21:51:30Z",
      "side": 1,
      "message": "From Google C++ style guide: \"All inheritance should be public\"",
      "parentUuid": "1a8d1822_b1149217",
      "range": {
        "startLine": 29,
        "startChar": 23,
        "endLine": 29,
        "endChar": 33
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "13106f5d_78f1736b",
        "filename": "chrome/browser/ui/views/location_bar/bubble_icon_view.h",
        "patchSetId": 1
      },
      "lineNbr": 29,
      "author": {
        "id": 1126912
      },
      "writtenOn": "2018-02-06T23:11:57Z",
      "side": 1,
      "message": "Fixed w/ your other suggestion (removes need for OnBubbleWidgetCreated).",
      "parentUuid": "21a318d8_1d2e9cc4",
      "range": {
        "startLine": 29,
        "startChar": 23,
        "endLine": 29,
        "endChar": 33
      },
      "revId": "419e37fa08de497d514f10cc29febfb472ee1ef9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
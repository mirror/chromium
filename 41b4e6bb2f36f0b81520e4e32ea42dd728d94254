{
  "comments": [
    {
      "key": {
        "uuid": "360f92f5_d3f82467",
        "filename": "third_party/zlib/BUILD.gn",
        "patchSetId": 3
      },
      "lineNbr": 87,
      "author": {
        "id": 1193769
      },
      "writtenOn": "2017-09-11T16:30:04Z",
      "side": 1,
      "message": "I believe you\u0027re now letting the compiler use SSSE3 anywhere it likes inside zlib without a runtime check...\n\nThe usual pattern is to isolate the SSSE3 code to its own build target and set the flag there, much like we\u0027ve done for :zlib_x86_simd.  You might just plop it in there unless you\u0027re very concerned about improving machines with SSSE3 but not SSE4.2?",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dbe85aaf_7cc018e9",
        "filename": "third_party/zlib/BUILD.gn",
        "patchSetId": 3
      },
      "lineNbr": 87,
      "author": {
        "id": 1109754
      },
      "writtenOn": "2017-09-12T16:59:23Z",
      "side": 1,
      "message": "\u003e I believe you\u0027re now letting the compiler use SSSE3 anywhere it likes inside zlib without a runtime check...\n\nGood point.\n\n\u003e The usual pattern is to isolate the SSSE3 code to its own build target and set the flag there, much like we\u0027ve done for :zlib_x86_simd.  You might just plop it in there unless you\u0027re very concerned about improving machines with SSSE3 but not SSE4.2?\n\nMoved it into to its own build target (cribbed from the zlib_x86_simd target and their use of stub code).  Kept it as a separate target so we could add NEON to it  later, added a FIXME.\n\nTrying it on the bots now, patch set #7, PTAL.",
      "parentUuid": "360f92f5_d3f82467",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ca17127b_9f47941b",
        "filename": "third_party/zlib/adler32_simd.c",
        "patchSetId": 3
      },
      "lineNbr": 97,
      "author": {
        "id": 1193769
      },
      "writtenOn": "2017-09-11T16:30:04Z",
      "side": 1,
      "message": "I suspect you\u0027ll get the same codegen out of\n\n  __m128i tap1 \u003d _mm_set_epi8(32,31,30,29,28,...);\n  __m128i tap2 \u003d _mm_set_epi8(16,15,14,13,12,...);\n\nAnd that way you won\u0027t need the union.",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ce1ec626_ef424ba0",
        "filename": "third_party/zlib/adler32_simd.c",
        "patchSetId": 3
      },
      "lineNbr": 97,
      "author": {
        "id": 1109754
      },
      "writtenOn": "2017-09-12T03:19:13Z",
      "side": 1,
      "message": "Right, confirmed same code gen.  I wrote out all the constants this way in the next patch to make it clear that |ones| was epi16, and removed the union.  Note that the order suggested:\n\n  __m128i tap1 \u003d _mm_set_epi8(32,31,30,29,28,...);\n  __m128i tap2 \u003d _mm_set_epi8(16,15,14,13,12,...);\n\nis back-to-front.  The bench tool on the bug complained that the computed adler32 was wrong, and it is correct, but this does give us an opportunity ...\n\nI\u0027m going to upload a patch using this \"wrong taps order\" to assess test coverage, I expect the bots to explode ... we\u0027ll come back and fix that later.",
      "parentUuid": "ca17127b_9f47941b",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "11c6a153_88ce8825",
        "filename": "third_party/zlib/adler32_simd.c",
        "patchSetId": 3
      },
      "lineNbr": 97,
      "author": {
        "id": 1193769
      },
      "writtenOn": "2017-09-12T13:34:20Z",
      "side": 1,
      "message": "Whoops!  There\u0027s _mm_setr_epi8 if you like writing them in the order you had.",
      "parentUuid": "ce1ec626_ef424ba0",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "450f7ef3_348d0ad3",
        "filename": "third_party/zlib/adler32_simd.c",
        "patchSetId": 3
      },
      "lineNbr": 97,
      "author": {
        "id": 1109754
      },
      "writtenOn": "2017-09-12T16:47:53Z",
      "side": 1,
      "message": "No worries.  The bot results for patch set #4 are as expected: red bots all over with the \"wrong taps order\", some 2000 tests failed.\n\n - if the alder checksum is wrong in a PNG decode ...\n    - the PNG won\u0027t decode at all.\n - net_unittests failed, they don\u0027t use PNG ...\n    - but they do use gzip though.\n\nSeems we have good test coverage.  In patch set #5, I fixed the tap order (reversed it) and the bots are all green again.",
      "parentUuid": "11c6a153_88ce8825",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2505efd1_8a44bd3f",
        "filename": "third_party/zlib/adler32_simd.c",
        "patchSetId": 3
      },
      "lineNbr": 97,
      "author": {
        "id": 1109754
      },
      "writtenOn": "2017-09-13T13:58:21Z",
      "side": 1,
      "message": "\u003e Whoops!  There\u0027s _mm_setr_epi8 if you like writing them in the order you had.\n\nThank you for this tip.  I\u0027ve used it now, it better matches the comments about the maths of adler checksums given a the top of this file.",
      "parentUuid": "450f7ef3_348d0ad3",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0ff2f0c6_b6bcafd4",
        "filename": "third_party/zlib/adler32_simd.c",
        "patchSetId": 3
      },
      "lineNbr": 102,
      "author": {
        "id": 1193769
      },
      "writtenOn": "2017-09-11T16:30:04Z",
      "side": 1,
      "message": "I kind of think this would be easier to read as const __m128i all the way through.  The name __input seemed like some sort of typedef I\u0027d be looking for in one of the intrinsics headers.\n\nOr is there some value in separating these const __m128i from the other non-__input const __m128i?",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7ca1965a_ef3ee905",
        "filename": "third_party/zlib/adler32_simd.c",
        "patchSetId": 3
      },
      "lineNbr": 102,
      "author": {
        "id": 1109754
      },
      "writtenOn": "2017-09-12T03:19:13Z",
      "side": 1,
      "message": "Thought it might help readability :).  I\u0027m fine with using __m128i though, let\u0027s go with your suggestion.   Done.",
      "parentUuid": "0ff2f0c6_b6bcafd4",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "aeda7eb2_e43a6d9e",
        "filename": "third_party/zlib/adler32_simd.c",
        "patchSetId": 3
      },
      "lineNbr": 132,
      "author": {
        "id": 1193769
      },
      "writtenOn": "2017-09-11T16:30:04Z",
      "side": 1,
      "message": "By any chance did you try doing this with just SSE2?  No win without pmaddubsw?",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ff862a5d_6f1c7875",
        "filename": "third_party/zlib/adler32_simd.c",
        "patchSetId": 3
      },
      "lineNbr": 132,
      "author": {
        "id": 1109754
      },
      "writtenOn": "2017-09-12T03:19:13Z",
      "side": 1,
      "message": "Yes I tried with SSE2, no joy, requires a different approach, and it\u0027s not as fast as this method ... \"No win without pmaddubsw?\" exactly.",
      "parentUuid": "aeda7eb2_e43a6d9e",
      "revId": "41b4e6bb2f36f0b81520e4e32ea42dd728d94254",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "0db4ccda_873c596f",
        "filename": "ios/web/public/test/web_test_with_web_state.mm",
        "patchSetId": 2
      },
      "lineNbr": 82,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2017-10-24T17:56:50Z",
      "side": 1,
      "message": "nit: Avoid \"we\" in the comment (go/avoidwe)",
      "range": {
        "startLine": 82,
        "startChar": 43,
        "endLine": 82,
        "endChar": 45
      },
      "revId": "037a170ac6a7ea969a22f8b41b50a38b02c34cab",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "92c81329_064a82b7",
        "filename": "ios/web/public/test/web_test_with_web_state.mm",
        "patchSetId": 2
      },
      "lineNbr": 82,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2017-10-26T19:37:16Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "0db4ccda_873c596f",
      "range": {
        "startLine": 82,
        "startChar": 43,
        "endLine": 82,
        "endChar": 45
      },
      "revId": "037a170ac6a7ea969a22f8b41b50a38b02c34cab",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4bc36c7f_a862f0e3",
        "filename": "ios/web/public/test/web_test_with_web_state.mm",
        "patchSetId": 2
      },
      "lineNbr": 87,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2017-10-24T17:56:50Z",
      "side": 1,
      "message": "Would you like to try file:// URLs instead?\nFormSuggestionControllerTest.PageLoadShouldBeIgnoredWhenNotHtml is a good example for that.\n\nI\u0027m asking to try alternative, because LoadHtml is used in almost every Chrome for iOS test and making this method slower may add significant extra load to the bots.",
      "revId": "037a170ac6a7ea969a22f8b41b50a38b02c34cab",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dae14b1c_6afc5222",
        "filename": "ios/web/public/test/web_test_with_web_state.mm",
        "patchSetId": 2
      },
      "lineNbr": 87,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2017-10-24T23:16:42Z",
      "side": 1,
      "message": "What do you mean by trying file:// URL?\nFormSuggestionControllerTest.PageLoadShouldBeIgnoredWhenNotHtml is loading a real file. Converting all tests that use LoadHTML() to loading a file will fix the issue, but it\u0027ll touch a lot of files, and I\u0027m not sure loading a file would actually be faster than loading about:blank first.\n\nI did some microbenchmarking, the extra about:blank load adds ~40ms setup time per test. A trivial test that only calls LoadHTML() takes ~240ms. So you\u0027re right, this is non-trivial.\n\nAn alternative is to remove the DCHECK(wk_item) from WKBasedNavigationManager. If web_view.backForwardList.currentItem is nil in WKBasedNavigationManagerImpl::CommitPendingItem() is nil, we\u0027ll just drop the NavigationItem. This only affects tests anyways, because the production code path uses |-loadHTML:forApplicationSpecificURL| and already has the placeholder hack. WDYT?",
      "parentUuid": "4bc36c7f_a862f0e3",
      "revId": "037a170ac6a7ea969a22f8b41b50a38b02c34cab",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f7763d4f_eb360159",
        "filename": "ios/web/public/test/web_test_with_web_state.mm",
        "patchSetId": 2
      },
      "lineNbr": 87,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2017-10-25T17:15:30Z",
      "side": 1,
      "message": "Sorry, I meant to use file:// URLs inside LoadHtml as follows:\n1.) Write HTML content to a temp .html file\n2.) Load file:// URL with that temp file\n3.) Remove temp file after the load is completed\n\nI think removing DCHECK is also fine.",
      "parentUuid": "dae14b1c_6afc5222",
      "revId": "037a170ac6a7ea969a22f8b41b50a38b02c34cab",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8b22e24f_aa67b5aa",
        "filename": "ios/web/public/test/web_test_with_web_state.mm",
        "patchSetId": 2
      },
      "lineNbr": 87,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2017-10-26T18:05:11Z",
      "side": 1,
      "message": "After some more investigation, I don\u0027t think removing DCHECK is workable. The DCHECK enforces the semantic that [CRWWebController loadHTML] generates a navigation entry. Many tests depend on it, e.g. a test will look up LastCommittedItem() after |-loadHTML|. Removing DCHECK requires also modifying the code to relax this semantic. IMHO it opens up more issues than it fixes.\n\nI did some microbenchmarking wrt file://. Writing to file is much slower than loading about:blank. Here are the data points:\n1) trivial LoadHTML(): 244ms\n2) load about:blank and wait for loaded, then LoadHTML() (this patch): 286ms\n3) write to file and load file:/// URL: 580ms\n\nHere\u0027s my prototype with file://: crrev.com/c/740016\nMaybe my implementation is not the most efficient, but intuitively I can believe that creating and writing a file is slower than WKWebView painting a whitescreen.\n\nWhat\u0027s worse is that the overhead of (3) vs. (1) is proportionally to the number of times a test calls LoadHTML(). In comparison, the ~40ms overhead in (2) is fixed per test case. I verified this with running LoadHTML() up to 1000 times.\n\nI counted 195 occurrences of \"LoadHtml\" in tests under ios/. Assuming the worse case where each test only calls LoadHtml() once, the total increase in time is still about 8 seconds. I think this is the best of the options we have. WDYT?",
      "parentUuid": "f7763d4f_eb360159",
      "revId": "037a170ac6a7ea969a22f8b41b50a38b02c34cab",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4a1de439_96ec93bd",
        "filename": "ios/web/public/test/web_test_with_web_state.mm",
        "patchSetId": 2
      },
      "lineNbr": 87,
      "author": {
        "id": 1123009
      },
      "writtenOn": "2017-10-26T18:35:33Z",
      "side": 1,
      "message": "Thank you for measuring. 8 seconds total increase sounds like quite insignificant. Thank you for investigations and trying the alternatives!",
      "parentUuid": "8b22e24f_aa67b5aa",
      "revId": "037a170ac6a7ea969a22f8b41b50a38b02c34cab",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e075cf18_04aad3d7",
        "filename": "ios/web/public/test/web_test_with_web_state.mm",
        "patchSetId": 2
      },
      "lineNbr": 87,
      "author": {
        "id": 1190590
      },
      "writtenOn": "2017-10-26T19:37:16Z",
      "side": 1,
      "message": "Resolved.",
      "parentUuid": "4a1de439_96ec93bd",
      "revId": "037a170ac6a7ea969a22f8b41b50a38b02c34cab",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}
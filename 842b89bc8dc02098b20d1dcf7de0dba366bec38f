{
  "comments": [
    {
      "key": {
        "uuid": "28e96bed_0da42692",
        "filename": "components/history/content/browser/web_contents_top_sites_observer.cc",
        "patchSetId": 34
      },
      "lineNbr": 43,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-09-27T15:44:43Z",
      "side": 1,
      "message": "How do you know this early out is safe?",
      "range": {
        "startLine": 42,
        "startChar": 5,
        "endLine": 43,
        "endChar": 36
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "11ad4f84_092617b2",
        "filename": "components/history/content/browser/web_contents_top_sites_observer.cc",
        "patchSetId": 34
      },
      "lineNbr": 43,
      "author": {
        "id": 1228990
      },
      "writtenOn": "2017-09-28T06:06:44Z",
      "side": 1,
      "message": "The browsing history (chrome://history/) is updated only when an user navigates to a new page (either in a new tab or in the same tab), or navigates to an existing navigation entry. So I think the early return here is safe.\n\nIn the old implementation, top sites refreshes immediately when an user navigates to a new page in a new tab via searching. This is enabled by making TopSites \"observe\" Instant Service. However, new pages can open in other ways, like JumpList, bookmark, etc. These navigation events as well as history navigation events are throttled, or even ignored (e.g., when non-forced url list is full which is implemented in the original TopSitesImpl::OnNavigationCommitted). I think this is incorrect.",
      "parentUuid": "28e96bed_0da42692",
      "range": {
        "startLine": 42,
        "startChar": 5,
        "endLine": 43,
        "endChar": 36
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "355c8b44_fbeb9796",
        "filename": "components/history/content/browser/web_contents_top_sites_observer.cc",
        "patchSetId": 34
      },
      "lineNbr": 43,
      "author": {
        "id": 1116059
      },
      "writtenOn": "2017-09-28T08:43:38Z",
      "side": 1,
      "message": "I don\u0027t think last paragraph is fully correct. The integration with InstantService makes sure to refresh TopSites whenever an NTP is opened, because we\u0027d like to have up-to-date results there. It doesn\u0027t have anything to do with searching.",
      "parentUuid": "11ad4f84_092617b2",
      "range": {
        "startLine": 42,
        "startChar": 5,
        "endLine": 43,
        "endChar": 36
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e333ac15_7b783a53",
        "filename": "components/history/content/browser/web_contents_top_sites_observer.cc",
        "patchSetId": 34
      },
      "lineNbr": 43,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-09-28T20:19:39Z",
      "side": 1,
      "message": "Can you point me at the history code you are referring to Xi?",
      "parentUuid": "355c8b44_fbeb9796",
      "range": {
        "startLine": 42,
        "startChar": 5,
        "endLine": 43,
        "endChar": 36
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a5cf96fa_e0edb202",
        "filename": "components/history/content/browser/web_contents_top_sites_observer.cc",
        "patchSetId": 34
      },
      "lineNbr": 43,
      "author": {
        "id": 1228990
      },
      "writtenOn": "2017-09-28T22:34:14Z",
      "side": 1,
      "message": "Hi Scott, the code is a bit complex. I\u0027d like to provide as much detail as possible below.\n\n1) When TopSites queries history db via HistoryBackend::QueryMostVisitedURLs, it actually queries the VisitSegmentDatabase in the history db. HistoryDatabase consists of a few DBs. Please refer to line 71 in history_backend.cc\n\n2) VisitSegmentDatabase is updated via HistoryBackend::UpdateSegments, which is only called in HistoryBackend::AddPage. The latter is only called from HistoryService::AddPage(const HistoryAddPageArgs\u0026 add_page_args). Note that there are a number of AddPage variants.  \n\n3) Although HistoryService::AddPage is called in a few places, I believe the most important one is HistoryTabHelper::UpdateHistoryForNavigation().\n\nAdditionally, if you refresh chrome://history/ each time you visit a website (type in url in a new tab or the current one, or via bookmark, or via jumplist in Windows, or go to a previous page via navigation), I think you can easily guess what the code is like.\n\n[New] I had another think after syncing with Marc. Now I have a much better understanding of Instant service and MostVistedSites. I think it\u0027s better to keep that code untouched, so I\u0027ve reverted those changes in the new patch set. This may reduce the concern of the changes here in NavigationEntryCommitted(). For TopSites, I still think we should remove polling and only refresh it when there are (relevant) navigation events observed. \n\nPTAL the new patch set. Thanks!",
      "parentUuid": "e333ac15_7b783a53",
      "range": {
        "startLine": 42,
        "startChar": 5,
        "endLine": 43,
        "endChar": 36
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dca6f857_071702e5",
        "filename": "components/history/content/browser/web_contents_top_sites_observer.cc",
        "patchSetId": 34
      },
      "lineNbr": 48,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-09-27T15:44:43Z",
      "side": 1,
      "message": "I think this logic is better handled in TopSites. That is, make TopSites;:OnNavigationCommitted take a LoadCommittedDetails and have it decide what makes sense.",
      "range": {
        "startLine": 42,
        "startChar": 2,
        "endLine": 48,
        "endChar": 3
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c6a24502_a28f8289",
        "filename": "components/history/content/browser/web_contents_top_sites_observer.cc",
        "patchSetId": 34
      },
      "lineNbr": 48,
      "author": {
        "id": 1228990
      },
      "writtenOn": "2017-09-28T06:06:44Z",
      "side": 1,
      "message": "I actually thought the same way. However, if I make TopSites::OnNavigationCommitted take a LoadCommittedDetails, I have to include content/public/browser/navigation_details.h and another similar one in topsites.h. This unfortunately violates checkdeps rules when running \"fit cl upload\". \n\nHere is the message: \u003cBecause of \"-content\" from components/history/core\u0027s include_rules\u003e",
      "parentUuid": "dca6f857_071702e5",
      "range": {
        "startLine": 42,
        "startChar": 2,
        "endLine": 48,
        "endChar": 3
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6d5abe2e_ea562897",
        "filename": "components/history/content/browser/web_contents_top_sites_observer.cc",
        "patchSetId": 34
      },
      "lineNbr": 48,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-09-28T20:19:39Z",
      "side": 1,
      "message": "*SIGH* You are right.",
      "parentUuid": "c6a24502_a28f8289",
      "range": {
        "startLine": 42,
        "startChar": 2,
        "endLine": 48,
        "endChar": 3
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "676db865_59a1dd8a",
        "filename": "components/history/content/browser/web_contents_top_sites_observer.cc",
        "patchSetId": 34
      },
      "lineNbr": 48,
      "author": {
        "id": 1228990
      },
      "writtenOn": "2017-09-28T22:34:14Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6d5abe2e_ea562897",
      "range": {
        "startLine": 42,
        "startChar": 2,
        "endLine": 48,
        "endChar": 3
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c31320d7_b258c359",
        "filename": "components/history/core/browser/top_sites_impl.cc",
        "patchSetId": 34
      },
      "lineNbr": 844,
      "author": {
        "id": 1000763
      },
      "writtenOn": "2017-09-27T15:44:43Z",
      "side": 1,
      "message": "Initialize makes it sound like this should only be called once. Maybe MaybeRestartUpdateTimer, EnsureUpdateTimerRunning, ScheduleUpdateTimer?",
      "range": {
        "startLine": 844,
        "startChar": 19,
        "endLine": 844,
        "endChar": 29
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9a985f1b_bf03170c",
        "filename": "components/history/core/browser/top_sites_impl.cc",
        "patchSetId": 34
      },
      "lineNbr": 844,
      "author": {
        "id": 1228990
      },
      "writtenOn": "2017-09-28T06:06:44Z",
      "side": 1,
      "message": "Thanks for the suggestion. I\u0027ll go with ScheduleUpdateTimer.",
      "parentUuid": "c31320d7_b258c359",
      "range": {
        "startLine": 844,
        "startChar": 19,
        "endLine": 844,
        "endChar": 29
      },
      "revId": "842b89bc8dc02098b20d1dcf7de0dba366bec38f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
{
  "comments": [
    {
      "key": {
        "uuid": "091a271c_fcca7c46",
        "filename": "ui/gl/gl_surface_egl.cc",
        "patchSetId": 4
      },
      "lineNbr": 948,
      "author": {
        "id": 1105344
      },
      "writtenOn": "2017-10-11T04:41:16Z",
      "side": 1,
      "message": "This is unsatisfying because at the top of this method is:\n  DCHECK(!surface_)\n\nOr, in other words, Initialize() isn\u0027t supposed to be called twice -- unless maybe it\u0027s destroyed in between? Please investigate further why this was happening.",
      "revId": "0e7fb2f9e40213ddc37e5ee457399159eec8903a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d80e2ff7_1dd058b3",
        "filename": "ui/gl/gl_surface_egl.cc",
        "patchSetId": 4
      },
      "lineNbr": 948,
      "author": {
        "id": 1002151
      },
      "writtenOn": "2017-10-11T19:38:52Z",
      "side": 1,
      "message": "ClusterFuzz was hitting the stack overflow in crbug.com/772743, which I took to mean that we need to protect against it even if there aren\u0027t code paths that call it twice. i.e. it could be called twice by a compromised Renderer.\n\nI don\u0027t think any other automated tests were hitting this, however Klaus let me know via chat that WebVR encountering the stack overflow for him locally.\n\nAlso, old comments above GLSurface::Initialize make it seem like it was intended to be called more than once for re-creation.\n\n\"\n  // (Re)create the surface. TODO(apatrick): This is an ugly hack to allow the\n  // EGL surface associated to be recreated without destroying the associated\n  // context. The implementation of this function for other GLSurface derived\n  // classes is in a pending changelist.\n\"",
      "parentUuid": "091a271c_fcca7c46",
      "revId": "0e7fb2f9e40213ddc37e5ee457399159eec8903a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b3c48442_932230fc",
        "filename": "ui/gl/gl_surface_egl.cc",
        "patchSetId": 4
      },
      "lineNbr": 948,
      "author": {
        "id": 1187745
      },
      "writtenOn": "2017-10-13T16:59:38Z",
      "side": 1,
      "message": "\u003e i.e. it could be called twice by a compromised Renderer\n\nI\u0027m confused, normally a Renderer wouldn\u0027t be calling ui/gl/ methods directly since it\u0027s supposed to delegate drawing to the GPU process. Did you mean there\u0027s a way to get the GPU process to call Initialize() twice on the Renderer\u0027s behalf?\n\nIf not, and the Renderer is calling it directly, I\u0027m not sure what benefit extra sanity checks would bring since a compromised Renderer could potentially execute the same code without sanity checks.",
      "parentUuid": "d80e2ff7_1dd058b3",
      "revId": "0e7fb2f9e40213ddc37e5ee457399159eec8903a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "22479f76_5ab70d19",
        "filename": "ui/gl/gl_surface_egl.cc",
        "patchSetId": 4
      },
      "lineNbr": 948,
      "author": {
        "id": 1002151
      },
      "writtenOn": "2017-10-13T19:44:17Z",
      "side": 1,
      "message": "I did mean \"on the Renderer\u0027s behalf\", for example by hijacking writes to the GPU command buffer.\n\nGiven the additional bugs that have come to light though, it appears ::Initialize() can be called multiple times when the device is rotated, in particular when playing video, which the ClusterFuzz test case was doing. It could just be that the devices running ClusterFuzz are oriented horizontally.",
      "parentUuid": "b3c48442_932230fc",
      "revId": "0e7fb2f9e40213ddc37e5ee457399159eec8903a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "264558cc_407dfc1f",
        "filename": "ui/gl/gl_surface_egl.cc",
        "patchSetId": 4
      },
      "lineNbr": 1060,
      "author": {
        "id": 1105344
      },
      "writtenOn": "2017-10-11T04:41:16Z",
      "side": 1,
      "message": "DCHECK(condition) followed by if(condition) -- or in this case the std::min() call -- is an anti-pattern. Either we should rely on the DCHECK and not add the min() call or we should upgrade the DCHECK to a CHECK.",
      "revId": "0e7fb2f9e40213ddc37e5ee457399159eec8903a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2fec1f48_591b52cd",
        "filename": "ui/gl/gl_surface_egl.cc",
        "patchSetId": 4
      },
      "lineNbr": 1060,
      "author": {
        "id": 1002151
      },
      "writtenOn": "2017-10-11T19:38:52Z",
      "side": 1,
      "message": "Give the security implications, I am inclined to upgrade to a CHECK. CHECK overhead can sometimes be a concern, but this code path is only taken when tracing is enabled - so we should b okay.",
      "parentUuid": "264558cc_407dfc1f",
      "revId": "0e7fb2f9e40213ddc37e5ee457399159eec8903a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "973e763b_1b11dc52",
        "filename": "ui/gl/gl_surface_egl.cc",
        "patchSetId": 4
      },
      "lineNbr": 1060,
      "author": {
        "id": 1187745
      },
      "writtenOn": "2017-10-13T16:59:38Z",
      "side": 1,
      "message": "I think I was getting \"stack corruption detected\" crashes in http://crbug.com/769415#c8 even without actively tracing, but that may have been a separate issue.\n\nSimilar question to above - if this is triggered via command buffer channel, this may not be the right place for a CHECK if we expect other code to handle sanity checks, and if a compromised Renderer is running this in-process I\u0027m not sure what we\u0027re protecting against, if it can run arbitrary code it could just corrupt its own stack anyway.",
      "parentUuid": "2fec1f48_591b52cd",
      "revId": "0e7fb2f9e40213ddc37e5ee457399159eec8903a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b04da271_36527a21",
        "filename": "ui/gl/gl_surface_egl.cc",
        "patchSetId": 4
      },
      "lineNbr": 1060,
      "author": {
        "id": 1002151
      },
      "writtenOn": "2017-10-13T19:44:17Z",
      "side": 1,
      "message": "Hmm. I wonder if the g_trace_swap_enabled.Get().value check isn\u0027t earlying out like I intended to. I\u0027ll double check.\n\nRegarding where to put the sanity check. I\u0027m not sure where to do that at a higher level given that it\u0027s apparently legal for Initialize to be called more than once. The clear()\u0027s added earlier in this file should effectively 1) prevent a CHECK here from ever being hit and 2) make the std::min a no-op. However, that doesn\u0027t protect against future regressions.\n\nI worry about just relying on the DCHECK because all the bugs reported were of the stack crash itself on Release builds. None were reported of the DCHECK being hit.",
      "parentUuid": "973e763b_1b11dc52",
      "revId": "0e7fb2f9e40213ddc37e5ee457399159eec8903a",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}
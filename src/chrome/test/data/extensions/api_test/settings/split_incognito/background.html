<script>
var settings = chrome.experimental.settings;
var assertEq = chrome.test.assertEq;
var inIncognitoContext = chrome.extension.inIncognitoContext;

// Returns a function that asserts a result is expected then runs a callback.
function assertResultEq(expected, callback) {
  return function(actual) {
    chrome.test.assertEq(expected, actual);
    callback();
  };
}

// All notifications received.
var notifications = [];
settings.onChanged.addListener(function(changes) {
  changes.forEach(function(change) {
    notifications.push(change);
  });
});

// The test from C++ runs "actions", where each action is defined here.
// This allows the test to be tightly controlled between incognito and
// non-incognito modes.
// Each function accepts a callback which should be run when the settings
// operation fully completes.
var testActions = {
  noop: function(callback) {
    settings.get("", callback);
  },
  assertEmpty: function(callback) {
    settings.get(null, assertResultEq({}, callback));
  },
  assertFoo: function(callback) {
    settings.get(null, assertResultEq({foo: "bar"}, callback));
  },
  setFoo: function(callback) {
    settings.set({foo: "bar"}, assertResultEq({foo: "bar"}, callback));
  },
  removeFoo: function(callback) {
    settings.remove("foo", assertResultEq(undefined, callback));
  },
  clear: function(callback) {
    settings.clear(assertResultEq(undefined, callback));
  },
  assertNoNotifications: function(callback) {
    assertEq([], notifications);
    callback();
  },
  clearNotifications: function(callback) {
    notifications = [];
    callback();
  },
  assertAddFooNotification: function(callback) {
    assertEq(1, notifications.length);
    assertEq("foo", notifications[0].key);
    assertEq(undefined, notifications[0].oldValue);
    assertEq("bar", notifications[0].newValue);
    callback();
  },
  assertDeleteFooNotification: function(callback) {
    assertEq(1, notifications.length);
    assertEq("foo", notifications[0].key);
    assertEq("bar", notifications[0].oldValue);
    assertEq(undefined, notifications[0].newValue);
    callback();
  }
};

// The only test we run.  Runs "actions" (as defined above) until told
// to stop (when the message has isFinalAction set to true).
function testEverything() {
  function next() {
    var waiting = inIncognitoContext ? "waiting_incognito" : "waiting";
    chrome.test.sendMessage(waiting, function(messageJson) {
      var message = JSON.parse(messageJson);
      var action = testActions[message.action];
      action(message.isFinalAction ? chrome.test.succeed : next);
    });
  }
  next();
}

chrome.test.runTests([testEverything]);
</script>

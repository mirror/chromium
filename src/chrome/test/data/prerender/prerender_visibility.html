<html>
<!-- 
This test checks the visibility API when a prerendered page is displayed.
-->
<head>
<title>Prerender Visibility</title>

<script>
// Checks visibility state while the page is still loading.
var loadingStatePassed = document.webkitHidden &&
                         document.webkitVisibilityState == 'prerender';

// True if any visibility change event has occurred.
var visibilityChangeCalled = false;

// True if the last visibility change event set the document's state to visible.
var visibilityChangePassed = false;

// Checks that no visibility change events have occurred, current visibility
// state is "prerender", and visibility state while the page was loading was
// also "prerender".
function DidPrerenderPass() {
  return !visibilityChangeCalled &&
         loadingStatePassed &&
         document.webkitHidden &&
         'prerender' == document.webkitVisibilityState;
}

function onVisibilityChange(event) {
  // TODO(mmenke):  Currently, we get 4 events when a page is shown -
  //                hidden -> visible -> hidden -> visible.
  //                Once that's fixed, add check to make sure we only have
  //                hidden -> visible, or just visible.
  visibilityChangePassed =
      !document.webkitHidden &&
      'visible' == document.webkitVisibilityState;
  visibilityChangeCalled = true;
}

document.addEventListener("webkitvisibilitychange",
                          onVisibilityChange,
                          false);

// Checks that the last visibility change resulted in a visible state, and that
// the current state is also visible.
function DidDisplayPass() {
  return visibilityChangeCalled &&
         visibilityChangePassed &&
         !document.webkitHidden &&
         'visible' == document.webkitVisibilityState;
}
</script>

</head>
<body></body>
</html>

{
  "comments": [
    {
      "key": {
        "uuid": "3f900700_664fbac4",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 64,
      "author": {
        "id": 1209769
      },
      "writtenOn": "2017-08-09T18:18:36Z",
      "side": 1,
      "message": "I\u0027m probably missing something. Did Eli requested for this value to be increased?",
      "range": {
        "startLine": 64,
        "startChar": 59,
        "endLine": 64,
        "endChar": 61
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ef7f1fe0_0825a586",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 64,
      "author": {
        "id": 1227839
      },
      "writtenOn": "2017-08-10T18:25:20Z",
      "side": 1,
      "message": "In https://crbug.com/737743#c60, Eli confirmed that we should change this value to 10.",
      "parentUuid": "3f900700_664fbac4",
      "range": {
        "startLine": 64,
        "startChar": 59,
        "endLine": 64,
        "endChar": 61
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "46bf6735_14ec1d27",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 88,
      "author": {
        "id": 1209769
      },
      "writtenOn": "2017-08-09T18:18:36Z",
      "side": 1,
      "message": "I think this condition can indirectly lead to NullPointerException.\n\n1. User is signed in.\n2. BookmarkPromoHeader is created, but shouldShowPromo returns false.\n3. mSigninPromoController is null.\n4. User is signed out (e.g., account is removed from device).\n5. setupSigninPromo throws NPE.\n\nThis is very unlikely, though. I think it can be easily solved by checking ChromeFeatureList.isEnabled(ChromeFeatureList.ANDROID_SIGNIN_PROMOS) here.",
      "range": {
        "startLine": 88,
        "startChar": 0,
        "endLine": 88,
        "endChar": 88
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "af8fb1ea_fe6f0647",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 88,
      "author": {
        "id": 1227839
      },
      "writtenOn": "2017-08-10T18:25:20Z",
      "side": 1,
      "message": "shouldShowPromo checks whether the Finch flag is enabled and returns false immediately if the signin promos are not enabled so this will not result in NPE. I\u0027ve tested this flow and it works fine. However, this strategy currently causes leaks for last impression. Changed if condition in destroy to address this.",
      "parentUuid": "46bf6735_14ec1d27",
      "range": {
        "startLine": 88,
        "startChar": 0,
        "endLine": 88,
        "endChar": 88
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8002c31b_1daf1310",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 108,
      "author": {
        "id": 1209769
      },
      "writtenOn": "2017-08-09T18:18:36Z",
      "side": 1,
      "message": "Is it possible to avoid this duplication? You already get a list of accounts and call setAccountName in setupSigninPromo. Can we record impressions there as well (you would need boolean flag for this, but it shouldn\u0027t be an issue).",
      "range": {
        "startLine": 106,
        "startChar": 0,
        "endLine": 108,
        "endChar": 74
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c79cad07_fce96652",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 108,
      "author": {
        "id": 1227839
      },
      "writtenOn": "2017-08-10T18:25:20Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8002c31b_1daf1310",
      "range": {
        "startLine": 106,
        "startChar": 0,
        "endLine": 108,
        "endChar": 74
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7c7dc949_60eecf85",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 128,
      "author": {
        "id": 1209769
      },
      "writtenOn": "2017-08-09T18:18:36Z",
      "side": 1,
      "message": "This condition can cause leaks.\n\n1. User is signed out.\n2. BookmarkPromoHeader is created, but shouldShowPromo returns true.\n3. Observers added to AccountManagerFacade and ProfileDataCache.\n4. User clicks \u0027Continue as\u0027 and signs in.\n5. Bookmarks activity will become active again as soon as AccountSigninActivity is finished.\n6. User closes Bookmark activity, BookmarkPromoHeader.destroy is invoked.\n7. shouldShowPromo returns false (user is signed in) and observers are not removed.\n8. BookmarkPromoHeader leaks along with activity.",
      "range": {
        "startLine": 128,
        "startChar": 0,
        "endLine": 128,
        "endChar": 88
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a7fa938b_7d7ffec8",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 128,
      "author": {
        "id": 1227839
      },
      "writtenOn": "2017-08-10T18:25:20Z",
      "side": 1,
      "message": "This indeed causes leaks. However, not due to the fact that the user is signed in. On the last impressions count (20), SigninPromoController.shouldShowPromo returned false, thus resulting in observers not being removed. Changing the condition to a null check for the SigninPromoController resolved this issue.",
      "parentUuid": "7c7dc949_60eecf85",
      "range": {
        "startLine": 128,
        "startChar": 0,
        "endLine": 128,
        "endChar": 88
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "611d0445_34147c1e",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 152,
      "author": {
        "id": 1209769
      },
      "writtenOn": "2017-08-09T18:18:36Z",
      "side": 1,
      "message": "I think there\u0027s a minuscule chance of getting ClassCastException:\n1. User is signed in, but sync is turned off.\n2. createHolder is invoked and it creates SigninAndSyncView.\n3. User is signed out (e.g., because account was removed from device).\n4. bindHolder is invoked.\n5. shouldShowNewSigninPromo returns true (user is signed out).\n6. Line 150 attempts to cast SigninAndSyncView to SigninPromoView.\n\nThis is extremelly unlikely, but using instanceof could probably help here. Since it\u0027s all confined inside BookmarkPromoHeader, it should be fine. Other option is to create two subclasses of ViewHolder.",
      "range": {
        "startLine": 149,
        "startChar": 0,
        "endLine": 152,
        "endChar": 9
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "693ddbf8_46f20b99",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 152,
      "author": {
        "id": 1227839
      },
      "writtenOn": "2017-08-10T18:25:20Z",
      "side": 1,
      "message": "Your rationale is right and I am going to change the if condition to \"instanceof\". However, I found something weird. I did test this flow before posting the CL and no ClassCastException was being thrown. After investigating a bit why shouldShowNewSigninPromo() returned false in this flow, I realized that this was due to the implementation of SignInStateObserver. I changed updateShouldShow(boolean) and added a ViewSwitcher in order to easily change between Views in such cases",
      "parentUuid": "611d0445_34147c1e",
      "range": {
        "startLine": 149,
        "startChar": 0,
        "endLine": 152,
        "endChar": 9
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c94c973e_59c67b9c",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 275,
      "author": {
        "id": 1209769
      },
      "writtenOn": "2017-08-09T18:18:36Z",
      "side": 1,
      "message": "Could you please extract this condition into a separate function (I\u0027m not sure about the name, but something like calculateShouldShow should work). This way you could clarify this condition a bit:\n\nprivate boolean calculateShouldShow() {\n    if (!AndroidSyncSettings.isMasterSyncEnabled(mContext)) return false;\n\n    // ...\n}",
      "range": {
        "startLine": 257,
        "startChar": 0,
        "endLine": 275,
        "endChar": 9
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "62365bf6_51668748",
        "filename": "chrome/android/java/src/org/chromium/chrome/browser/bookmarks/BookmarkPromoHeader.java",
        "patchSetId": 11
      },
      "lineNbr": 275,
      "author": {
        "id": 1227839
      },
      "writtenOn": "2017-08-10T18:25:20Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "c94c973e_59c67b9c",
      "range": {
        "startLine": 257,
        "startChar": 0,
        "endLine": 275,
        "endChar": 9
      },
      "revId": "67b1f45fe80ec1663534f2e15097b8cbd52a50d8",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}